<!DOCTYPE html>
<html lang="fr">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Shell shock : un obus dans les dents de bash — Blog bloquant</title>
    <!--[if lte IE 8]><script type="text/javascript" src="https://www.dericbourg.net/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/skeleton.css" />
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/theme.css" />
    <link rel="shortcut icon" type="image/png" href="https://www.dericbourg.net/favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="https://www.dericbourg.net/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="Blog bloquant — Flux Atom"
                           href="https://www.dericbourg.net/" /> 

    <meta name="author"   content="Alban Dericbourg" />
    <meta name="keywords" content="bash, sécurité, cve" />
    <link rel="stylesheet" media="not print" type="text/css" href="https://www.dericbourg.net/theme/css/pygments.css" /> 
  </head>
  <body>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="https://www.dericbourg.net/index.html">Blog bloquant</a>
        </h1>
      </header>
      
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="https://www.dericbourg.net/2014/09/26/shell-shock-un-obus-dans-les-dents-de-bash/"
             title="Lien permanent vers «Shell shock : un obus dans les dents de bash»">
             Shell shock : un obus dans les dents de bash
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Le <time datetime="2014-09-26T00:00:00+02:00">Fri 26 September 2014</time>
            dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a>              <br />Mots-clés:              <a rel="tag" href="https://www.dericbourg.net/tag/bash.html">bash</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/securite.html">sécurité</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/cve.html">cve</a>        </div>
      </header>
      <div class="post-content"> 
        <p>Vous avez probablement entendu parler de Shell shock qui, outre l'association de troubles psychiques et physiques observés chez <a href="http://fr.wikipedia.org/wiki/Obusite">certains soldats de la Première Guerre Mondiale</a>, désigne également la vulnérabilité <a href="http://www.cert.ssi.gouv.fr/site/CERTFR-2014-ALE-006/index.html">CVE-2014-6271</a> touchant GNU bash. Elle permet à un attaquant de provoquer une exécution de code arbitraire à distance.</p>
<h2>Mon dieu, mais c'est horrible !</h2>
<p>Il faut avouer que ça ne présage pas d'une franche partie de rigolade.</p>
<p>Tout d'abord, de nombreux programmes interagissent avec le shell. Nous savons que ce n'est généralement pas une bonne idée mais cela nous simplifie parfois grandement la tâche (on dit souvent qu'un bon développeur est un développeur fainéant). La surface d'attaque est donc très étendue.</p>
<p>Par ailleurs, si les systèmes « évidents » seront patchés (un serveur web par exemple), certaines machines plus obscures ne le seront pas : pensez par exemple à des périphériques tels que les caméras connectées (ou plus largement tout ce que vous pouvez trouver sur l'Internet des objets). Rien n'exclut qu'elles exposent des services basés sur des scripts shell et si ce shell est bash, le périphérique devient vulnérable. Comme il y a fort à parier qu'aucune procédure de mise à jour de ces périphériques n'ait été définie, ces périphérques resteront vulnérables ad vitam aeternam.</p>
<h2>J'exige des explications</h2>
<p>Bash permet d'exporter des variables mais aussi des fonctions à destination d'autres instances de bash. L'export de fonction utilise une variable d'environnement portant le nom de la-dite fonction dont la valeur commence par <code>() {</code> :</p>
<div class="highlight"><pre><span></span><code><span class="nv">foo</span><span class="o">=()</span> <span class="o">{</span>
    du code
<span class="o">}</span>
</code></pre></div>

<p>À l'import, il se contente aveuglément d'interpréter cela en remplaçant le signe « = » par une espace. C'est ainsi que bash ne se limite pas à interpréter le corps de la fonction mais qu'il poursuit le parsing et exécute les commandes qui suivent la définition de la fonction. Par exemple, définir une variable d'environnement de cette sorte :</p>
<div class="highlight"><pre><span></span><code><span class="nv">FOO</span><span class="o">=()</span> <span class="o">{</span> ignored<span class="p">;</span> <span class="o">}</span><span class="p">;</span> /bin/yolo
</code></pre></div>

<p>exécutera <code>/bin/yolo</code> quand l'environnement sera importé par bash.</p>
<p>Ainsi, tout système utilisant bash est vulnérable, mais il est particulièrement vulnérable :</p>
<ul>
<li>s'il expose un service sur le réseau (a fortiori sur Internet) ;</li>
<li>que ce service exploite des paramètres passés par le client et qu'il les stocke dans une variable d'environnement ;</li>
<li>et que ce service lance bash pour un traitement quelconque.</li>
</ul>
<p>Pour savoir si votre machine est vulnérable, vous pouvez lancer :</p>
<div class="highlight"><pre><span></span><code>env <span class="nv">VAR</span><span class="o">=</span><span class="s1">&#39;() { 0; }; echo danger&#39;</span> bash -c <span class="s2">&quot;echo bonjour&quot;</span>
</code></pre></div>

<p>Si tout va bien, vous devriez observer ceci :</p>
<div class="highlight"><pre><span></span><code>$ env <span class="nv">VAR</span><span class="o">=</span><span class="s1">&#39;() { 0; }; echo danger&#39;</span> bash -c <span class="s2">&quot;echo bonjour&quot;</span>
bash: warning: VAR: ignoring <span class="k">function</span> definition attempt
bash: error importing <span class="k">function</span> definition <span class="k">for</span> <span class="sb">`</span>VAR<span class="err">&#39;</span>
bonjour
</code></pre></div>

<p>Si tout ne va pas bien, vous observerez :</p>
<div class="highlight"><pre><span></span><code>$ env <span class="nv">VAR</span><span class="o">=</span><span class="s1">&#39;() { 0; }; echo danger&#39;</span> bash -c <span class="s2">&quot;echo bonjour&quot;</span>
danger
bonjour
</code></pre></div>

<p>À noter que Linux n'est pas le seul système touché. Tous les systèmes Unix (ce qui inclut Mac OS) sont concernés.</p>
<h2>M'enfin, qui serait assez bête pour exposer un machin bash sur Internet ?</h2>
<p>Moi – et probablement vous aussi – mais je ne pense pas que ce soit de la bêtise.</p>
<p>Pour l'instant, le vecteur de propagation semble être la requête HTTP à destination d'un script CGI. Le serveur web <em>Apache httpd</em> utilise par exemple des scripts (donc potentiellement bash) pour certaines fonctions C, Python ou PHP (si ce dernier est lancé en mode CGI). C'est ainsi que quelques robots parcourent en ce moment même le web en positionnant leur en-tête <em>User-Agent</em> comme suit afin de dresser leur annuaire des machines vulnérables : <code>User-Agent: () { :; } /bin/ping -c x.y.z.q</code>. Si vous souhaitez vérifier vos logs HTTP, vous pouvez lancer <code>egrep '\(\ *\)\ *\{' /var/log/nginx/*</code> par exemple.</p>
<p>Ce n'est donc pas si rare et c'est sans compter les applications largement déployées qui utilisent CGI (cPanel par exemple).</p>
<p>Enfin – et plus localement, certains clients DHCP utilisent également des scripts pour configurer le système. Si le serveur est corrompu (ou mal intentionné), cela permet d'exécuter des commandes – vraisemblablement en <em>root</em> – sur la machine cliente.
Il ne peut plus rien nous arriver d'affreux maintenant</p>
<p>Une fois le patch passé, vous devriez déjà être plus sereins. Néanmoins, <a href="https://securityblog.redhat.com/2014/09/24/bash-specially-crafted-environment-variables-code-injection-attack/">comme l'indique RedHat</a>, le patch fourni laisse quelques trous dans la raquette. Il est notamment possible, sous certaines conditions, d'exécuter du code contenu dans des variables d'environnement (CVE-2014-7169). Reste à attendre le patch du patch.</p>
<p>Pour tester votre vulnérabilité à <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7169">CVE-2014-7169</a>, vous pouvez lancer :</p>
<div class="highlight"><pre><span></span><code>env <span class="nv">X</span><span class="o">=</span><span class="s1">&#39;() { (a)=&gt;\&#39;</span> sh -c <span class="s2">&quot;echo date&quot;</span><span class="p">;</span> cat <span class="nb">echo</span>
</code></pre></div>

<p>Si vous obtenez la date, votre système est vulnérable.</p>
<p>À suivre, donc.</p>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posté dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a><br />
            Mots-clés:  #<a href="https://www.dericbourg.net/tag/bash.html">bash</a> #<a href="https://www.dericbourg.net/tag/securite.html">sécurité</a> #<a href="https://www.dericbourg.net/tag/cve.html">cve</a>        </div>
      </footer>
      <hr />
      <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dericbourg'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </article> <!-- /#page-main -->

        <aside id="page-side">
          <!-- begin includes/sidebar.html -->
          <nav>
            <h3>Liens</h3>
            <ul>
              <li><a href="https://github.com/adericbourg">GitHub</a></li>
              <li><a href="https://www.linkedin.com/in/adericbourg/">LinkedIn</a></li>
              <li><a href="https://twitter.com/adericbourg">Twitter</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
      </footer>
    </div> <!-- /#page -->
  </body>
</html>