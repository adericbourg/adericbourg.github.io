<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>Blog bloquant</title>
		<meta name="description" content="">
		<meta name="author" content="Alban Dericbourg">

		<link rel="stylesheet" href="http://www.dericbourg.net/theme/css/foundation.css" />
		<link rel="stylesheet" href="http://www.dericbourg.net/theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="http://www.dericbourg.net/theme/css/custom.css" />


		<script src="http://www.dericbourg.net/theme/js/modernizr.js"></script>

		<!-- Feeds -->
		<link href="http://www.dericbourg.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blog bloquant Atom Feed" />


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
			tex2jax: {
				inlineMath: [ ['$', '$'] ],
				displayMath: [ ['$$', '$$']],
				processEscapes: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
			},
			messageStyle: "none",
			"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
		});
		</script>
		<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">Blog&nbsp;bloquant</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
						<li><a href="http://www.dericbourg.net">Home</a></li>
						<li><label>Categories</label></li>
							<li class="active"><a href="http://www.dericbourg.net/category/blog.html">Blog</a></li>

						<li><label>Links</label></li>
							<li><a href="https://github.com/adericbourg/CV">Mon CV</a></li>



						<li><label>Social</label></li>
							<li><a href="https://github.xom/adericbourg">GitHub</a></li>
							<li><a href="https://www.linkedin.com/in/adericbourg">LinkedIn</a></li>
							<li><a href="https://twitter.com/adericbourg">Twitter</a></li>
					</ul>	
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="http://www.dericbourg.net/">Blog bloquant</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li class="active"><a href="http://www.dericbourg.net/category/blog.html">Blog</a></li>
						</ul>
                        <ul class="right">                                                                                                                                           
                                                                                                                                             
                        </ul>  
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>Shell shock : un obus dans les dents de bash</h2>
	<p>Vous avez probablement entendu parler de Shell shock qui, outre l'association de troubles psychiques et physiques observés chez <a href="http://fr.wikipedia.org/wiki/Obusite">certains soldats de la Première Guerre Mondiale</a>, désigne également la vulnérabilité <a href="http://www.cert.ssi.gouv.fr/site/CERTFR-2014-ALE-006/index.html">CVE-2014-6271</a> touchant GNU bash. Elle permet à un attaquant de provoquer une exécution de code arbitraire à distance.</p>
<h2>Mon dieu, mais c'est horrible !</h2>
<p>Il faut avouer que ça ne présage pas d'une franche partie de rigolade.</p>
<p>Tout d'abord, de nombreux programmes interagissent avec le shell. Nous savons que ce n'est généralement pas une bonne idée mais cela nous simplifie parfois grandement la tâche (on dit souvent qu'un bon développeur est un développeur fainéant). La surface d'attaque est donc très étendue.</p>
<p>Par ailleurs, si les systèmes « évidents » seront patchés (un serveur web par exemple), certaines machines plus obscures ne le seront pas : pensez par exemple à des périphériques tels que les caméras connectées (ou plus largement tout ce que vous pouvez trouver sur l'Internet des objets). Rien n'exclut qu'elles exposent des services basés sur des scripts shell et si ce shell est bash, le périphérique devient vulnérable. Comme il y a fort à parier qu'aucune procédure de mise à jour de ces périphériques n'ait été définie, ces périphérques resteront vulnérables ad vitam aeternam.</p>
<h2>J'exige des explications</h2>
<p>Bash permet d'exporter des variables mais aussi des fonctions à destination d'autres instances de bash. L'export de fonction utilise une variable d'environnement portant le nom de la-dite fonction dont la valeur commence par <code>() {</code> :</p>
<div class="highlight"><pre><span class="nv">foo</span><span class="o">=()</span> <span class="o">{</span>
    du code
<span class="o">}</span>
</pre></div>


<p>À l'import, il se contente aveuglément d'interpréter cela en remplaçant le signe « = » par une espace. C'est ainsi que bash ne se limite pas à interpréter le corps de la fonction mais qu'il poursuit le parsing et exécute les commandes qui suivent la définition de la fonction. Par exemple, définir une variable d'environnement de cette sorte :</p>
<div class="highlight"><pre><span class="nv">FOO</span><span class="o">=()</span> <span class="o">{</span> ignored<span class="p">;</span> <span class="o">}</span><span class="p">;</span> /bin/yolo
</pre></div>


<p>exécutera <code>/bin/yolo</code> quand l'environnement sera importé par bash.</p>
<p>Ainsi, tout système utilisant bash est vulnérable, mais il est particulièrement vulnérable :</p>
<ul>
<li>s'il expose un service sur le réseau (a fortiori sur Internet) ;</li>
<li>que ce service exploite des paramètres passés par le client et qu'il les stocke dans une variable d'environnement ;</li>
<li>et que ce service lance bash pour un traitement quelconque.</li>
</ul>
<p>Pour savoir si votre machine est vulnérable, vous pouvez lancer :</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">VAR</span><span class="o">=</span><span class="s1">&#39;() { 0; }; echo danger&#39;</span> bash -c <span class="s2">&quot;echo bonjour&quot;</span>

Si tout va bien, vous devriez observer ceci :

<span class="sb">```</span>bash
<span class="nv">$ </span>env <span class="nv">VAR</span><span class="o">=</span><span class="s1">&#39;() { 0; }; echo danger&#39;</span> bash -c <span class="s2">&quot;echo bonjour&quot;</span>
bash: warning: VAR: ignoring <span class="k">function</span> definition attempt
bash: error importing <span class="k">function</span> definition <span class="k">for</span> <span class="sb">`</span>VAR<span class="err">&#39;</span>
bonjour
</pre></div>


<p>Si tout ne va pas bien, vous observerez :</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">VAR</span><span class="o">=</span><span class="s1">&#39;() { 0; }; echo danger&#39;</span> bash -c <span class="s2">&quot;echo bonjour&quot;</span>
danger
bonjour
</pre></div>


<p>À noter que Linux n'est pas le seul système touché. Tous les systèmes Unix (ce qui inclut Mac OS) sont concernés.</p>
<h2>M'enfin, qui serait assez bête pour exposer un machin bash sur Internet ?</h2>
<p>Moi – et probablement vous aussi – mais je ne pense pas que ce soit de la bêtise.</p>
<p>Pour l'instant, le vecteur de propagation semble être la requête HTTP à destination d'un script CGI. Le serveur web <em>Apache httpd</em> utilise par exemple des scripts (donc potentiellement bash) pour certaines fonctions C, Python ou PHP (si ce dernier est lancé en mode CGI). C'est ainsi que quelques robots parcourent en ce moment même le web en positionnant leur en-tête <em>User-Agent</em> comme suit afin de dresser leur annuaire des machines vulnérables : <code>User-Agent: () { :; } /bin/ping -c x.y.z.q</code>. Si vous souhaitez vérifier vos logs HTTP, vous pouvez lancer <code>egrep '\(\ *\)\ *\{' /var/log/nginx/*</code> par exemple.</p>
<p>Ce n'est donc pas si rare et c'est sans compter les applications largement déployées qui utilisent CGI (cPanel par exemple).</p>
<p>Enfin – et plus localement, certains clients DHCP utilisent également des scripts pour configurer le système. Si le serveur est corrompu (ou mal intentionné), cela permet d'exécuter des commandes – vraisemblablement en <em>root</em> – sur la machine cliente.
Il ne peut plus rien nous arriver d'affreux maintenant</p>
<p>Une fois le patch passé, vous devriez déjà être plus sereins. Néanmoins, <a href="https://securityblog.redhat.com/2014/09/24/bash-specially-crafted-environment-variables-code-injection-attack/">comme l'indique RedHat</a>, le patch fourni laisse quelques trous dans la raquette. Il est notamment possible, sous certaines conditions, d'exécuter du code contenu dans des variables d'environnement (CVE-2014-7169). Reste à attendre le patch du patch.</p>
<p>Pour tester votre vulnérabilité à <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7169">CVE-2014-7169</a>, vous pouvez lancer :</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">X</span><span class="o">=</span><span class="s1">&#39;() { (a)=&gt;\&#39;</span> sh -c <span class="s2">&quot;echo date&quot;</span><span class="p">;</span> cat <span class="nb">echo</span>
</pre></div>


<p>Si vous obtenez la date, votre système est vulnérable.</p>
<p>À suivre, donc.</p>
	<hr/>
	<h6>Written by <a href="http://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a> in <a href="http://www.dericbourg.net/category/blog.html">Blog</a> on ven. 26 septembre 2014. Tags: <a href="http://www.dericbourg.net/tag/bash.html">bash</a>, <a href="http://www.dericbourg.net/tag/securite.html">sécurité</a>, <a href="http://www.dericbourg.net/tag/cve.html">cve</a>, </h6>
</article>

<hr/>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Links</h5>
								<ul class="side-nav">
									<li><a href="https://github.com/adericbourg/CV">Mon CV</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
									<li><a href="/tag/motivation.html" class="tag-4">motivation</a></li>
									<li><a href="/tag/vivre-ensemble.html" class="tag-4">vivre ensemble</a></li>
									<li><a href="/tag/quotidien.html" class="tag-4">quotidien</a></li>
									<li><a href="/tag/bien-être.html" class="tag-4">bien-être</a></li>
									<li><a href="/tag/bash.html" class="tag-4">bash</a></li>
									<li><a href="/tag/cve.html" class="tag-4">cve</a></li>
									<li><a href="/tag/sécurité.html" class="tag-4">sécurité</a></li>
								</ul>
							</div>


							<div class="panel">
								<h5>Social</h5>
								<ul class="side-nav">
									<li><a href="https://github.xom/adericbourg">GitHub</a></li>
									<li><a href="https://www.linkedin.com/in/adericbourg">LinkedIn</a></li>
									<li><a href="https://twitter.com/adericbourg">Twitter</a></li>
								</ul>
							</div>
						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="http://www.dericbourg.net/theme/js/jquery.js"></script>
		<script src="http://www.dericbourg.net/theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>