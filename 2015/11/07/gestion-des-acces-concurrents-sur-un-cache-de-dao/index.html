<!DOCTYPE html>
<html lang="fr">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Gestion des accès concurrents sur un cache de DAO — Blog bloquant</title>
    <!--[if lte IE 8]><script type="text/javascript" src="https://www.dericbourg.net/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/skeleton.css" />
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/theme.css" />
    <link rel="shortcut icon" type="image/png" href="https://www.dericbourg.net/favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="https://www.dericbourg.net/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="Blog bloquant — Flux Atom"
                           href="https://www.dericbourg.net/" /> 

    <meta name="author"   content="Alban Dericbourg" />
    <meta name="keywords" content="java, guava, cache, dao, verrou, concurrence" />
    <link rel="stylesheet" media="not print" type="text/css" href="https://www.dericbourg.net/theme/css/pygments.css" /> 
  </head>
  <body>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="https://www.dericbourg.net/index.html">Blog bloquant</a>
        </h1>
      </header>
      
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="https://www.dericbourg.net/2015/11/07/gestion-des-acces-concurrents-sur-un-cache-de-dao/"
             title="Lien permanent vers «Gestion des accès concurrents sur un cache de DAO»">
             Gestion des accès concurrents sur un cache de DAO
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Le <time datetime="2015-11-07T00:00:00+01:00">Sat 07 November 2015</time>
            dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a>              <br />Mots-clés:              <a rel="tag" href="https://www.dericbourg.net/tag/java.html">java</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/guava.html">guava</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/cache.html">cache</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/dao.html">dao</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/verrou.html">verrou</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/concurrence.html">concurrence</a>        </div>
      </header>
      <div class="post-content"> 
        <p>L'ajout d'un cache sur un DAO est une opération courante et la bibliothèque Guava, très répandue, a par ailleurs énormément simplifié sa mise en œuvre. Néanmoins, il reste encore extrêmement facile de se tromper avec cette bibliothèque et... de réaliser un cache qui ne fonctionne pas.</p>
<h2>Contexte</h2>
<p>Partons d'une interface de DAO « classique » permettant de réaliser les opérations <em>CRUD</em>. On y ajoute une méthode <code>getAll</code> qui retourne l'intégralité des objets (vous allez voir, c'est pour votre bien).</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Dao</span> <span class="p">{</span>
  <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">get</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">);</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">save</span><span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p>Sans accorder d'importance à l'implémentation du DAO accédant effectivement aux données persistées, contentons-nous de supposer que ses performances ne sont pas suffisantes pour répondre aux sollicitations auxquelles est soumise notre application.</p>
<h2>Cache des données</h2>
<p>On se propose d'utiliser <a href="https://github.com/google/guava">Guava</a> pour implémenter ce cache. On utilise dans cet exemple un <a href="https://github.com/google/guava/wiki/CachesExplained"><code>LoadingCache</code></a> qui ira chercher en base la donnée s'il n'a pas déjà été sollicité pour celle-ci : on charge les valeurs une à une à la demande. Il permet également de rafraîchir les données automatiquement à intervalle régulier.</p>
<p>L'encapsulation des données de cache dans des <code>Optional</code> est un parti pris. Deux choix étaient possibles :</p>
<ul>
<li>on peut choisir d'ignorer les valeurs inexistantes, auquel cas, si celles-ci sont demandées plusieurs fois, ce sont autant d'appels à la base qui seront faits ;</li>
<li>on peut également choisir de placer une sentinelle dans le cache (en l'occurrence, l'instance « absente » d'<code>Optional</code>).</li>
</ul>
<p>Les deux approches ont leur avantages et leurs inconvénients et leur utilisation dépend de votre application et de vos besoins.</p>
<div class="highlight"><pre><span></span><code><span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">MyObject</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">CacheBuilder</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">load</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dbDao</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
</code></pre></div>


<h2>Implémentation naïve (et fausse)</h2>
<p>En première approche, on peut supposer qu'il « suffit » de mettre à jour le cache pour chaque opération d'écriture sur la base de données. Une implémentation dans cette optique ressemblerait à ceci.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachedDao</span> <span class="kd">implements</span> <span class="n">Dao</span> <span class="p">{</span>

  <span class="c1">// DAO accédant aux données persistées.</span>
  <span class="c1">// Dans la vraie vie, vous l&#39;auriez injecté, hein ?</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">DbDao</span> <span class="n">dbDao</span><span class="p">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">MyObject</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">createCache</span><span class="p">();</span>

  <span class="kd">public</span> <span class="nf">CachedDao</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">dbDao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DbDao</span><span class="p">();</span>
    <span class="c1">// Initialisation du cache : nécessaire pour utiliser le cache sur getAll.</span>
    <span class="n">initCache</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">get</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">cache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">cache</span><span class="p">.</span><span class="na">asMap</span><span class="p">()</span>
                <span class="p">.</span><span class="na">values</span><span class="p">()</span>
                <span class="p">.</span><span class="na">stream</span><span class="p">()</span>
                <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dbDao</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">myObject</span><span class="p">);</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">refresh</span><span class="p">(</span><span class="n">myObject</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dbDao</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">refresh</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Vidage intégral du cache puis rechargement.</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">invalidateAll</span><span class="p">();</span>
    <span class="n">initCache</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initCache</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span> <span class="p">:</span> <span class="n">dbDao</span><span class="p">.</span><span class="na">getAll</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">cache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">myObject</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">myObject</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Pourquoi cette implémentation ne fonctionne pas ?</p>
<p>Dans le cas de multiples appels concurrents, des interruptions peuvent avoir lieu à tout moment. L'appel à <code>delete</code> peut être interrompu entre la mise à jour de la base (<code>dbDao.delete(id)</code>) et le rafraîchissement du cache (<code>cache.refresh(id)</code>). Si cette interruption se fait à la faveur d'une lecture (<code>get</code>), cette dernière se fera sur un cache qui n'est pas encore mise à jour et donc renverra une donnée « périmée ». Rien ne dit qu'il est impératif de récupérer la dernière version de la donnée : suivant votre application, cela peut être acceptable.</p>
<p>Mais alors, pire : supposons qu'un appel à <code>getAll</code> provoque une interruption pendant un rafraîchissement du cache, au milieu de la boucle de rechargement de la méthode <code>initCache</code>. On retourne alors une version incohérente (partielle) des données. Cette situation n'est, elle, pas acceptable.</p>
<h2>Le problème des lecteurs et des rédacteurs</h2>
<p>Le cas de figure dans lequel nous nous trouvons correspond à un problème bien connu formulé par Edsger Dijkstra pour modéliser... les accès aux bases de données. Ceux-ci sont soumis à deux contraintes :</p>
<ul>
<li>plusieurs lecteurs doivent pouvoir lire dans la base simultanément ;</li>
<li>si un rédacteur est en train de modifier la base de données, aucun autre utilisateur (qu'il soit lecteur ou rédacteur) ne doit pouvoir y accéder.</li>
</ul>
<p>Une solution simple revient à attendre, lorsqu'un rédacteur se présente, d'attendre que tous les lecteurs soient partis et de bloquer l'entrée à tout nouvel utilisateur. En utilisant un sémaphore (<code>db</code>) et un compteur (<code>rc</code>), cela reviendrait à :</p>
<ol>
<li>Le premier lecteur à entrer acquiert le sémaphore <code>db</code>.</li>
<li>Tous les lecteurs entrant incrémentent le compteur <code>rc</code>.</li>
<li>En sortant, ils décrémentent ce compteur.</li>
<li>Le dernier lecteur à sortir débloque le sémaphore <code>db</code> et autorise alors un rédacteur en attente, s'il y en a un, à entrer.</li>
</ol>
<p>Sur notre exemple de DAO, la modification se ferait de la sorte (ce qui n'est pas explicitement redéfini n'a pas changé) :</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachedDao</span> <span class="kd">implements</span> <span class="n">Dao</span> <span class="p">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Semaphore</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">concurrentAccess</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">get</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">concurrentAccess</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Premier lecteur à entrer</span>
      <span class="n">lock</span><span class="p">.</span><span class="na">acquire</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="na">getIfPresent</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">concurrentAccess</span><span class="p">.</span><span class="na">decrementAndGet</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Dernier lecteur à sortir</span>
      <span class="n">lock</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">returnValue</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
    <span class="c1">// Attente que le dernier utilisateur sorte</span>
    <span class="n">lock</span><span class="p">.</span><span class="na">acquire</span><span class="p">();</span>

    <span class="n">dbDao</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">myObject</span><span class="p">);</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">refresh</span><span class="p">(</span><span class="n">myObject</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>

    <span class="c1">// Libération pour qu&#39;un utilisateur puisse revenir</span>
    <span class="n">lock</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
    <span class="c1">// Idem.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Mais s'il rentre un lecteur toutes les deux millisecondes et qu'il faut cinq millisecondes à chaque lecteur pour terminer sa consultation, il y aura toujours des lecteurs présents et le rédacteur ne pourra jamais entrer.</p>
<p>Pour éviter cela, il faut que lorsqu'un rédacteur est en attente, tout lecteur qui se présente reste « derrière » le rédacteur et attende qu'il ait terminé.</p>
<p>En Java, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html">la classe <code>ReentrantReadWriteLock</code></a> permet de répondre à cette condition. Il encapsule deux types de verrous :</p>
<ul>
<li>un verrou en lecture que tous les lecteurs peuvent « passer » tant qu'aucun verrou en écriture n'a été posé ;</li>
<li>un verrou en écriture que tous les rédacteurs peuvent « passer » tant qu'aucun verrou en lecture ou en écriture n'a été posé.</li>
</ul>
<p>Exemple en lecture :</p>
<div class="highlight"><pre><span></span><code><span class="n">ReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantReadWriteLock</span><span class="p">();</span>

<span class="n">readWriteLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>

  <span class="c1">// Cette section est accessible par plusieurs lecteurs simultanément</span>
  <span class="c1">// si aucun verrou en écriture n&#39;a été acquis.</span>

<span class="n">readWriteLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
</code></pre></div>


<p>Exemple en écriture :</p>
<div class="highlight"><pre><span></span><code><span class="n">ReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantReadWriteLock</span><span class="p">();</span>

<span class="n">readWriteLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>

  <span class="c1">// Cette section est accessible par un seul rédacteur à la fois</span>
  <span class="c1">// si aucun verrou n&#39;est acquis (en lecture ou en écriture).</span>

<span class="n">readWriteLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
</code></pre></div>


<h2>Implémentation « sûre »</h2>
<p>Nous pouvons réutiliser notre implémentation naïve : si elle n'était pas sûre, son intention restait valable. Pour l'adapter, on ajoute :</p>
<ul>
<li>des verrous en lecture sur les méthodes de lecture ;</li>
<li>des verrous en écriture sur les méthodes d'écriture ;</li>
<li>et... c'est tout.</li>
</ul>
<p>Il est en revanche nécessaire de « protéger » la libération des verrous. Si un traitement se passe mal — si par exemple si une exception est lancée — le verrou doit malgré tout être libéré. On encapsulera donc tout le code des sections critiques dans un bloc <code>try</code> / <code>finally</code>.</p>
<p>Le code n'ayant pas changé par rapport à la première version n'est pas représenté.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReadWriteLock</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachedDao</span> <span class="kd">implements</span> <span class="n">Dao</span> <span class="p">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ReadWriteLock</span> <span class="n">rwLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantReadWriteLock</span><span class="p">();</span>

  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">get</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">unsafeGet</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">cache</span><span class="p">.</span><span class="na">asMap</span><span class="p">()</span>
                  <span class="p">.</span><span class="na">values</span><span class="p">()</span>
                  <span class="p">.</span><span class="na">stream</span><span class="p">()</span>
                  <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span>
                  <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
                  <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">unsafeSave</span><span class="p">(</span><span class="n">myObject</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">unsafeDelete</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">unsafeRefresh</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="nf">unsafeGet</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="na">getIfPresent</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unsafeSave</span><span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dbDao</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">myObject</span><span class="p">);</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">refresh</span><span class="p">(</span><span class="n">myObject</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unsafeDelete</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dbDao</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">refresh</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unsafeRefresh</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Vidage intégral du cache puis rechargement.</span>
    <span class="n">cache</span><span class="p">.</span><span class="na">invalidateAll</span><span class="p">();</span>
    <span class="n">initCache</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initCache</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MyObject</span> <span class="n">myObject</span> <span class="p">:</span> <span class="n">dbDao</span><span class="p">.</span><span class="na">getAll</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">cache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">myObject</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">myObject</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h2>Pour aller plus loin</h2>
<p>Le DAO présenté ici est « sûr » dans la mesure où il garantit la cohérence avec la base des données retournées. En revanche, pour cela, un compromis sur les performances a du être fait. En effet, cette implémentation ne permet pas d'écritures simultanées : la modification de deux objets distincts n'est pas possible.</p>
<p>Peut-on faire mieux ? Si vous pensez que oui, quelle serait votre approche ?</p>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posté dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a><br />
            Mots-clés:  #<a href="https://www.dericbourg.net/tag/java.html">java</a> #<a href="https://www.dericbourg.net/tag/guava.html">guava</a> #<a href="https://www.dericbourg.net/tag/cache.html">cache</a> #<a href="https://www.dericbourg.net/tag/dao.html">dao</a> #<a href="https://www.dericbourg.net/tag/verrou.html">verrou</a> #<a href="https://www.dericbourg.net/tag/concurrence.html">concurrence</a>        </div>
      </footer>
      <hr />
      <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dericbourg'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </article> <!-- /#page-main -->

        <aside id="page-side">
          <!-- begin includes/sidebar.html -->
          <nav>
            <h3>Liens</h3>
            <ul>
              <li><a href="https://github.com/adericbourg">GitHub</a></li>
              <li><a href="https://www.linkedin.com/in/adericbourg/">LinkedIn</a></li>
              <li><a href="https://twitter.com/adericbourg">Twitter</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
      </footer>
    </div> <!-- /#page -->
  </body>
</html>