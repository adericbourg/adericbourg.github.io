<!DOCTYPE html>
<html lang="fr">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Problème des huit reines — Blog bloquant</title>
    <!--[if lte IE 8]><script type="text/javascript" src="https://www.dericbourg.net/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/skeleton.css" />
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/theme.css" />
    <link rel="shortcut icon" type="image/png" href="https://www.dericbourg.net/favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="https://www.dericbourg.net/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="Blog bloquant — Flux Atom"
                           href="https://www.dericbourg.net/" /> 

    <meta name="author"   content="Alban Dericbourg" />
    <meta name="keywords" content="algorithmique, python, jeu" />
    <link rel="stylesheet" media="not print" type="text/css" href="https://www.dericbourg.net/theme/css/pygments.css" /> 
  </head>
  <body>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="https://www.dericbourg.net/index.html">Blog bloquant</a>
        </h1>
      </header>
      
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="https://www.dericbourg.net/2015/08/11/probleme-des-huit-reines/"
             title="Lien permanent vers «Problème des huit reines»">
             Problème des huit reines
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Le <time datetime="2015-08-11T00:00:00+02:00">Tue 11 August 2015</time>
            dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a>              <br />Mots-clés:              <a rel="tag" href="https://www.dericbourg.net/tag/algorithmique.html">algorithmique</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/python.html">python</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/jeu.html">jeu</a>        </div>
      </header>
      <div class="post-content"> 
        <p>J'ai rencontré le <a href="https://fr.wikipedia.org/wiki/Probl%C3%A8me_des_huit_dames">problème des huits reines</a> lors d'un entretien d'embauche. Sans juger de la pertinence de cet exercice dans ce cadre (indépendamment du fait que j'aie lamentablement et honteusement échoué), la période estivale, propice à la détente, m'a incité à pousser le jeu plus en avant (mon orgueil a probablement contribué lui aussi).
Le problème consiste à compter et identifier les différentes façons de placer sur un échiquier de 64 cases 8 reines de façon à ce que, relativement aux règles des échecs, elles ne se menacent pas mutuellement. Une reine peut se déplacer de façon rectiligne d'un nombre de cases arbitraire dans toutes les directions ; lorsqu'une reine est placée, la ligne, la colonne et les diagonales sur lesquelles elle se situe sont donc « condamnées ».</p>
<h2>Modélisation</h2>
<p>On ne peut pas placer plusieurs reines sur une même ligne. On peut donc simplifier la modélisation en ne travaillant que sur les colonnes. Ainsi, on cherchera à ne retourner qu'un tableau d'index de colonne, chacun de ces index correspondant à la ligne de son propre index dans le tableau. Pour illustrer, on produira en retour un tableau de la forme <code>[x, y, z]</code> qui correspond en pratique aux coordonnées <code>(0, x)</code>, <code>(1, y)</code> et <code>(2, z)</code> sur l'échiquier.</p>
<p>Représentons cette modélisation dans le cas de la résolution du problème avec huit reines.</p>
<p><img alt="Représentation de la modélisation" class="center" src="/images/eight_queens/modelisation.png"></p>
<blockquote>
<p><strong>Note :</strong> en Python, la fonction <a href="https://docs.python.org/2/library/functions.html#enumerate"><code>enumerate</code></a> permet d'obtenir de façon immédiate ce résultat.</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">enumerate</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span>
<span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)]</span>
</code></pre></div>

</blockquote>
<p>Il est alors « facile » de déterminer si une reine est en sécurité connaissant la position des autres :</p>
<ul>
<li>Par construction, aucune reine ne peut être sur la même ligne.</li>
<li>Deux reines sont sur la même colonne lorsque leur index de colonne est la même (<code>c[i] == c[j]</code>).</li>
<li>Deux reines sont sur la même diagonale lorsque leur différence d'index dans le tableau (donc leur différence d'index de ligne) est égal à leur différence d'index de colonne (<code>abs(c[i] - c[j]) == abs(i - j)</code>). La valeur absolue permet de traiter indifféremment les diagonales « montantes » et les diagonales « descendantes ».</li>
</ul>
<p>Ainsi, les solutions, lorsqu'elles existent, forment un sous-ensemble des permutations de {1 ; 2 ; ... ; <em>n</em> - 1} (où <em>n</em> est le nombre de reines et la dimension de l'échiquier).</p>
<p><img alt="Représentation de la modélisation" class="center" src="/images/eight_queens/diagonale.png"></p>
<h2>Approche naïve : examen de l'intégralité des permutations</h2>
<p>Cette approche revient à essayer toutes les combinaisons de placement des reines et de retenir celles pour lesquelles toutes les reines sont en sécurité. Compte tenu du fait que deux reines ne peuvent être sur la même colonne, la solution est une permutation de la suite d'entiers de 0 à <em>n</em> - 1.</p>
<h3>Génération des permutations</h3>
<p>Il est possible de déterminer toutes les permutations possibles d'un tableau en utilisant — par exemple — l'<a href="https://en.wikipedia.org/wiki/Heap%27s_algorithm">algorithme de Heap</a> qui minimise le nombre de mouvements nécessaires à l'obtention de l'intégralité des permutations. Une permutation est obtenue de la précédente en interchangeant la position de deux éléments (et seulement deux).</p>
<p>J'en propose une implémentation récursive : compte tenu des dimensions des tableaux de notre problème, cela reste raisonnable ; on ne risque pas le dépassement de la capacité de la pile d'exécution.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">permutations</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__permutations</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>  <span class="n">__permutations</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">p</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">__permutations</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
</code></pre></div>

<p>Pour donner un exemple :</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]):</span> <span class="nb">print</span> <span class="n">perm</span>
<span class="o">...</span>
<span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span>
</code></pre></div>

<p>En pratique, la bibliothèque standard Python propose dans le module <a href="https://docs.python.org/3/library/itertools.html"><code>itertools</code></a> une fonction générant ces permutations. Mesurons grossièrement le temps d'exécution de ce code avec les deux implémentations :</p>
<div class="highlight"><pre><span></span><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="n">perm</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Heap</span>
<span class="o">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">heaps</span><span class="o">.</span><span class="n">py</span>
<span class="n">real</span><span class="w">    </span><span class="mi">0</span><span class="n">m42</span><span class="o">.</span><span class="mi">860</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">0</span><span class="n">m42</span><span class="o">.</span><span class="mi">832</span><span class="n">s</span>
<span class="n">sys</span><span class="w">     </span><span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">008</span><span class="n">s</span>

<span class="c1"># itertools</span>
<span class="o">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">itertools</span><span class="o">.</span><span class="n">py</span>
<span class="n">real</span><span class="w">    </span><span class="mi">0</span><span class="n">m3</span><span class="o">.</span><span class="mi">433</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">0</span><span class="n">m3</span><span class="o">.</span><span class="mi">428</span><span class="n">s</span>
<span class="n">sys</span><span class="w">     </span><span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">000</span><span class="n">s</span>
</code></pre></div>

<p>La fonction de la blbliothèque standard est bien plus performante que l'implémentation proposée ci-dessus (et heureusement). On utilisera donc celle-ci pour la résolution du problème : autant ne pas tendre le bâton pour se faire battre.</p>
<h3>Résolution</h3>
<p>On a vu que l'ensemble des solutions était contenu dans l'ensemble des permutations de {1 ; 2 ; ... ; <em>n</em> - 1}, soit l'ensemble des permutations de <em>n</em> entiers distincts. De par cette modélisation :</p>
<ul>
<li>puisqu'on ne peut pas mettre deux valeurs au même index d'un tableau, les reines ne peuvent pas être sur la même ligne ;</li>
<li>par construction de l'ensemble sur lequel on initialise les permutations, aucune reine ne peut être sur la même colonne qu'un autre.</li>
</ul>
<p>Il reste alors à appliquer directement la formule de vérification des diagonales proposée dans le paragraphe <em>Modélisation</em>. Le code qui suit n'est volontairement pas l'écriture « idéale » en Python par souci de lisibilité pour ceux qui n'y sont pas familiers.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">is_safe</span><span class="p">(</span><span class="n">permutation</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">permutation</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">permutation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">permutation</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>On initialise la première permutation à <code>[0, 1, 2, ..., n - 1]</code> avec <code>range(n)</code>. Une fois les permutations calculées, le câblage de l'ensemble est immédiat.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">board_size</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
    <span class="n">solutions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">permutation</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">board_size</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">is_safe</span><span class="p">(</span><span class="n">permutation</span><span class="p">):</span>
            <span class="n">solutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permutation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">solutions</span>
</code></pre></div>

<h3>Représentation des solutions</h3>
<p>Il est toujours plus simple de vérifier les solutions en les visualisant. <a href="https://en.wikipedia.org/wiki/Eight_queens_puzzle#Counting_solutions">Le nombre de solutions en fonction du nombre de reines étant connu</a>, on ajoute le nombre de solutions trouvées pour faciliter la validation de l'algorithme.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">print_solutions</span><span class="p">(</span><span class="n">solutions</span><span class="p">,</span> <span class="n">board_size</span><span class="p">):</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;+---&#39;</span> <span class="o">*</span> <span class="n">board_size</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
    <span class="k">for</span> <span class="n">solution</span> <span class="ow">in</span> <span class="n">solutions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">solution</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">separator</span>
            <span class="nb">print</span> <span class="s1">&#39;|   &#39;</span> <span class="o">*</span> <span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;| Q |&#39;</span> <span class="o">+</span> <span class="s1">&#39;   |&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">board_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">column</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">separator</span>
        <span class="nb">print</span>
    <span class="nb">print</span> <span class="s2">&quot;Found&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">solutions</span><span class="p">),</span> <span class="s2">&quot;solutions&quot;</span>


<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">solutions</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">print_solutions</span><span class="p">(</span><span class="n">solutions</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code># 91 autres solutions
# [...]

+---+---+---+---+---+---+---+---+
|   |   |   |   |   |   |   | Q |
+---+---+---+---+---+---+---+---+
|   |   |   | Q |   |   |   |   |
+---+---+---+---+---+---+---+---+
| Q |   |   |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
|   |   | Q |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
|   |   |   |   |   | Q |   |   |
+---+---+---+---+---+---+---+---+
|   | Q |   |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
|   |   |   |   |   |   | Q |   |
+---+---+---+---+---+---+---+---+
|   |   |   |   | Q |   |   |   |
+---+---+---+---+---+---+---+---+

Found 92 solutions
</code></pre></div>

<p>Il faut environ 60 ms pour obtenir l'intégralité des solutions et les représenter.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>python<span class="w"> </span>brute-force.py
python<span class="w"> </span>brute-force.py<span class="w">  </span><span class="m">0</span>,06s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>,00s<span class="w"> </span>system<span class="w"> </span><span class="m">91</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">0</span>,061<span class="w"> </span>total
</code></pre></div>

<p>Pour cette dimension, c'est tout à fait acceptable et on pourrait s'en contenter. On pourrait... mais ça ne serait pas satisfaisant pour la curiosité !</p>
<h2>Seconde approche : algorithme de retour sur trace (<em>backtracking</em>)</h2>
<p>Cette classe d'algorithmes parcourt toutes les possibilités en éliminant d'emblée toute solution partielle qui ne convient pas. Il permet donc d'éviter de n'avoir ne serait-ce qu'à considérer de nombreuses combinaisons : il est en ce sens plus économe que l'algorithme de force brute. La résolution du problème revient alors à un parcours de graphe.</p>
<h3>Exemple</h3>
<p>Pour y voir plus clair, commençons par un exemple simple. On souhaite obtenir les combinaisons de nœuds permettant de former le mot « BLOG » en parcourant l'arbre. On continue de descendre dans l'arbre tant que la combinaison permet d'obtenir une solution (nœuds bleus). Dès que celle-ci ne le permet plus (nœud rouge), on ignore les branches suivantes (nœud gris).</p>
<p>Dans cet exemple, on n'obtient qu'une solution mais rien n'empêche d'en avoir plusieurs.</p>
<p><img alt="Exemple de backtracking" class="center" src="/images/eight_queens/backtracking.png"></p>
<h3>Résolution</h3>
<p>On conserve la même modélisation : les <em>n</em> reines sont réparties sur les <em>n</em> lignes à raison d'une par ligne. On place les reines une par une tant que cela est possible. Si le placement d'une reine échoue — donc qu'il n'existe pas de position telle que la reine puisse être en sécurité, on remet en question les choix précédents afin de sortir du blocage. On revient alors à un point où des alternatives étaient possibles et on essaie la possibilité suivante.</p>
<p>L'arbre qui sera parcouru contient toutes les positions des reines, valides ou non. On a donc un arbre de la forme de la figure ci-dessous (tronqué, dans l'exemple de 4 reines et d'un échiquier de 16 cases).</p>
<p><img alt="Application du backtracking au problème" class="center" src="/images/eight_queens/backtracking_queens.png"></p>
<p>Commençons par nous pencher sur la fonction indiquant si une reine est en sécurité. Nous ne fonctionnons plus avec des permutations contenant toutes les positions des reines mais sur des positions partielles — avec un nombre de reines inférieur au nombre de reines total attendu — valides par rapport auxquelles on vérifie si l'on peut ajouter une reine à une position donnée. Plutôt que de vérifier systématiquement la validité de l'intégralité de la solution, on vérifie que l'ajout d'une reine à la solution partielle précédente donnée produit une solution valide.</p>
<p>On teste donc :</p>
<ul>
<li>que la colonne que laquelle la reine a été placée n'est pas déjà attribuée à une autre reine en vérifiant que le tableau de solutions ne contient pas la colonne que l'on cherche à attribuer (<code>not col in queens</code>);</li>
<li>qu'aucune reine ne se trouve sur les mêmes diagonales que la nouvelle.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">is_safe</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">queens</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queens</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">queens</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">col</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">line</span> <span class="o">-</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">queens</span><span class="p">)))</span>
</code></pre></div>

<p>Passons à la résolution en elle-même. Pour chaque nouvelle ligne, nous allons tester l'intégralité des colonnes au regard des solutions obtenues jusqu'à la ligne précédente. Cela donne :</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="c1"># Initialisation des solutions pour une taille 0 (tableau contenant un tableau vide)</span>
    <span class="n">solutions</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">solutions</span> <span class="o">=</span> <span class="p">[</span><span class="n">solution</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">solution</span> <span class="ow">in</span> <span class="n">solutions</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">is_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">solution</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">solutions</span>
</code></pre></div>

<p>Pour mieux comprendre cet algorithme, il en existe une <a href="https://www.cs.usfca.edu/~galles/visualization/RecQueens.html">version animée détaillant les étapes de la résolution</a>.</p>
<h2>Troisième approche : programmation par contraintes</h2>
<h3>Principe</h3>
<p>Un problème de satisfaction de contraintes (ou CSP pour <em>Constraint Satisfaction Problem</em>) désigne l'ensemble des problèmes définis par... des contraintes. La résolution consiste à chercher <em>une</em> solution les respectant. Pour cela, on décrit un modèle définit par :</p>
<ul>
<li>un ensemble de variables ;</li>
<li>un ensemble de contraintes régissant ces variables.</li>
</ul>
<p>À partir de ce modèle, le système cherchera une solution et la proposera si elle existe. En revanche, il ne proposera qu'une seule solution : la résolution d'un problème par contraintes n'a pas vocation à chercher l'ensemble exhaustif des solutions.</p>
<h3>Implémentation</h3>
<p>En Python, la bibliothèque <a href="http://numberjack.ucc.ie">Numberjack</a> facilite la programmation par contraintes. Les auteurs fournissent d'ailleurs à titre d'exemple une <a href="http://numberjack.ucc.ie/examples/nqueens">solution pour le problème des <em>n</em> reines</a>.</p>
<p>Dans le cas générique des <em>n</em> reines, on définit dans notre ensemble de variables les reines. Chacun d'elles est de type <code>Variable(n)</code>, soit une variable dans un domaine compris entre 0 et <em>n</em>. La contrainte <code>AllDiff</code> impose à toutes les expressions qui lui sont passées d'êtres différentes. On impose donc :</p>
<ul>
<li>que toutes les reines soient dans des colonnes différentes (<code>AllDiff( queens )</code>) ;</li>
<li>que toutes les reines soient sur des diagonales différentes (combinaison de <code>AllDiff( [queens[i] + i for i in range(n)] )</code> et <code>AllDiff( [queens[i] - i for i in range(n)] )</code>).</li>
</ul>
<p>On suppose donc ici aussi que chaque reine est sur une ligne distincte : la reine 0 sera sur la ligne 0, la reine 1 sur la ligne 1, etc.</p>
<p>La description du modèle devient :</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">Numberjack</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">model_queens</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">queens</span> <span class="o">=</span> <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">model</span>  <span class="o">=</span> <span class="n">Model</span><span class="p">(</span>
        <span class="n">AllDiff</span><span class="p">(</span> <span class="n">queens</span> <span class="p">),</span>
        <span class="n">AllDiff</span><span class="p">(</span> <span class="p">[</span><span class="n">queens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="p">),</span>
        <span class="n">AllDiff</span><span class="p">(</span> <span class="p">[</span><span class="n">queens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">queens</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</code></pre></div>

<p>La résolution du problème est alors immédiate :</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">solve_queens</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">queens</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="n">model_queens</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">])</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    <span class="n">print_chessboard</span><span class="p">(</span><span class="n">queens</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;Nodes:&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">getNodes</span><span class="p">(),</span> <span class="s1">&#39; Time:&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">print_chessboard</span><span class="p">(</span><span class="n">queens</span><span class="p">):</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;+---&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">queens</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
    <span class="k">for</span> <span class="n">queen</span> <span class="ow">in</span> <span class="n">queens</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">separator</span>
        <span class="nb">print</span> <span class="s1">&#39;|   &#39;</span><span class="o">*</span><span class="n">queen</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;| Q |&#39;</span><span class="o">+</span><span class="s1">&#39;   |&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">queens</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">queen</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
    <span class="nb">print</span> <span class="n">separator</span>

<span class="n">solve_queens</span><span class="p">(</span><span class="nb">input</span><span class="p">({</span> <span class="s1">&#39;solver&#39;</span><span class="p">:</span><span class="s1">&#39;Mistral&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="mi">8</span> <span class="p">}))</span>
</code></pre></div>

<p>La proposition d'une solution est également très rapide :</p>
<div class="highlight"><pre><span></span><code><span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">| Q |   |   |   |   |   |   |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   |   |   |   | Q |   |   |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   |   |   |   |   |   |   | Q |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   |   |   |   |   | Q |   |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   |   | Q |   |   |   |   |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   |   |   |   |   |   | Q |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   | Q |   |   |   |   |   |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">|   |   |   | Q |   |   |   |   |</span>
<span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">Nodes: 24  Time: 0</span><span class="nt">.</span><span class="c">0</span>
</code></pre></div>

<p>Une mesure plus fine du temps d'exécution indique qu'il a fallu environ 20 millisecondes pour proposer cette solution (qui inclut le temps d'exécution total du programme Python).</p>
<h2>Comparaison des approches</h2>
<p>On a vu trois méthodes différentes de résolution du problème. Parmi elles, seules deux fournissent l'intégralité des solutions et donc répondent réellement au problème. La résolution par force brute est probablement la plus lisible mais égalment la moins efficace. La solution par retour arrière est légèrement plus complexe mais sa durée de résolution, bien plus faible, la rend nettement plus avantageuse pour un « grand » échiquier.</p>
<table class="table">
  <caption>Comparaison des algorithmes pour une résolution avec 8 reines sur un échiquier de 64 cases</caption>
  <thead>
    <tr>
      <th>Algorithme</th>
      <th>Durée d'exécution</th>
      <th>Nombre de solutions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Force brute</td>
      <td>83 ms</td>
      <td>92</td>
    </tr>
    <tr>
      <td>Retour sur trace</td>
      <td>55 ms</td>
      <td>92</td>
    </tr>
    <tr>
      <td>Programmation par contraintes</td>
      <td>18 ms</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<p>Comme le montre le tableau ci-dessus, le choix de la méthode de résolution dépendra surtout du besoin : faut-il <em>une</em> solution ou <em>toutes</em> les solutions ? Lorsqu'il les faut toutes, les quelques dizaines de millisecondes d'écart entre les deux algorithmes ne font pas la différence pour huit reines. En revanche, l'augmentation de la taille de l'échiquier induit une augmentation exponentielle du temps de résolution. Le graphique ci-dessous montre la flagrance de différence de temps d'exécution entre les deux algorithmes lorsque le nombre de permutations augmente.</p>
<p><img alt="Comparaison des durées d'obtention de toutes les solutions en fonction de l'algorithme" class="center" src="/images/eight_queens/comparaison.png"></p>
<p>Dès 10 reines et un échiquier de 100 cases, l'algorithme de force brute n'est plus utilisable : il lui faut plusieurs dizaines de minutes pour fournir les solutions. La solution implémentant l'algorithme de <em>backtracking</em>, elle, retourne les 14&nbsp;200 solutions en moins de 10 secondes.</p>
<p>La résolution par contraintes, reste très performante lorsque le problème de complexifie : elle permet d'obtenir une solution en moins de 150&nbsp;ms pour 200 reines et un échiquier de 40&nbsp;000 cases. Bien qu'elle ne propose qu'une et une seule solution, elle peut s'avérer pertinente lorsqu'on ne cherche pas un résultat particulier. L'implémentation présentée ici monte ses limites en dépassant les 500 reines et les 250 000 cases.</p>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posté dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a><br />
            Mots-clés:  #<a href="https://www.dericbourg.net/tag/algorithmique.html">algorithmique</a> #<a href="https://www.dericbourg.net/tag/python.html">python</a> #<a href="https://www.dericbourg.net/tag/jeu.html">jeu</a>        </div>
      </footer>
      <hr />
      <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dericbourg'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </article> <!-- /#page-main -->

        <aside id="page-side">
          <!-- begin includes/sidebar.html -->
          <nav>
            <h3>Liens</h3>
            <ul>
              <li><a href="https://github.com/adericbourg">GitHub</a></li>
              <li><a href="https://www.linkedin.com/in/adericbourg/">LinkedIn</a></li>
              <li><a href="https://twitter.com/adericbourg">Twitter</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
      </footer>
    </div> <!-- /#page -->
  </body>
</html>