<!DOCTYPE html>
<html lang="fr">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Utiliser un Raspberry Pi comme point d'accès Wifi — Blog bloquant</title>
    <!--[if lte IE 8]><script type="text/javascript" src="https://www.dericbourg.net/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/skeleton.css" />
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/theme.css" />
    <link rel="shortcut icon" type="image/png" href="https://www.dericbourg.net/favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="https://www.dericbourg.net/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="Blog bloquant — Flux Atom"
                           href="https://www.dericbourg.net/" /> 

    <meta name="author"   content="Alban Dericbourg" />
    <meta name="keywords" content="wifi, raspberrypi, linux, iptables" />
    <link rel="stylesheet" media="not print" type="text/css" href="https://www.dericbourg.net/theme/css/pygments.css" /> 
  </head>
  <body>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="https://www.dericbourg.net/index.html">Blog bloquant</a>
        </h1>
      </header>
      
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="https://www.dericbourg.net/2015/07/04/utiliser-un-raspberry-pi-comme-point-dacces-wifi/"
             title="Lien permanent vers «Utiliser un Raspberry Pi comme point d'accès Wifi»">
             Utiliser un Raspberry Pi comme point d'accès Wifi
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Le <time datetime="2015-07-04T00:00:00+02:00">Sat 04 July 2015</time>
            dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a>              <br />Mots-clés:              <a rel="tag" href="https://www.dericbourg.net/tag/wifi.html">wifi</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/raspberrypi.html">raspberrypi</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/linux.html">linux</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/iptables.html">iptables</a>        </div>
      </header>
      <div class="post-content"> 
        <p>Dans cet article, nous verrons comment configurer un Raspberry Pi en tant que
point d'accès Wifi.</p>
<h3>Pré-requis</h3>
<p>Je supposerai que vous avez à disposition :</p>
<ul>
<li><a href="https://www.raspberrypi.org/">Un Raspberry Pi</a></li>
<li>La distribution <a href="https://www.raspbian.org/">Raspbian</a> ou toute autre
   distribution Linux</li>
<li>Un <em>dongle</em> Wifi (déjà installé et détecté)</li>
</ul>
<p>Dans la suite, on considèrera que l'interface sans fil est nommée <code>wlan0</code>.  </p>
<h3>Définition d'une adresse IP statique</h3>
<p>Dans le fichier <code>/etc/network/interfaces</code>, supprimer les lignes suivantes :</p>
<div class="highlight"><pre><span></span>iface wlan0 inet manual
wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</pre></div>


<p>Les remplacer par :</p>
<div class="highlight"><pre><span></span>allow-hotplug wlan0
iface wlan0 inet static
address 192.168.100.1
netmask 255.255.255.0
</pre></div>


<p>Redémarrez le réseau :</p>
<div class="highlight"><pre><span></span>sudo service networking restart
</pre></div>


<h3>Installation d'un serveur DHCP</h3>
<p>Le serveur DHCP permet d'attribuer automatiquement une adresse IP aux machines
qui se connecteront à votre réseau Wifi.</p>
<p>Installez le paquet <em><a href="https://packages.debian.org/isc-dhcp-server">isc-dhcp-server</a></em> :</p>
<div class="highlight"><pre><span></span>sudo apt-get install isc-dhcp-server
</pre></div>


<p>À ce stade, le service ne devrait pas démarrer correctement :</p>
<div class="highlight"><pre><span></span>Generating /etc/default/isc-dhcp-server...
[FAIL] Starting ISC DHCP server: dhcpd[....] check syslog for diagnostics. ... failed!
 failed!
invoke-rc.d: initscript isc-dhcp-server, action &quot;start&quot; failed.
</pre></div>


<p>Vous pouvez ignorer ces erreurs pour le moment.</p>
<p>Éditez le fichier de configuration du serveur : <code>/etc/dhcp/dhcpd.conf</code> et
commentez les options <em>domain-name</em> et <em>domain-name-servers</em> :</p>
<div class="highlight"><pre><span></span>#option domain-name &quot;example.org&quot;;
#option domain-name-servers ns1.example.org, ns2.example.org;
</pre></div>


<p>Décommentez la ligne <em>authoritative</em>. Cela permet d'indiquer à votre serveur
DHCP qu'il est le seul à fournir des adresses IP sur ce réseau et donc possède
la pleine connaissance des
<a href="http://www.linux-france.org/prj/edu/archinet/systeme/ch27s03.html">baux accordés</a>.</p>
<div class="highlight"><pre><span></span># If this DHCP server is the official DHCP server for the local
# network, the authoritative directive should be uncommented.
authoritative;
</pre></div>


<p>Enfin, configurez le comportement du serveur DHCP :</p>
<div class="highlight"><pre><span></span>subnet 192.168.100.0 netmask 255.255.255.0 {
  range 192.168.100.10 192.168.100.50;
  option broadcast-address 192.168.100.255;
  option routers 192.168.100.1;
  default-lease-time 600;
  max-lease-time 7200;
  option domain-name &quot;local&quot;;
  option domain-name-servers 80.67.169.12;
}
</pre></div>


<p>Le paramètre <em>range</em> limite la place d'adresses IP qui seront alouées. On en
permet ici 51 : c'est probablement beaucoup (trop) s'il s'agit de votre réseau
personnel.</p>
<p>L'option <em>broadcast-address</em> spécifie l'adresse IP telle que les paquets qui
seront envoyés sur cette adresse seront interceptés par toutes les machines
présentes sur ce réseau (ayant donc une IP entre 192.166.100.1 et
192.168.100.254 car le masque de sous réseau est 255.255.255.0).</p>
<p>Quant à elle, l'option <em>routers</em> indique l'adresse de la passerelle, c'est à
dire la machine par laquelle passent tous les paquets sortants du réseau (en
direction ou en provenance d'Internet par exemple). </p>
<p>On attribue ici un bail pour une durée de 600 secondes avec le paramètre
<em>default-lease-time</em>. C'est cette durée qui sera utilisée si le client ne
précise rien. S'il demande un bail en précisant une durée, celle-ci lui sera
accordée si elle ne dépasse pas 7200 secondes, comme défini avec le paramètre
<em>max-lease-time</em>.</p>
<p>Cet exemple utilise le DNS de <a href="https://www.fdn.fr">FDN</a> (ligne <em>domain-name-servers</em>).
Vous pouvez bien évidemment en utiliser d'autres (certains préfèrent
<a href="https://developers.google.com/speed/public-dns/">ceux de Google</a>...).</p>
<p>Déclarez enfin l'interface sans fil comme l'interface par défaut pour répondre
aux requêtes DHCP dans le fichier <code>/etc/default/isc-dhcp-server</code> :</p>
<div class="highlight"><pre><span></span># On what interfaces should the DHCP server (dhcpd) serve DHCP requests?
#       Separate multiple interfaces with spaces, e.g. &quot;eth0 eth1&quot;.
#INTERFACES=&quot;&quot;
INTERFACES=&quot;wlan0&quot;
</pre></div>


<h3>Installation de <em>hostapd</em></h3>
<p><a href="https://w1.fi/hostapd/">Hostapd</a> est un démon permettant de créer un point
d'accès sans fil. Pour l'installer :</p>
<div class="highlight"><pre><span></span>sudo apt-get install hostapd
</pre></div>


<p>Créez son fichier de configuration, <code>/etc/hostapd/hostapd.conf</code> :</p>
<div class="highlight"><pre><span></span>interface=wlan0
driver=nl80211
ssid=&amp;lt;YOUR SSID&amp;gt;
hw_mode=g
channel=6
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=&amp;lt;YOUR PASSPHRASE&amp;gt;
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
</pre></div>


<p>Remplacez dans cet exemple :</p>
<ul>
<li><code>&lt;YOUR SSID&gt;</code> par le nom que vous souhaitez donner à votre réseau ;</li>
<li><code>&lt;YOUR PASSPHRASE&gt;</code> par le mot de passer permettant l'accès au réseau.</li>
</ul>
<p>Déclarez enfin ce fichier afin qu'il soit utilisé par hostapd dans
<code>/etc/default/hostapd</code> en ajoutant la ligne :</p>
<div class="highlight"><pre><span></span>DAEMON_CONF=&quot;/etc/hostapd/hostapd.conf&quot;
</pre></div>


<h3>Configuration du routage entre l'interface sans fil et l'interface filaire</h3>
<p>Activer le routage IP dans le fichier <code>/etc/sysctl.conf</code> en décommentant la
ligne suivante :</p>
<div class="highlight"><pre><span></span>net.ipv4.ip_forward=1
</pre></div>


<p>Pour activer ce routage immédiatement (sans avoir besoin de redémarrer), lancez
la commande :</p>
<div class="highlight"><pre><span></span>sudo sh -c &quot;echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward&quot;
</pre></div>


<p>Vous pouvez enfin configurer le routage en utilisant
<em><a href="http://ipset.netfilter.org/iptables.man.html">iptables</a></em> :</p>
<div class="highlight"><pre><span></span>sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
</pre></div>


<h3>Persistence des règles <em>iptables</em></h3>
<p>Les règles <em>iptables</em> définies précédemment sont perdues au au redémarrage. Pour
les recharger à chaque lancement de la machine, vous pouvez utiliser le paquet
<em><a href="https://packages.debian.org/iptables-persistent">iptables-persistent</a></em>. Pour
l'installer :</p>
<div class="highlight"><pre><span></span>sudo apt-get install iptables-persistent
</pre></div>


<p>Par défaut, il demandera si vous souhaitez enregistrer les règles actuellement
définies. Choisissez « oui ». Si vous souhaitez les redéfinir ultérieurement,
vous pourrez les enregistrer en invoquant la cible <em>save</em> et les recharger avec
<em>reload</em> :</p>
<div class="highlight"><pre><span></span>sudo /etc/init.d/iptables-persistent save
sudo /etc/init.d/iptables-persistent reload
</pre></div>


<h3>La voie est libre</h3>
<p>À ce stade, vous deviez être en mesure de vous connecter au point d'accès de
façon transparente. Étant donnée la richesse des matériels et leurs
spécificités, je ne garantis pas que ce « mode d'emploi » soit universel.
J'espère néanmoins qu'il vous aura aidé en première approche à monter votre
propre point d'accès Wifi.</p>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posté dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a><br />
            Mots-clés:  #<a href="https://www.dericbourg.net/tag/wifi.html">wifi</a> #<a href="https://www.dericbourg.net/tag/raspberrypi.html">raspberrypi</a> #<a href="https://www.dericbourg.net/tag/linux.html">linux</a> #<a href="https://www.dericbourg.net/tag/iptables.html">iptables</a>        </div>
      </footer>
      <hr />
      <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dericbourg'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </article> <!-- /#page-main -->

        <aside id="page-side">
          <!-- begin includes/sidebar.html -->
          <nav>
            <h3>Pages</h3>
            <ul>
              <li><a href="https://www.dericbourg.net">Accueil</a></li>
              <li><a href="https://www.dericbourg.net/categories.html">Catégories</a></li>
              <li><a href="https://www.dericbourg.net/archives.html">Archives</a></li>
              <li><a href="https://www.dericbourg.net/tags.html">Mots-clés</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Catégories</h3>
            <ul>
              <li class="active"><a href="https://www.dericbourg.net/category/blog.html">Blog</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Liens</h3>
            <ul>
              <li><a href="https://github.com/adericbourg">GitHub</a></li>
              <li><a href="https://www.linkedin.com/in/adericbourg/">LinkedIn</a></li>
              <li><a href="https://twitter.com/adericbourg">Twitter</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
      </footer>
    </div> <!-- /#page -->
  </body>
</html>