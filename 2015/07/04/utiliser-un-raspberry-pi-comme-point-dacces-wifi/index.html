<!DOCTYPE html>
<html lang="fr">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Utiliser un Raspberry Pi comme point d'accès Wifi — Blog bloquant</title>
    <!--[if lte IE 8]><script type="text/javascript" src="https://www.dericbourg.net/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/skeleton.css" />
    <link rel="stylesheet" type="text/css" href="https://www.dericbourg.net/theme/css/theme.css" />
    <link rel="shortcut icon" type="image/png" href="https://www.dericbourg.net/favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="https://www.dericbourg.net/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="Blog bloquant — Flux Atom"
                           href="https://www.dericbourg.net/" /> 

    <meta name="author"   content="Alban Dericbourg" />
    <meta name="keywords" content="wifi, raspberrypi, linux, iptables" />
    <link rel="stylesheet" media="not print" type="text/css" href="https://www.dericbourg.net/theme/css/pygments.css" /> 
  </head>
  <body>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="https://www.dericbourg.net/index.html">Blog bloquant</a>
        </h1>
      </header>
      
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="https://www.dericbourg.net/2015/07/04/utiliser-un-raspberry-pi-comme-point-dacces-wifi/"
             title="Lien permanent vers «Utiliser un Raspberry Pi comme point d'accès Wifi»">
             Utiliser un Raspberry Pi comme point d'accès Wifi
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Le <time datetime="2015-07-04T00:00:00+02:00">Sat 04 July 2015</time>
            dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a>              <br />Mots-clés:              <a rel="tag" href="https://www.dericbourg.net/tag/wifi.html">wifi</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/raspberrypi.html">raspberrypi</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/linux.html">linux</a>,               <a rel="tag" href="https://www.dericbourg.net/tag/iptables.html">iptables</a>        </div>
      </header>
      <div class="post-content"> 
        <p>Dans cet article, nous verrons comment configurer un Raspberry Pi en tant que
point d'accès Wifi.</p>
<h2>Pré-requis</h2>
<p>Je supposerai que vous avez à disposition :</p>
<ul>
<li><a href="https://www.raspberrypi.org/">Un Raspberry Pi</a></li>
<li>La distribution <a href="https://www.raspbian.org/">Raspbian</a> ou toute autre
  distribution Linux</li>
<li>Un <em>dongle</em> Wifi (déjà installé et détecté)</li>
</ul>
<p>Dans la suite, on considèrera que l'interface sans fil est nommée <code>wlan0</code>.</p>
<h2>Définition d'une adresse IP statique</h2>
<p>Dans le fichier <code>/etc/network/interfaces</code>, supprimer les lignes suivantes :</p>
<div class="highlight"><pre><span></span><span class="n">iface</span> <span class="n">wlan0</span> <span class="n">inet</span> <span class="n">manual</span>
<span class="n">wpa</span><span class="o">-</span><span class="n">roam</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">wpa_supplicant</span><span class="o">/</span><span class="n">wpa_supplicant</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>Les remplacer par :</p>
<div class="highlight"><pre><span></span><span class="n">allow</span><span class="o">-</span><span class="n">hotplug</span> <span class="n">wlan0</span>
<span class="n">iface</span> <span class="n">wlan0</span> <span class="n">inet</span> <span class="k">static</span>
<span class="n">address</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">1</span>
<span class="n">netmask</span> <span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">0</span>
</pre></div>


<p>Redémarrez le réseau :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">networking</span> <span class="k">restart</span>
</pre></div>


<h2>Installation d'un serveur DHCP</h2>
<p>Le serveur DHCP permet d'attribuer automatiquement une adresse IP aux machines
qui se connecteront à votre réseau Wifi.</p>
<p>Installez le paquet <em><a href="https://packages.debian.org/isc-dhcp-server">isc-dhcp-server</a></em> :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">isc</span><span class="o">-</span><span class="n">dhcp</span><span class="o">-</span><span class="n">server</span>
</pre></div>


<p>À ce stade, le service ne devrait pas démarrer correctement :</p>
<div class="highlight"><pre><span></span><span class="nv">Generating</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">default</span><span class="o">/</span><span class="nv">isc</span><span class="o">-</span><span class="nv">dhcp</span><span class="o">-</span><span class="nv">server</span>...
[<span class="nv">FAIL</span>] <span class="nv">Starting</span> <span class="nv">ISC</span> <span class="nv">DHCP</span> <span class="nv">server</span>: <span class="nv">dhcpd</span>[....] <span class="nv">check</span> <span class="nv">syslog</span> <span class="k">for</span> <span class="nv">diagnostics</span>. ... <span class="nv">failed</span><span class="o">!</span>
 <span class="nv">failed</span><span class="o">!</span>
<span class="nv">invoke</span><span class="o">-</span><span class="nv">rc</span>.<span class="nv">d</span>: <span class="nv">initscript</span> <span class="nv">isc</span><span class="o">-</span><span class="nv">dhcp</span><span class="o">-</span><span class="nv">server</span>, <span class="nv">action</span> <span class="s2">&quot;</span><span class="s">start</span><span class="s2">&quot;</span> <span class="nv">failed</span>.
</pre></div>


<p>Vous pouvez ignorer ces erreurs pour le moment.</p>
<p>Éditez le fichier de configuration du serveur : <code>/etc/dhcp/dhcpd.conf</code> et
commentez les options <em>domain-name</em> et <em>domain-name-servers</em> :</p>
<div class="highlight"><pre><span></span><span class="o">#</span><span class="k">option</span> <span class="k">domain</span><span class="o">-</span><span class="n">name</span> <span class="ss">&quot;example.org&quot;</span><span class="p">;</span>
<span class="o">#</span><span class="k">option</span> <span class="k">domain</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">servers</span> <span class="n">ns1</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">ns2</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">org</span><span class="p">;</span>
</pre></div>


<p>Décommentez la ligne <em>authoritative</em>. Cela permet d'indiquer à votre serveur
DHCP qu'il est le seul à fournir des adresses IP sur ce réseau et donc possède
la pleine connaissance des
<a href="http://www.linux-france.org/prj/edu/archinet/systeme/ch27s03.html">baux accordés</a>.</p>
<div class="highlight"><pre><span></span># <span class="k">If</span> <span class="nv">this</span> <span class="nv">DHCP</span> <span class="nv">server</span> <span class="nv">is</span> <span class="nv">the</span> <span class="nv">official</span> <span class="nv">DHCP</span> <span class="nv">server</span> <span class="k">for</span> <span class="nv">the</span> <span class="nv">local</span>
# <span class="nv">network</span>, <span class="nv">the</span> <span class="nv">authoritative</span> <span class="nv">directive</span> <span class="nv">should</span> <span class="nv">be</span> <span class="nv">uncommented</span>.
<span class="nv">authoritative</span><span class="c1">;</span>
</pre></div>


<p>Enfin, configurez le comportement du serveur DHCP :</p>
<div class="highlight"><pre><span></span><span class="n">subnet</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="n">netmask</span> <span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">0</span> <span class="err">{</span>
  <span class="n">range</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">10</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">50</span><span class="p">;</span>
  <span class="k">option</span> <span class="n">broadcast</span><span class="o">-</span><span class="n">address</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">255</span><span class="p">;</span>
  <span class="k">option</span> <span class="n">routers</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">default</span><span class="o">-</span><span class="n">lease</span><span class="o">-</span><span class="n">time</span> <span class="mi">600</span><span class="p">;</span>
  <span class="k">max</span><span class="o">-</span><span class="n">lease</span><span class="o">-</span><span class="n">time</span> <span class="mi">7200</span><span class="p">;</span>
  <span class="k">option</span> <span class="k">domain</span><span class="o">-</span><span class="n">name</span> <span class="ss">&quot;local&quot;</span><span class="p">;</span>
  <span class="k">option</span> <span class="k">domain</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">servers</span> <span class="mi">80</span><span class="p">.</span><span class="mi">67</span><span class="p">.</span><span class="mi">169</span><span class="p">.</span><span class="mi">12</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>


<p>Le paramètre <em>range</em> limite la place d'adresses IP qui seront alouées. On en
permet ici 51 : c'est probablement beaucoup (trop) s'il s'agit de votre réseau
personnel.</p>
<p>L'option <em>broadcast-address</em> spécifie l'adresse IP telle que les paquets qui
seront envoyés sur cette adresse seront interceptés par toutes les machines
présentes sur ce réseau (ayant donc une IP entre 192.166.100.1 et
192.168.100.254 car le masque de sous réseau est 255.255.255.0).</p>
<p>Quant à elle, l'option <em>routers</em> indique l'adresse de la passerelle, c'est à
dire la machine par laquelle passent tous les paquets sortants du réseau (en
direction ou en provenance d'Internet par exemple).</p>
<p>On attribue ici un bail pour une durée de 600 secondes avec le paramètre
<em>default-lease-time</em>. C'est cette durée qui sera utilisée si le client ne
précise rien. S'il demande un bail en précisant une durée, celle-ci lui sera
accordée si elle ne dépasse pas 7200 secondes, comme défini avec le paramètre
<em>max-lease-time</em>.</p>
<p>Cet exemple utilise le DNS de <a href="https://www.fdn.fr">FDN</a> (ligne <em>domain-name-servers</em>).
Vous pouvez bien évidemment en utiliser d'autres (certains préfèrent
<a href="https://developers.google.com/speed/public-dns/">ceux de Google</a>...).</p>
<p>Déclarez enfin l'interface sans fil comme l'interface par défaut pour répondre
aux requêtes DHCP dans le fichier <code>/etc/default/isc-dhcp-server</code> :</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">On</span> <span class="n">what</span> <span class="n">interfaces</span> <span class="n">should</span> <span class="n">the</span> <span class="n">DHCP</span> <span class="n">server</span> <span class="p">(</span><span class="n">dhcpd</span><span class="p">)</span> <span class="n">serve</span> <span class="n">DHCP</span> <span class="n">requests</span><span class="o">?</span>
<span class="o">#</span>       <span class="n">Separate</span> <span class="n">multiple</span> <span class="n">interfaces</span> <span class="k">with</span> <span class="n">spaces</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="k">g</span><span class="p">.</span> <span class="ss">&quot;eth0 eth1&quot;</span><span class="p">.</span>
<span class="o">#</span><span class="n">INTERFACES</span><span class="o">=</span><span class="ss">&quot;&quot;</span>
<span class="n">INTERFACES</span><span class="o">=</span><span class="ss">&quot;wlan0&quot;</span>
</pre></div>


<h2>Installation de <em>hostapd</em></h2>
<p><a href="https://w1.fi/hostapd/">Hostapd</a> est un démon permettant de créer un point
d'accès sans fil. Pour l'installer :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">hostapd</span>
</pre></div>


<p>Créez son fichier de configuration, <code>/etc/hostapd/hostapd.conf</code> :</p>
<div class="highlight"><pre><span></span><span class="n">interface</span><span class="o">=</span><span class="n">wlan0</span>
<span class="n">driver</span><span class="o">=</span><span class="n">nl80211</span>
<span class="n">ssid</span><span class="o">=&lt;</span><span class="n">YOUR</span> <span class="n">SSID</span><span class="o">&gt;</span>
<span class="n">hw_mode</span><span class="o">=</span><span class="k">g</span>
<span class="n">channel</span><span class="o">=</span><span class="mi">6</span>
<span class="n">macaddr_acl</span><span class="o">=</span><span class="mi">0</span>
<span class="n">auth_algs</span><span class="o">=</span><span class="mi">1</span>
<span class="n">ignore_broadcast_ssid</span><span class="o">=</span><span class="mi">0</span>
<span class="n">wpa</span><span class="o">=</span><span class="mi">2</span>
<span class="n">wpa_passphrase</span><span class="o">=&lt;</span><span class="n">YOUR</span> <span class="n">PASSPHRASE</span><span class="o">&gt;</span>
<span class="n">wpa_key_mgmt</span><span class="o">=</span><span class="n">WPA</span><span class="o">-</span><span class="n">PSK</span>
<span class="n">wpa_pairwise</span><span class="o">=</span><span class="n">TKIP</span>
<span class="n">rsn_pairwise</span><span class="o">=</span><span class="n">CCMP</span>
</pre></div>


<p>Remplacez dans cet exemple :</p>
<ul>
<li><code>&lt;YOUR SSID&gt;</code> par le nom que vous souhaitez donner à votre réseau ;</li>
<li><code>&lt;YOUR PASSPHRASE&gt;</code> par le mot de passer permettant l'accès au réseau.</li>
</ul>
<p>Déclarez enfin ce fichier afin qu'il soit utilisé par hostapd dans
<code>/etc/default/hostapd</code> en ajoutant la ligne :</p>
<div class="highlight"><pre><span></span><span class="n">DAEMON_CONF</span><span class="o">=</span><span class="ss">&quot;/etc/hostapd/hostapd.conf&quot;</span>
</pre></div>


<h2>Configuration du routage entre l'interface sans fil et l'interface filaire</h2>
<p>Activer le routage IP dans le fichier <code>/etc/sysctl.conf</code> en décommentant la
ligne suivante :</p>
<div class="highlight"><pre><span></span><span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="o">=</span><span class="mi">1</span>
</pre></div>


<p>Pour activer ce routage immédiatement (sans avoir besoin de redémarrer), lancez
la commande :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sh</span> <span class="o">-</span><span class="k">c</span> <span class="ss">&quot;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&quot;</span>
</pre></div>


<p>Vous pouvez enfin configurer le routage en utilisant
<em><a href="http://ipset.netfilter.org/iptables.man.html">iptables</a></em> :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="k">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">o</span> <span class="n">wlan0</span> <span class="o">-</span><span class="n">m</span> <span class="k">state</span> <span class="c1">--state RELATED,ESTABLISHED -j ACCEPT</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="k">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">wlan0</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2>Persistence des règles <em>iptables</em></h2>
<p>Les règles <em>iptables</em> définies précédemment sont perdues au au redémarrage. Pour
les recharger à chaque lancement de la machine, vous pouvez utiliser le paquet
<em><a href="https://packages.debian.org/iptables-persistent">iptables-persistent</a></em>. Pour
l'installer :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">iptables</span><span class="o">-</span><span class="n">persistent</span>
</pre></div>


<p>Par défaut, il demandera si vous souhaitez enregistrer les règles actuellement
définies. Choisissez « oui ». Si vous souhaitez les redéfinir ultérieurement,
vous pourrez les enregistrer en invoquant la cible <em>save</em> et les recharger avec
<em>reload</em> :</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">persistent</span> <span class="n">save</span>
<span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">persistent</span> <span class="n">reload</span>
</pre></div>


<h2>La voie est libre</h2>
<p>À ce stade, vous deviez être en mesure de vous connecter au point d'accès de
façon transparente. Étant donnée la richesse des matériels et leurs
spécificités, je ne garantis pas que ce « mode d'emploi » soit universel.
J'espère néanmoins qu'il vous aura aidé en première approche à monter votre
propre point d'accès Wifi.</p>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posté dans «<a href="https://www.dericbourg.net/category/blog.html">Blog</a>» 
            par <a href="https://www.dericbourg.net/author/alban-dericbourg.html">Alban Dericbourg</a><br />
            Mots-clés:  #<a href="https://www.dericbourg.net/tag/wifi.html">wifi</a> #<a href="https://www.dericbourg.net/tag/raspberrypi.html">raspberrypi</a> #<a href="https://www.dericbourg.net/tag/linux.html">linux</a> #<a href="https://www.dericbourg.net/tag/iptables.html">iptables</a>        </div>
      </footer>
      <hr />
      <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dericbourg'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </article> <!-- /#page-main -->

        <aside id="page-side">
          <!-- begin includes/sidebar.html -->
          <nav>
            <h3>Liens</h3>
            <ul>
              <li><a href="https://github.com/adericbourg">GitHub</a></li>
              <li><a href="https://www.linkedin.com/in/adericbourg/">LinkedIn</a></li>
              <li><a href="https://twitter.com/adericbourg">Twitter</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
      </footer>
    </div> <!-- /#page -->
  </body>
</html>