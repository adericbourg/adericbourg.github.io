<!DOCTYPE html>
<html lang="fr">
<head>

        <title>Pourquoi ce blog ne tourne-t-il pas sur un Raspberry Pi ? - Blog bloquant</title>
        <meta charset="utf-8" />
        <link href="http://www.dericbourg.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blog bloquant Full Atom Feed" />
        <link href="http://www.dericbourg.net/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="Blog bloquant Categories Atom Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="http://www.dericbourg.net/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="http://www.dericbourg.net/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="http://www.dericbourg.net/theme/pygment.css" />

        <script src="http://www.dericbourg.net/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="http://www.dericbourg.net/">Blog bloquant <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="http://www.dericbourg.net/">Accueil</a></li>

              </ul>


            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">Pourquoi ce blog ne tourne-t-il pas sur un Raspberry Pi ?</h2>
           
              <div>
                    <a class="info label" href="http://www.dericbourg.net/tag/blog.html">blog</a>
                    <a class="info label" href="http://www.dericbourg.net/tag/python.html">python</a>
                    <a class="info label" href="http://www.dericbourg.net/tag/pelican.html">pelican</a>
                    <a class="info label" href="http://www.dericbourg.net/tag/git.html">git</a>
                    <a class="info label" href="http://www.dericbourg.net/tag/github.html">github</a>
              </div>
            </header>
            <footer class="post-info">

              <abbr class="published" title="2015-06-23T00:00:00+02:00">
                mar. 23 juin 2015
              </abbr>
              &ndash;
              <a href="http://www.dericbourg.net/drafts/pourquoi-ce-blog-ne-tourne-t-il-pas-sur-un-raspberry-pi.html" rel="bookmark" title="Lien permanent vers Pourquoi ce blog ne tourne-t-il pas sur un Raspberry Pi ?">lien permanent</a>
              <address class="vcard author">Par 
                <a class="url fn" href="http://www.dericbourg.net/author/alban-dericbourg.html"> Alban Dericbourg</a>
              </address>

            </footer><!-- /.post-info -->
            <div class="entry-content">
              <p>Bien qu'il soit très simple, monter ce blog m'a demandé un certain temps. Quel moteur utiliser ? Où l'héberger ? La plus grande difficulté n'a, finalement, pas été le choix à proprement parler mais le choix parmi les <em>nombreux</em> choix possibles. Sans savoir si j'avais l'engagement, la motivation et l'assiduité nécessaire à l'alimenter tant qualitativement que quantitativement, je me suis posé la contrainte d'un coût nul ou minime et d'un investissement en temps minimal.</p>
<h3>Première intuition</h3>
<p>À force de parler d’auto-hébergement, pourquoi déléguer ça un autre quand je peux le faire chez moi et garder la main sur mes données ?, je ne pouvais pas ne pas ne serait-ce qu’essayer au moment d’ouvrir ce blog. Ayant un Raspberry Pi qui dormait dans un coin de mon bureau, j’ai décidé de le mettre à contribution.</p>
<p>Spontanément, je me suis tourné vers le « classique » <a href="https://fr.wordpress.org/">Wordpress</a> que j'avais l'habitude d'utiliser. En estimant la charge à deux visiteurs par jour (en comptant les robots) en moyenne et dix si je tweete un aricle, autrement dit, en estimant que la machine ne ferait rien la plupart du temps et servirait une requête de temps en temps, elle tiendrait la charge. Je ne suis pas développeur PHP et j'ai une mauvaise intuition.</p>
<p>Si l'on résume l'ensemble :</p>
<ul>
<li><a href="https://www.raspbian.org/">Raspbian</a> (dérivé de Debian pour Raspberry Pi) ;</li>
<li>Apache httpd avec le module PHP5 ;</li>
<li>MySQL ;</li>
<li>WordPress.</li>
</ul>
<h3>Au démoulage</h3>
<p>Si l'on mesure naïvement le temps de chargement d'une page, on obtient :</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 10<span class="k">)</span><span class="p">;</span> <span class="k">do</span> curl -o /dev/null -s -w %<span class="o">{</span>time_total<span class="o">}</span><span class="se">\\</span>n http://blog.dericbourg.net<span class="p">;</span> <span class="k">done</span>
1,661
1,645
1,649
1,653
1,648
1,635
1,644
1,645
1,671
1,645
</pre></div>


<p>On ne peut pas dire que les performances soient satisfaisantes : servir une page demande plus d'une seconde et demie.</p>
<p>La mesure a été réalisée en local pour ne bien mesurer que les performances de la machine et éviter autant que possible les latences réseau (même si je suis derrière une box fibre).</p>
<p>Détaillons la temporalité de la requête en affichant :</p>
<ul>
<li>la durée de résolution du nom de domaine <code>time_namelookup</code> ;</li>
<li>la durée d'établissement de la connextion TCP <code>time_connect</code> ;</li>
<li>la durée d'attente avant que le transfert ne se lance effectivement <code>time_pretransfer</code> ;</li>
<li>la durée d'attente du premier octet, <code>time_starttransfer</code>, qui inclut la durée d'attente du lancement du transfert (valeur précédente) et le temps nécessaire au serveur à calculer le résultat.</li>
</ul>
<p>On obtient, en ajoutant en dernière colonne le temps total :</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 10<span class="k">)</span><span class="p">;</span> <span class="k">do</span> curl -o /dev/null -s -w %<span class="o">{</span>time_namelookup<span class="o">}</span><span class="se">\\</span>t%<span class="o">{</span>time_connect<span class="o">}</span><span class="se">\\</span>t%<span class="o">{</span>time_pretransfer<span class="o">}</span><span class="se">\\</span>t%<span class="o">{</span>time_starttransfer<span class="o">}</span><span class="se">\\</span>t<span class="se">\\</span>t%<span class="o">{</span>time_total<span class="o">}</span><span class="se">\\</span>n http://blog.dericbourg.net<span class="p">;</span> <span class="k">done</span>
0,012   0,021   0,021   1,651           1,653
0,004   0,027   0,027   1,647           1,648
0,004   0,020   0,020   1,659           1,660
0,004   0,017   0,017   1,651           1,652
0,004   0,017   0,017   1,653           1,654
0,004   0,016   0,016   1,648           1,649
0,004   0,025   0,025   1,656           1,658
0,004   0,016   0,017   1,648           1,649
0,004   0,013   0,013   1,636           1,639
0,012   0,022   0,022   1,648           1,649
</pre></div>


<p>C'est donc le calcul du résultat qui est le plus coûteux en temps. Cela inclut l'interprétation du PHP mais également l'ensemble des requêtes en base.</p>
<h3>Nginx, par curiosité</h3>
<p>Réalisons la même mesure sur <a href="http://nginx.org/">Nginx</a> utilisant <a href="http://php-fpm.org/">php5-fpm</a>. On obtient :</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 10<span class="k">)</span><span class="p">;</span> <span class="k">do</span> curl -o /dev/null -s -w %<span class="o">{</span>time_namelookup<span class="o">}</span><span class="se">\\</span>t%<span class="o">{</span>time_connect<span class="o">}</span><span class="se">\\</span>t%<span class="o">{</span>time_pretransfer<span class="o">}</span><span class="se">\\</span>t%<span class="o">{</span>time_starttransfer<span class="o">}</span><span class="se">\\</span>t<span class="se">\\</span>t%<span class="o">{</span>time_total<span class="o">}</span><span class="se">\\</span>n http://blog.dericbourg.net<span class="p">;</span> <span class="k">done</span>
0,012   0,021   0,021   1,491           1,498
0,004   0,017   0,017   1,467           1,468
0,004   0,017   0,017   1,490           1,494
0,004   0,013   0,013   1,471           1,473
0,004   0,014   0,014   1,463           1,464
0,004   0,014   0,014   1,488           1,489
0,004   0,016   0,016   1,480           1,482
0,004   0,014   0,014   1,465           1,466
0,004   0,018   0,018   1,489           1,492
0,004   0,018   0,018   1,485           1,487
</pre></div>


<p>On reste sur le même ordre de grandeur en gagnant malgré tout 10% : rien de significatif. La durée de calcul de la page est toujours trop importante. À ce stade, on ne peut pas conclure grand chose pour autant :</p>
<ul>
<li>soit les modules d'interprétation de PHP ont des performances similaires ;</li>
<li>soit l'essentiel du temps consommé est ailleurs.</li>
</ul>
<p>$ ps -eo pid,bsdtime,pcpu,comm|grep 'mysql\|php\|nginx'
 4058   0:00  0.1 mysqld_safe
 4397   0:02  1.8 mysqld
 4583   0:00  0.0 nginx
 4584   0:00  0.0 nginx
 4626   0:00  0.0 php5-fpm
 4627   0:10 10.6 php5-fpm
 4628   0:07  7.8 php5-fpm</p>
<p>bsdtime     TIME      accumulated cpu time, user + system.  The display format is usually "MMM:SS", but can be shifted to the right if the process used more than 999 minutes of cpu time.
 comm        COMMAND   command name (only the executable name).
 cputime     TIME      cumulative CPU time, "[DD-]hh:mm:ss" format.  (alias time)
 pcpu        %CPU      see %cpu.  (alias %cpu).</p>
<p>Creuser aussi <code>pidstat -dl 1</code> (IO / process), plus <code>iotop</code>
Attente des IO (nombre de ticks) : https://serverfault.com/questions/169676/howto-check-disk-i-o-utilisation-per-process</p>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "drafts/pourquoi-ce-blog-ne-tourne-t-il-pas-sur-un-raspberry-pi.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://dericbourg.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns">

      <div class="btn primary"><a href="https://github.com/adericbourg" target="_blank">Github</a></div>

      <div class="btn twitter"><a href="https://twitter.com/adericbourg" target="_blank">Twitter</a></div>



<!--
<h4>Pages</h4>

 <ul>
  </ul>

<h4>Catégories</h4>
<ul>
		<li><a href="http://www.dericbourg.net/category/blog.html">Blog</a></li>
</ul>

-->
<h4>Tags</h4>
	<ul id="sidebar-tags">
</ul>



</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'dericbourg';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="http://www.dericbourg.net/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://www.dericbourg.net/theme/js/libs/gumby.min.js"></script>
  <script src="http://www.dericbourg.net/theme/js/plugins.js"></script>
</body>
</html>