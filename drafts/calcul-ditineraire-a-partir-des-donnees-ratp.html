<!DOCTYPE html>
<!--[if IE 6]>
<html class="ie6" lang="fr" prefix="og: http://ogp.me/ns#">
<![endif]-->
<!--[if IE 7]>
<html class="ie7" lang="fr" prefix="og: http://ogp.me/ns#">
<![endif]-->
<!--[if IE 8]>
<html class="ie8" lang="fr" prefix="og: http://ogp.me/ns#">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="fr" prefix="og: http://ogp.me/ns#" itemscope itemtype="http://schema.org/Blog">
<!--<![endif]-->
<head>
        <meta charset="utf-8" />
        <title>Calcul d'itinéraire à partir des données RATP - Blog bloquant</title>
        <link href="http://www.dericbourg.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blog bloquant Full Atom Feed" />
        <link href="http://www.dericbourg.net/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="Blog bloquant Categories Atom Feed" />

        <!-- Twitter card -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@adericbourg" />
        <meta name="twitter:creator" content="@adericbourg" />
        <meta name="twitter:title" content="Calcul d'itinéraire à partir des données RATP - Blog bloquant" />
        <meta name="twitter:description" content="La RATP progresse dans l'ouverture de ses données et même si elle ne propose pas encore un accès à son système SIEL, elle propose néanmoins les données de son offre de transport au format GTFS. Une bonne occasion de s'initier au calcul d'itinéraire ! Format des données Le ..." />
        <meta name="twitter:domain" content="http://www.dericbourg.net/drafts/calcul-ditineraire-a-partir-des-donnees-ratp.html" />

        <!-- Facebook Open Graph Meta Tags -->
        <meta property="og:site_name" content="Blog bloquant"/>
        <meta property="og:title" content="Calcul d'itinéraire à partir des données RATP"/>
        <meta property="og:url" content="http://www.dericbourg.net/drafts/calcul-ditineraire-a-partir-des-donnees-ratp.htmlindex.html"/>
        <meta property="og:description" content="La RATP progresse dans l'ouverture de ses données et même si elle ne propose pas encore un accès à son système SIEL, elle propose néanmoins les données de son offre de transport au format GTFS. Une bonne occasion de s'initier au calcul d'itinéraire ! Format des données Le ..."/>
        <meta property="og:type" content="blog"/>

        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="http://www.dericbourg.net/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="http://www.dericbourg.net/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="http://www.dericbourg.net/theme/pygment.css" />

        <script src="http://www.dericbourg.net/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="http://www.dericbourg.net/">Blog bloquant <strong></strong></a></h1>

          </header><!-- /#banner -->

          <div class="right">
                <div class="btn primary"><a href="https://github.com/adericbourg" target="_blank">Github</a></div>

                <div class="btn twitter"><a href="https://twitter.com/adericbourg" target="_blank">Twitter</a></div>


          </div>

            <div id="navigation" class="navbar row">

              <a href="#" data-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

              <ul class="columns">
                <li><a href="http://www.dericbourg.net/">Accueil</a></li>

              </ul>

            </div>

<section id="content" class="body">

   <div class="row">
        <div class="columns">


            <header>
              <h2 class="entry-title">Calcul d'itinéraire à partir des données RATP</h2>
           
              <div>
                    <a class="info label" href="http://www.dericbourg.net/tag/opendata.html">opendata</a>
                    <a class="info label" href="http://www.dericbourg.net/tag/ratp.html">ratp</a>
              </div>
            </header>
            <footer class="post-info">

              <abbr class="published" title="2015-09-12T00:00:00+02:00">
                sam. 12 septembre 2015
              </abbr>
              &ndash;
              <a href="http://www.dericbourg.net/drafts/calcul-ditineraire-a-partir-des-donnees-ratp.html" rel="bookmark" title="Lien permanent vers Calcul d'itinéraire à partir des données RATP">lien permanent</a>
              <address class="vcard author">Par
                <a class="url fn" href="http://www.dericbourg.net/author/alban-dericbourg.html"> Alban Dericbourg</a>
              </address>

            </footer><!-- /.post-info -->
            <div class="entry-content">
              <p>La RATP progresse dans l'<a href="http://data.ratp.fr">ouverture de ses données</a> et même si elle ne propose pas encore un accès à son <a href="https://fr.wikipedia.org/wiki/Syst%C3%A8me_d'information_en_ligne">système SIEL</a>, elle propose néanmoins les données de son offre de transport au <a href="https://developers.google.com/transit/gtfs/">format GTFS</a>. Une bonne occasion de s'initier au calcul d'itinéraire !</p>
<h3>Format des données</h3>
<p>Le format GTFS est un standard et la RATP se conforme à ce standard, simple et bien documenté. Nous n'en retiendrons que certains en première approche.</p>
<h4>routes.txt</h4>
<p>Le fichier décrit le nom et la direction des routes. Une route est assimilable à un trajet (origine - destination).</p>
<p>Prenons l'exemple de la ligne 13 du métro parsien dont le plan simplifié est représenté sur la figure ci-dessous. Cette ligne est parcourue par quatre routes :</p>
<ul>
<li>Châtillon - Montrouge en direction de Saint-Denis Université ;</li>
<li>Châtillon - Montrouge en direction de Gennevilliers Les Courtilles ;</li>
<li>Saint-Denis Université en direction de Châtillon - Montrouge ;</li>
<li>Gennevilliers Les Courtilles en direction de Châtillon - Montrouge.</li>
</ul>
<p><img alt="Plan simplifié de la ligne 13 du métro parisien" class="center" src="/images/connection_scan_algorithm/ligne13.png" /></p>
<p>Le fichier <code>routes.txt</code> contient pour cette ligne :</p>
<div class="highlight"><pre>route_id<span class="p">,</span>agency_id<span class="p">,</span>route_short_name<span class="p">,</span>route_long_name<span class="p">,</span>route_desc<span class="p">,</span>route_type<span class="p">,</span>route_url<span class="p">,</span>route_color<span class="p">,</span>route_text_color
<span class="m">1197620</span><span class="p">,</span><span class="m">100</span><span class="p">,</span><span class="s">&quot;13&quot;</span><span class="p">,</span><span class="s">&quot;(CHATILLON - MONTROUGE &lt;-&gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Aller&quot;</span><span class="p">,,</span><span class="m">1</span><span class="p">,,</span>FFFFFF<span class="p">,</span><span class="m">000000</span>
<span class="m">1197621</span><span class="p">,</span><span class="m">100</span><span class="p">,</span><span class="s">&quot;13&quot;</span><span class="p">,</span><span class="s">&quot;(CHATILLON - MONTROUGE &lt;-&gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Aller&quot;</span><span class="p">,,</span><span class="m">1</span><span class="p">,,</span>FFFFFF<span class="p">,</span><span class="m">000000</span>
<span class="m">1197622</span><span class="p">,</span><span class="m">100</span><span class="p">,</span><span class="s">&quot;13&quot;</span><span class="p">,</span><span class="s">&quot;(CHATILLON - MONTROUGE &lt;-&gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Retour&quot;</span><span class="p">,,</span><span class="m">1</span><span class="p">,,</span>FFFFFF<span class="p">,</span><span class="m">000000</span>
<span class="m">1197623</span><span class="p">,</span><span class="m">100</span><span class="p">,</span><span class="s">&quot;13&quot;</span><span class="p">,</span><span class="s">&quot;(CHATILLON - MONTROUGE &lt;-&gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Retour&quot;</span><span class="p">,,</span><span class="m">1</span><span class="p">,,</span>FFFFFF<span class="p">,</span><span class="m">000000</span>
</pre></div>


<h4>stops.txt</h4>
<p>Ce fichier liste les arrêts avec, éventuellement, quelques informations complémentaires. La RATP fournit l'adresse la plus proche de l'arrêt ainsi que les coordonnées GPS de son centre (dans le cas d'une station qui dispose de plusieurs sorties). À noter que ce fichier n'est pas ordonné selon le sens de parcours des missions sur la ligne.</p>
<p>Exemple des quatre premières stations de la ligne 13 :</p>
<div class="highlight"><pre>stop_id,stop_code,stop_name,stop_desc,stop_lat,stop_lon,location_type,parent_station
2397,,&quot;Pernety&quot;,&quot;Raymond Losserand (72 rue) - 75114&quot;,48.833933819810916,2.31790897216328,0,
1969,,&quot;Châtillon Montrouge&quot;,&quot;République (220 avenue de la) - 92020&quot;,48.810283363510756,2.3012888709759522,0,
2406,,&quot;Place de Clichy&quot;,&quot;Clichy (terre-plein face au 7 place de) - 75109&quot;,48.883203999876585,2.3272660246411383,0,
...
</pre></div>


<h4>trips.txt</h4>
<p>Ce fichier liste les courses et les associe à une route. Nous reviendrons sur son utilité en observant les horaires d'arrêt.</p>
<p>Exemple sur la ligne 13 :</p>
<div class="highlight"><pre>route_id,service_id,trip_id,trip_headsign,trip_short_name,direction_id,shape_id
1197620,1762288,10017622880912413,101,101,0,
1197620,1762289,10017622890912413,101,101,0,
1197620,1762292,10017622920912413,101,101,0,
...
</pre></div>


<h4>stops_times.txt</h4>
<p>Ce fichier présente les horaires des courses aux stations (points d'arrêt). Ce fichier est trié par course et par heure d'arrêt en station.</p>
<p>Un détail est à noter quant aux horaires : ceux-ci sont fournis pour la journée qui peut se terminer... le lendemain. Un métro circulant le dimanche à 1h du matin sera en réalité rattaché à la journée du samedi. Ainsi, son horaire ne sera pas « à 1h le dimanche» mais « à 25h le samedi ». Bien que cette astuce puisse sembler tordue, elle simplifie en pratique beaucoup de choses, notamment pour maintenir la continuité des missions : il serait absurde de scinder la mission d'un train sous prétexte qu'il roule à cheval sur deux jours calendaires.</p>
<p>Exemple pour la ligne 13 :</p>
<div class="highlight"><pre>trip_id,arrival_time,departure_time,stop_id,stop_sequence,stop_headsign,shape_dist_traveled
10017622880912413,19:38:00,19:38:00,1969,1,,
10017622880912413,19:40:00,19:40:00,1880,2,,
10017622880912413,19:41:00,19:41:00,1879,3,,
</pre></div>


<p>Dans cet exemple, pour la course présentée, le véhicule s'arrête à 19:38:00 à l'arrêt 1969 (Châtillon - Montrouge) et en repart à la même heure. On en déduira qu'on ne prend vraisemblabement pas en compte le temps d'arrêt en station. Il arrive ensuite à la station 1880 (Malakoff - Rue Etienne Dolet) à 19:40:00, puis à la station 1879 (Malakoff - Plateau de Vanves) à 19:41:00, etc.</p>
<h4>transfers.txt</h4>
<p><code>transfers.txt</code> regroupe les correspondances entre plusieurs points d'arrêt.</p>
<p>Pour prendre un exemple :</p>
<div class="highlight"><pre>from_stop_id,to_stop_id,transfer_type,min_transfer_time
4211780,2270,2,212
4472773,1724,2,228
3619167,2276,2,252
</pre></div>


<p>Prenons la première ligne : la correspondance se fait entre l'arrêt « 4211780 » et l'arrêt « 2270 ». Un recherche dans le fichier <code>stops.txt</code> permet de donner un nom humainement compréhensible à ces identifiants : ils correspondent ici tous les deux au point d'arrêt « Mairie de Saint-Ouen ».</p>
<p>À partir du l'identifiant d'un point d'arrêt, on peut également ressortir les identifiants de course (<code>trip_id</code>). Prenons-en un au hasard :</p>
<div class="highlight"><pre><span class="nv">$ </span>grep <span class="m">2270</span> stop_times.txt <span class="p">|</span> cut -d, -f1 <span class="p">|</span> head -n1
10017622880912417
</pre></div>


<p>À partir de cet identifiant, on peut retrouver la route associée (<code>route_id</code>) :</p>
<div class="highlight"><pre><span class="nv">$ </span>grep <span class="m">10017622880912417</span> trips.txt <span class="p">|</span> cut -d, -f1
1197623
</pre></div>


<p>On trouve donc qu'il s'agissait (encore...) de la ligne 13 dans le sens « retour » :</p>
<div class="highlight"><pre><span class="nv">$ </span>grep ^1197623, routes.txt
1197623,100,<span class="s2">&quot;13&quot;</span>,<span class="s2">&quot;(CHATILLON - MONTROUGE &lt;-&gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Retour&quot;</span>,,1,,FFFFFF,000000
</pre></div>


<p>Vérifions par acquit de conscience l'autre identifiant de point d'arrêt :</p>
<div class="highlight"><pre><span class="nv">$ </span>grep <span class="m">4211780</span> stop_times.txt <span class="p">|</span> cut -d, -f1 <span class="p">|</span> head -n1
119841521246955
<span class="nv">$ </span>grep <span class="m">119841521246955</span> trips.txt
1364288,1984152,119841521246955,,1,1,
<span class="nv">$ </span>grep <span class="m">1364288</span> routes.txt
1364288,100,<span class="s2">&quot;N44&quot;</span>,<span class="s2">&quot;(GARGES-SARCELLES RER &lt;-&gt; GARE DE L&#39;EST) - Retour&quot;</span>,,3,,FFFFFF,000000
</pre></div>


<p>Il s'agit donc du <a href="http://www.ratp.fr/informer/pdf/orienter/f_horaire.php?fm=gif&amp;loc=noctilien&amp;nompdf=n44">Noctilien N44</a> qui passe effectivement par « Mairie de Saint-Ouen ». La boucle est bouclée.</p>
<h3>Calcul d'itinéraire</h3>
<p>L'histoire et le contexte des calculs d'itinéraires est très bien synthétisé par <a href="https://twitter.com/tristramg">Tristram Gräbener</a> dans son <a href="http://blog.tristramg.eu/petit-historique-du-calcul-ditineraire.html">Petit historique du calcul d'itinéraire</a>. Probablement plus hipster que je ne veux bien l'admettre, j'ai choisi d'utiliser le plus récent : le <em><a href="http://i11www.iti.uni-karlsruhe.de/extra/publications/dpsw-isftr-13.pdf">Connection Scan Algorithm</a></em>.</p>
<p>Cet algorithme, tenant en quelques lignes, se « contente » de parcourir une table horaire précalculée des connexions entre les stations et de retenir la solution optimale en temps de trajet. Une connexion représente une possibilité de trajet entre deux stations. On la modélise donc par un quadruplet contenant la station de départ, la station d'arrivée, l'heure de départ et l'heure d'arrivée. La table horaire devient alors simplement une liste de ces connexions triées par heure de départ croissante.</p>
<h4>Alimentation des données : parsing des fichiers GTFS</h4>
<p>Les fichiers GTFS, bien que portant l'extension <code>.txt</code> sont manipulables commes des fichiers CSV. Dans la suite, on utilisera des structures qui sont (presque) calquées sur le format de ces fichiers.</p>
<p>Sur le principe, leur parsing est immédiat. Prenons par exemple le cas des routes (on utilise ici <a href="https://github.com/tototoshi/scala-csv">scala-csv</a>) :</p>
<div class="highlight"><pre><span class="k">import</span> <span class="nn">com.github.tototoshi.csv._</span>
<span class="k">val</span> <span class="n">routes</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Route</span><span class="o">]</span> <span class="k">=</span> <span class="nc">CSVReader</span><span class="o">.</span>
  <span class="n">open</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">&quot;routes.txt&quot;</span><span class="o">)).</span>
  <span class="n">allWithHeaders</span><span class="o">().</span>
  <span class="n">map</span><span class="o">(</span><span class="nc">Route</span><span class="o">.</span><span class="n">parse</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Route</span><span class="o">(</span><span class="n">routeId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">routeShortName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">routeLongName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">routeDesc</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">Route</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">parse</span><span class="o">(</span><span class="n">fields</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Route</span><span class="o">(</span>
      <span class="n">fields</span><span class="o">(</span><span class="s">&quot;route_id&quot;</span><span class="o">).</span><span class="n">toLong</span><span class="o">,</span>
      <span class="n">fields</span><span class="o">(</span><span class="s">&quot;route_short_name&quot;</span><span class="o">),</span>
      <span class="n">fields</span><span class="o">(</span><span class="s">&quot;route_long_name&quot;</span><span class="o">),</span>
      <span class="n">fields</span><span class="o">(</span><span class="s">&quot;route_desc&quot;</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Dans la pratique, la volumétrie des horaires des courses rend l'opération plus complexe :</p>
<div class="highlight"><pre><span class="nv">$ </span>wc -l *
        <span class="m">2</span> agency.txt
    <span class="m">65937</span> calendar_dates.txt
     <span class="m">4578</span> calendar.txt
     <span class="m">1067</span> routes.txt
    <span class="m">26653</span> stops.txt
 <span class="m">10402381</span> stop_times.txt
    <span class="m">80338</span> transfers.txt
   <span class="m">417920</span> trips.txt
</pre></div>


<p>Pour simplifier la suite de cet article, nous ne traiterons que les lignes de métro et les lignes de RER exploitées par la RATP. On parsera les données ligne par ligne dans la structure <code>GtfsData</code> pour ensuite les fusionner :</p>
<div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">GtfsData</span><span class="o">(</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">routes</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Route</span><span class="o">],</span>
  <span class="n">trips</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Trip</span><span class="o">],</span>
  <span class="n">stops</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Stop</span><span class="o">],</span>
  <span class="n">stopTimes</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">StopTime</span><span class="o">],</span>
  <span class="n">transfers</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Transfer</span><span class="o">]</span>
<span class="o">)</span>

<span class="c1">// Fusion des données de ligne</span>
<span class="k">val</span> <span class="n">gtfsData</span> <span class="k">=</span> <span class="nc">GtfsData</span><span class="o">(</span>
  <span class="s">&quot;RATP&quot;</span><span class="o">,</span>
  <span class="n">lines</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">routes</span><span class="o">),</span>
  <span class="n">lines</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">trips</span><span class="o">),</span>
  <span class="n">lines</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">stops</span><span class="o">),</span>
  <span class="n">lines</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">stopTimes</span><span class="o">),</span>
  <span class="n">lines</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">transfers</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>


<h4>Construction de la table horaire</h4>
<p>La table horaire est, comme nous l'avons vu, une séquence de connexions modélisées par des quadruplets contenants chacun la station de départ, la station d'arrivée, l'heure de départ et l'heure d'arrivée.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">Timetable</span><span class="o">(</span><span class="n">connections</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Connection</span><span class="o">])</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Connection</span><span class="o">(</span>
  <span class="n">departureStation</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
  <span class="n">arrivalStation</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
  <span class="n">departureTimestamp</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
  <span class="n">arrivalTimestamp</span><span class="k">:</span> <span class="kt">Int</span>
<span class="o">)</span>
</pre></div>


<p>Sa construction se fait en deux étapes :</p>
<ol>
<li>en ingérant les connexions issues des courses (successions de points d'arrêts sur une même ligne) ;</li>
<li>en ingérant les connexions issues des correspondances (« ponts » entre les courses).</li>
</ol>
<h5>Connexions issues des courses</h5>
<p>On ingère les horaires des courses en les groupant par... course et en prenant soin de ne pas « mélanger » les horaires de deux courses. Prenons l'exemple ci-dessous : les ceux courses fréquentent la même ligne mais ne s'arrêtent pas aux mêmes arrêts. Il n'y a pas de correspondance entre les deux.</p>
<div class="highlight"><pre> Course I : A (t1) --------------------&gt; B (t3)
Course II :               C (t2) --------------------&gt; D (t4)
</pre></div>


<p>Le fichier <code>stop_times.txt</code> ressemblerait à :</p>
<div class="highlight"><pre>trip_id,arrival_time,departure_time,stop_id,stop_sequence,stop_headsign,shape_dist_traveled
I, t1, t1, A, 1, ,
II, t2, t2, C, 1, ,
I, t3, t3, B, 1, ,
II, t4, t4, D, 1, ,
</pre></div>


<p>Une lecture indépendante de l'identifiant de course (<code>trip_id</code>) amalgamerait donc ces deux courses et induirait de fausses correspondances.</p>
<p>La création de la table horaire se fait en groupant deux à deux les horaires d'arrêt au sein d'une même course. Pour chaque élément à l'indice <code>i</code>, on créera une connexion partant de l'arrêt à cet indice et arrivant à l'arrêt de l'indice <code>i+1</code>. On implémente cette construction avec une fonction récursive qui dépile un à un les horaires de course.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">connectionsFromStopTimes</span> <span class="k">=</span> <span class="n">gtfsData</span><span class="o">.</span>
  <span class="n">stopTimesByTripId</span><span class="o">.</span>
  <span class="n">values</span><span class="o">.</span>
  <span class="n">flatMap</span><span class="o">(</span><span class="n">stopTimesToConnections</span><span class="o">)</span>

<span class="k">def</span> <span class="n">stopTimesToConnections</span><span class="o">(</span><span class="n">stopTimes</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">StopTime</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Connection</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nd">@tailrec</span>
  <span class="k">def</span> <span class="n">loop</span><span class="o">(</span><span class="n">stopTimes</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">StopTime</span><span class="o">],</span> <span class="n">connections</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Connection</span><span class="o">])</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Connection</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">stopTimes</span> <span class="k">match</span> <span class="o">{</span>
      <span class="c1">// Aucun horaire (n&#39;arrive que si la collection initiale est vide).</span>
      <span class="c1">// On n&#39;a rien à faire de plus, on retourne les connexions (vides).</span>
      <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="n">connections</span>
      <span class="c1">// Dernier horaire : il est connecté au précédent et n&#39;ira pas plus loin.</span>
      <span class="c1">// On en a terminé et on retourne les connexions.</span>
      <span class="k">case</span> <span class="n">head</span> <span class="o">::</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="n">connections</span>
      <span class="c1">// Cas général : il reste des stations après la première de la collection.</span>
      <span class="c1">// On créé une connexion entre celle-ci et la première des suivantes.</span>
      <span class="k">case</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">departureStop</span> <span class="k">=</span> <span class="n">head</span><span class="o">.</span><span class="n">stopId</span><span class="o">.</span><span class="n">toInt</span>
        <span class="k">val</span> <span class="n">arrivalStop</span> <span class="k">=</span> <span class="n">tail</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">stopId</span><span class="o">.</span><span class="n">toInt</span>
        <span class="k">val</span> <span class="n">departureTime</span> <span class="k">=</span> <span class="n">durationToTimestamp</span><span class="o">(</span><span class="n">head</span><span class="o">.</span><span class="n">departureTime</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">arrivalTime</span> <span class="k">=</span> <span class="n">durationToTimestamp</span><span class="o">(</span><span class="n">tail</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">departureTime</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">connection</span> <span class="k">=</span> <span class="nc">Connection</span><span class="o">(</span><span class="n">departureStop</span><span class="o">,</span> <span class="n">arrivalStop</span><span class="o">,</span> <span class="n">departureTime</span><span class="o">,</span> <span class="n">arrivalTime</span><span class="o">)</span>
        <span class="c1">// Étape suivante de la récursion</span>
        <span class="n">loop</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">connections</span> <span class="o">:+</span> <span class="n">connection</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// Initialisation de la récursion</span>
  <span class="n">loop</span><span class="o">(</span><span class="n">stopTimes</span><span class="o">.</span><span class="n">toList</span><span class="o">,</span> <span class="nc">List</span><span class="o">())</span>
<span class="o">}</span>
</pre></div>


<p>Dans cet exemple de code, la fonction <code>durationToTimestamp</code> retourne un timestamp correspondant à l'heure effective pour la journée en cours à partir de l'heure seule fournie dans les données. Par exemple, le 01/01/2016, la durée <code>19h32min27s</code> permettra d'obtenir le timestamp équivalent à <code>2016-01-01T19:32:27.0Z</code>.</p>
<h5>Connexions issues des correspondances</h5>
<p>Le fichier <code>transfers.txt</code> nous donne les correspondances disponibles sur une ligne. L'objectif de cette étape est de :</p>
<ul>
<li>ne conserver que les correspondances de notre réseau (dans cet exemple, nous ne travaillons pas sur les bus, on les éliminera donc) ;</li>
<li>créer toutes les entrées de la table horaire correspondant à cette correspondance.</li>
</ul>
<p>Le filtrage des correspondances est aisé avec notre structure de données. Nous disposons déjà de l'ensemble des stations du réseau. Il nous suffit de vérifier que ces correspondances ont lieu entre deux stations du réseau.</p>
<div class="highlight"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">GtfsData</span><span class="o">(...)</span> <span class="o">{</span>
  <span class="c1">// Indexation des stations du réseau</span>
  <span class="k">val</span> <span class="n">stopsByStopId</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Stop</span><span class="o">]</span> <span class="k">=</span> <span class="n">stops</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">stop</span> <span class="k">=&gt;</span> <span class="n">stop</span><span class="o">.</span><span class="n">stopId</span> <span class="o">-&gt;</span> <span class="n">stop</span><span class="o">)(</span><span class="n">collection</span><span class="o">.</span><span class="n">breakOut</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">filteredTransfers</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Transfer</span><span class="o">]</span> <span class="k">=</span> <span class="n">gtfsData</span><span class="o">.</span><span class="n">transfers</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">transfer</span> <span class="k">=&gt;</span>
  <span class="c1">// Filtrage des correspondances avec des stations hors du réseau</span>
  <span class="n">gtfsData</span><span class="o">.</span><span class="n">stopsByStopId</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">transfer</span><span class="o">.</span><span class="n">fromStopId</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
    <span class="n">gtfsData</span><span class="o">.</span><span class="n">stopsByStopId</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">transfer</span><span class="o">.</span><span class="n">toStopId</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>


<p>Cela étant fait, pour chacune de ces correspondances, on créé dans la table horaire une connexion correspondant à chaque horaire de passage à cette station. On utilisera pour cela les données issues de <code>stop_times.txt</code>.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="n">transfersToConnections</span><span class="o">(</span><span class="n">filteredTransfers</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Transfer</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Connection</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nd">@tailrec</span>
  <span class="k">def</span> <span class="n">loop</span><span class="o">(</span><span class="n">transfers</span><span class="k">:</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">Transfer</span><span class="o">],</span> <span class="n">connections</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Connection</span><span class="o">])</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Connection</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">transfers</span> <span class="k">match</span> <span class="o">{</span>
      <span class="c1">// Aucune correspondance à traiter. On en a terminé et on sort avec</span>
      <span class="c1">// la liste construite jusqu&#39;ici.</span>
      <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="n">connections</span>
      <span class="c1">// Il reste au moins une correspondance à traiter (tail peut être Nil).</span>
      <span class="k">case</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">departureStop</span> <span class="k">=</span> <span class="n">head</span><span class="o">.</span><span class="n">fromStopId</span>
        <span class="k">val</span> <span class="n">arrivalStop</span> <span class="k">=</span> <span class="n">head</span><span class="o">.</span><span class="n">toStopId</span>
        <span class="c1">// Pour chaque horaire de train à cette station, on créé</span>
        <span class="c1">// une entrée dans la table horaire.</span>
        <span class="k">val</span> <span class="n">transferConnections</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Connection</span><span class="o">]</span> <span class="k">=</span> <span class="n">gtfsData</span><span class="o">.</span>
          <span class="n">stopTimesByStopId</span><span class="o">(</span><span class="n">departureStop</span><span class="o">).</span>
          <span class="n">map</span><span class="o">(</span><span class="n">stopTime</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="k">val</span> <span class="n">connectionDepartureTime</span> <span class="k">=</span> <span class="n">durationToTimestamp</span><span class="o">(</span><span class="n">stopTime</span><span class="o">.</span><span class="n">arrivalTime</span><span class="o">)</span>
            <span class="nc">Connection</span><span class="o">(</span>
              <span class="n">departureStop</span><span class="o">,</span>
              <span class="n">arrivalStop</span><span class="o">,</span>
              <span class="n">connectionDepartureTime</span><span class="o">,</span>
              <span class="n">connectionDepartureTime</span> <span class="o">+</span> <span class="n">head</span><span class="o">.</span><span class="n">minTransferTime</span>
            <span class="o">)</span>
          <span class="o">})</span>
        <span class="c1">// Étape suivante de la récursion.</span>
        <span class="n">loop</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">connections</span> <span class="o">++</span> <span class="n">transferConnections</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// Initialisation de la récursion.</span>
  <span class="n">loop</span><span class="o">(</span><span class="n">filteredTransfers</span><span class="o">.</span><span class="n">toList</span><span class="o">,</span> <span class="nc">List</span><span class="o">())</span>
<span class="o">}</span>
</pre></div>


<h5>Fusion des deux tables horaires</h5>
<p>On a construit jusqu'ici deux tables horaires :</p>
<ul>
<li>l'une issue des horaires des trains en station ;</li>
<li>l'autre issue des correspondances entre les trains.</li>
</ul>
<p>Reste maintenant à fusionner les deux. N'oublions pas que cette table doit être triée par heure de départ croissante. À ce détail près, cette étape est immédiate.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">connectionsFromStopTimes</span> <span class="k">=</span> <span class="n">gtfsData</span><span class="o">.</span>
  <span class="n">stopTimesByTripId</span><span class="o">.</span>
  <span class="n">values</span><span class="o">.</span>
  <span class="n">flatMap</span><span class="o">(</span><span class="n">stopTimesToConnections</span><span class="o">)</span>
<span class="k">val</span> <span class="n">connectionsFromTransfers</span> <span class="k">=</span> <span class="n">transfersToConnections</span><span class="o">(</span><span class="n">gtfsData</span><span class="o">)</span>

<span class="k">val</span> <span class="n">connections</span> <span class="k">=</span> <span class="o">(</span><span class="n">connectionsFromStopTimes</span> <span class="o">++</span> <span class="n">connectionsFromTransfers</span><span class="o">).</span>
  <span class="n">toList</span><span class="o">.</span>
  <span class="n">sortBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">arrivalTimestamp</span><span class="o">)</span>
</pre></div>


<h4>Exploitation de la table horaire : calcul d'itinéraire</h4>
<h5>Explication de l'algorithme</h5>
<blockquote>
<p>TODO</p>
</blockquote>
<h5>Exemple</h5>
<p>Partons d'un trajet entre <a href="http://www.vianavigo.com/fr/itineraire-plan-de-quartier/?criteria=1&amp;mrq=&amp;id=&amp;departure=Maubert+-+Mutualit%C3%A9%2C+Paris&amp;departureType=StopArea&amp;departureCity=Paris&amp;departureCoordX=&amp;departureCoordY=&amp;departureExternalCode=59357&amp;departureCityCode=75000&amp;arrival=Voltaire+%2F+L%C3%A9on+Blum%2C+Paris&amp;arrivalType=StopArea&amp;arrivalCity=Paris&amp;arrivalCityCode=75000&amp;arrivalCoordX=&amp;arrivalCoordY=&amp;arrivalExternalCode=59616&amp;date=25%2F10%2F2015&amp;dateFormat=dd%2FMM%2Fyyyy&amp;sens=1&amp;hour=18&amp;min=00&amp;moreCriterions=true&amp;via=&amp;viaType=&amp;viaCity=&amp;viaCityCode=&amp;viaExternalCode=&amp;_train=on&amp;rer=true&amp;_rer=on&amp;metro=true&amp;_metro=on&amp;_bus=on&amp;_tram=on&amp;walkSpeed=0&amp;spcar=%C3%A2&amp;hpx=1&amp;hat=1&amp;L=0&amp;submitSearchItinerary=&amp;ajid=/stif_web_carto/comp/itinerary/search.html_&amp;_=1445793804586">Maubert-Mutualité et Voltaire</a> en partant à 18h.</p>
<div class="highlight"><pre><span class="k">val</span> <span class="n">maubert</span> <span class="k">=</span> <span class="mi">2350</span>
<span class="k">val</span> <span class="n">voltaireLeonBlum</span> <span class="k">=</span> <span class="mi">1633</span>

<span class="n">csa</span><span class="o">.</span><span class="n">compute</span><span class="o">(</span>
  <span class="n">maubert</span><span class="o">,</span>
  <span class="n">voltaireLeonBlum</span><span class="o">,</span>
  <span class="n">durationToTimestamp</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">ofHours</span><span class="o">(</span><span class="mi">18</span><span class="o">))</span>
<span class="o">)</span>
</pre></div>


<p>On obtient le trajet :</p>
<div class="highlight"><pre>Solution found with 15 connections
  Maubert-Mutualité -&gt; Cluny-La Sorbonne
  Cluny-La Sorbonne -&gt; Odéon
  Odéon -&gt; Odéon
  Odéon -&gt; Saint-Michel
  Saint-Michel -&gt; Cité
  Cité -&gt; Châtelet
  Châtelet -&gt; Les Halles
  Les Halles -&gt; Etienne Marcel
  Etienne Marcel -&gt; Réaumur-Sébastopol
  Réaumur-Sébastopol -&gt; Strasbourg-Saint-Denis
  Strasbourg-Saint-Denis -&gt; Strasbourg-Saint-Denis
  Strasbourg-Saint-Denis -&gt; République
  République -&gt; Oberkampf
  Oberkampf -&gt; Saint-Ambroise
  Saint-Ambroise -&gt; Voltaire (Léon Blum)
Total transit time: 21 minutes
</pre></div>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                  var disqus_shortname = 'dericbourg';
                  (function() {
                      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
              </script>
              <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>


        </div><!-- /.columns -->

<div class="three columns">



<!--
<h4>Pages</h4>

 <ul>
  </ul>

<h4>Catégories</h4>
<ul>
		<li><a href="http://www.dericbourg.net/category/blog.html">Blog</a></li>
</ul>

-->
<!--
<h4>Tags</h4>
	<ul id="sidebar-tags">
</ul>
-->


</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">


        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'dericbourg';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="http://www.dericbourg.net/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://www.dericbourg.net/theme/js/libs/gumby.min.js"></script>
  <script src="http://www.dericbourg.net/theme/js/plugins.js"></script>
</body>
</html>