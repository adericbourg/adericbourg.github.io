<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Blog bloquant</title><link href="https://www.dericbourg.net/" rel="alternate"></link><link href="https://www.dericbourg.net/feeds/all.atom.xml" rel="self"></link><id>https://www.dericbourg.net/</id><updated>2019-08-26T00:00:00+02:00</updated><entry><title>J'ai (enfin) suivi une formation Ã  la Communication NonViolente</title><link href="https://www.dericbourg.net/2019/08/26/jai-enfin-suivi-une-formation-a-la-communication-nonviolente/" rel="alternate"></link><published>2019-08-26T00:00:00+02:00</published><updated>2019-08-26T00:00:00+02:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2019-08-26:/2019/08/26/jai-enfin-suivi-une-formation-a-la-communication-nonviolente/</id><summary type="html">&lt;p&gt;J'ai dÃ©couvert la Communication NonViolente il y a huit ans. Mes premiÃ¨res lectures
m'ont trÃ¨s vite donnÃ© envie d'aller plus loin, de creuser le sujet. J'y ai vu un outil
Â« magique Â» qui rÃ©soudrait toutes les situations inconfortables au travail que je vivais
plutÃ´t mal. Avec cette optique, j'estimais que les â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;J'ai dÃ©couvert la Communication NonViolente il y a huit ans. Mes premiÃ¨res lectures
m'ont trÃ¨s vite donnÃ© envie d'aller plus loin, de creuser le sujet. J'y ai vu un outil
Â« magique Â» qui rÃ©soudrait toutes les situations inconfortables au travail que je vivais
plutÃ´t mal. Avec cette optique, j'estimais que les stages de CNV devaient Ãªtre considÃ©rÃ©es
comme des formations professionnelles et Ãªtre prises en charge par mon employeur.&lt;/p&gt;
&lt;p&gt;Huit ans plus tard, j'ai fini par suivre ces stages sur mon temps personnel et sur mes
fonds propres sans aucun regret. Retour.&lt;/p&gt;
&lt;h2&gt;Ceci n'est pas un article sur la Communication NonViolente&lt;/h2&gt;
&lt;p&gt;J'ai suivi les &lt;a href="http://www.cnvformations.fr/"&gt;trois modules de base de formation Ã  la CNV&lt;/a&gt;.
Je ne souhaite pas dÃ©tailler le contenu de ces stages. Non par confidentialitÃ© du contenu.
Non par paresse. Non parce que j'ai dormi durant six jours.&lt;/p&gt;
&lt;p&gt;J'ai perÃ§u ces stages comme quelque chose qui se &lt;em&gt;vit&lt;/em&gt; et non comme quelque chose qui
&lt;em&gt;s'explique&lt;/em&gt; ou se &lt;em&gt;pense&lt;/em&gt;. D'ailleurs, je n'ai jamais rÃ©ussi Ã  finir un livre traitant de la
Communication NonViolente par ennui et par manque de vie. Et c'est lÃ  toute la diffÃ©rence
entre les livres et les stages : les livres se lisent avec la tÃªte de faÃ§on rationnelle
tandis que les stages insistent sur le &lt;em&gt;ressenti&lt;/em&gt;, sur l'attention Ã  l'Ã©motion que l'on a
souvent appris Ã  Ã©touffer avec la tÃªte.&lt;/p&gt;
&lt;p&gt;Je vais donc axer ce retour sur la faÃ§on dont &lt;em&gt;j'ai&lt;/em&gt; vÃ©cu les choses et sur les dÃ©placements
intÃ©rieurs que j'ai pu observer chez moi.&lt;/p&gt;
&lt;h2&gt;Et moi, et moi, et moi&lt;/h2&gt;
&lt;p&gt;Je suis de nature discrÃ¨te et il m'arrive de manquer de confiance en moi pour prendre
la parole au sein d'un groupe. Lorsque je la prends, j'ai du mal Ã  la garder jusqu'Ã  ce
que j'aie terminÃ© d'exprimer ce que j'avais Ã  dire. Lorsque Ã§a arrive, Ã§a me coupe
doublement la chique puisque je me retrouve en Ã©tat de sidÃ©ration sans savoir quoi rÃ©pondre
pour faire remarquer que j'aurais lÃ©gitimement pu aller au bout de mon idÃ©e. C'est Ã©galement ce
qui peut m'arriver lors d'une interaction inconfortable.&lt;/p&gt;
&lt;p&gt;Lorsque je m'exprime, j'ai besoin d'Ãªtre compris. Tant que je fais face Ã  quelqu'un qui ne me
semble pas avoir compris ce que je dis ou qui m'oppose des Â« oui, mais Â» sans la moindre
reformulation, je peux sur-enchÃ©rir sur les arguments et bouillir de l'intÃ©rieur.&lt;/p&gt;
&lt;p&gt;Une fois Ã  bout, quand je ne peux plus rien retenir et que la vapeur s'Ã©chappe par mes
oreilles, il est trop tard. Je mets fin Ã  la relation, je dÃ©missionne (parfois avec fracas),
je ferme la porte sans retour possible tout en ayant conscience que j'ai ma part de
responsabilitÃ© dans cette rupture qui aurait pu Ãªtre Ã©vitÃ©e avec une communication de qualitÃ©.&lt;/p&gt;
&lt;h2&gt;Module 1 : le recul sur soi&lt;/h2&gt;
&lt;p&gt;Le module 1 a Ã©tÃ© l'occasion d'une prise de recul. Ã€ l'issue de celui-ci, je me suis
observÃ© Ã  plusieurs reprises me dÃ©tacher d'une conversation pour constater que celle-ci
n'irait nulle part telle qu'elle Ã©tait menÃ©e.&lt;/p&gt;
&lt;p&gt;J'ai par exemple Ã©voquÃ© une envie, un rÃªve que je ne rÃ©aliserais jamais que j'ai depuis
quelques annÃ©es (et qu'il ne serait effectivement pas raisonnable de rÃ©aliser) avec une
personne de mon entourage proche. Celle-ci a argumentÃ© sur le manque de rÃ©alisme
d'un tel projet. AprÃ¨s un court ping-pong d'arguments, j'ai senti un dÃ©placement intÃ©rieur
qui m'a permis de rÃ©aliser que nous n'argumentions pas sur le mÃªme plan : mon interlocuteur
Ã©tait focalisÃ© sur le rÃ©alisme du projet et moi sur mon droit Ã  rÃªver et sur le pourquoi cela
me fait rÃªver. J'ai ainsi pu interrompre cet Ã©change stÃ©rile avant que le ton ne monte
simplement en cessant de contre-argumenter.&lt;/p&gt;
&lt;p&gt;C'est quelque part assez rassurant : c'est justement l'objet de ce module, Â«&amp;nbsp;clarifier
puis exprimer ce qui se passe en nous&amp;nbsp;Â». Il ne s'agit pas ici de l'exprimer Ã  mes interlocuteurs
mais de &lt;em&gt;me&lt;/em&gt; l'exprimer, de prendre connaissance et conscience de mon Ã©tat ici et maintenant.&lt;/p&gt;
&lt;p&gt;Sans ingratitude de ma part, je ne pense pas que deux jours de formation soient Ã  l'origine d'un
tel changement. Ã€ un autre propos, Gerald M. Weinberg Ã©crit dans la prÃ©face de &lt;em&gt;Becoming a technical leader&lt;/em&gt; :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Â«&amp;nbsp;becoming a leader is not something that happens to you, but something that you do. [...]
Our workshops [...] give a boost to each person's unique experiential process of
self-development&amp;nbsp;Â»&lt;/p&gt;
&lt;p&gt;(devenir un &lt;em&gt;leader&lt;/em&gt; technique n'est pas quelque chose qui vous arrive
mais quelque chose que vous faites. Nos stages donnent juste un coup de pouce Ã  chacun dans son
propre dÃ©veloppement personnel)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Cette formulation me rejoint pour Ã©voquer ce stage et l'Ã©volution qui s'est opÃ©rÃ©e chez moi.
Le cadre sÃ©curisant posÃ© par la formatrice et la garantie de confidentialitÃ© permet de prendre
des risques, de s'ouvrir plus que d'usage.&lt;/p&gt;
&lt;h2&gt;Module 2 : l'ouverture au dialogue&lt;/h2&gt;
&lt;p&gt;Autant le premier module est tournÃ© vers soi, autant le second est tournÃ© vers l'autre (en
conservant cette connexion Ã  soi). J'ai suivi ce module 2 environ un mois aprÃ¨s avoir suivi le
prÃ©cÃ©dent.&lt;/p&gt;
&lt;p&gt;PlutÃ´t Ã  l'aise en petit groupe, j'ai moins bien vÃ©cu ce module du fait du nombre de participants
(17). J'ai Ã©galement Ã©tÃ© dÃ©Ã§u de constater que la Communication NonViolente ne pouvait pas tout
rÃ©soudre : en travaillant sur une situation personnelle difficile et malgrÃ© l'aide du formateur,
je n'ai pas rÃ©ussi Ã  trouver d'issue qui assurerait la continuitÃ© de la relation. Cela a Ã©tÃ©
l'occasion pour moi de prendre conscience qu'une relation se construit et se maintient Ã  deux :
si l'autre ne souhaite pas cette relation ou considÃ¨re qu'elle n'existe pas, tous mes efforts
pour la construire ou la rÃ©tablir seront vains. C'est ce que met en Ã©vidence Jacques
SalomÃ© avec sa &lt;a href="https://blog-espere.com/decouvrez-lecharpe-relationnelle-un-outil-essentiel-de-la-methode-espere/"&gt;mÃ©taphore de l'Ã©charpe&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Si je ne devais retenir qu'une expÃ©rience de ce deuxiÃ¨me module, je m'arrÃªterais sur l'Ã©coute
silencieuse. L'exercice consiste Ã  former un binÃ´me : un Ã©coutant offre son attention sans
intervenir Ã  un Ã©coutÃ© qui est libre de s'exprimer pendant six minutes. Jusque lÃ , je
percevais mon expression comme dÃ©cousue et je me pensais incapable de tenir seul un sujet
au-delÃ  de quelques phrases. J'ai Ã©tÃ© trÃ¨s surpris de constater que j'en Ã©tais non seulement
capable mais que l'expÃ©rience m'avait Ã©tÃ© agrÃ©able ! C'est ainsi que j'ai rÃ©alisÃ© (au delÃ 
d'une comprÃ©hension intellectuelle) que la qualitÃ© d'un Ã©change dÃ©pend autant de la qualitÃ©
de l'Ã©coute que de la qualitÃ© de la parole. Si j'avais dÃ©jÃ  conscience de quelques travers
de l'Ã©coutant (ramener le sujet Ã  soi, commenter ou juger les propos...), j'en ai dÃ©couvert de
beaucoup plus insidieux. En particulier, j'ai Ã©tÃ© saisi par la rupture du flot de la pensÃ©e que
provoque une question impromptue, aussi pertinente et bienveillante soit-elle.&lt;/p&gt;
&lt;p&gt;Si j'ai pris conscience de ces obstacles Ã  la communication pour moi... j'en ai Ã©galement pris
conscience dans la communication des autres, avec qui j'ai commencÃ© Ã  les repÃ©rer :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Â« Je n'ai pas envie d'aller faire les courses demain...&lt;br&gt;
â€” Eh bien moi je n'ai pas envie d'aller travailler !&lt;br&gt;
â€” &lt;em&gt;(avec un petit sourire)&lt;/em&gt; Tiens, tu ramÃ¨nes les choses Ã  toi Â»&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;La suite de cette conversation a Ã©tÃ© ce qu'on pourrait appeler une situation inconfortable.
Quelle Ã©tait mon intention en faisant remarquer ce dÃ©faut de communication ? Certainement
pas le maintien de la relation en tout cas. Ave plus de recul, j'aurais pu proposer une Ã©coute
empathique Ã  mon interlocuteur, quitte Ã  revenir Ã  mon sujet initial par la suite. Dans tous les
cas, que m'aurais apporter d'infliger un Ã©tat d'Ã¢me Ã  quelqu'un qui n'Ã©tait pas en disposition
de le recevoir ?&lt;/p&gt;
&lt;h2&gt;Module 3 : la pratique du dialogue&lt;/h2&gt;
&lt;p&gt;J'ai suivi ce module quelques jours aprÃ¨s le module 2. Si un mois d'Ã©cart entre deux modules m'a
semblÃ© long, trois jours m'a semblÃ© court : je me sentais encore en phase de digestion du prÃ©cÃ©dent
module. Si c'Ã©tait Ã  refaire sans aucune contrainte, je choisirais de les espacer de deux Ã  trois semaines.
Cela reste une perception personnelle : si cela rÃ©pond Ã  mon propre rythme, cela n'est pas une
recommandation universelle.&lt;/p&gt;
&lt;p&gt;Ce module a Ã©tÃ© moins pour moi une source de dÃ©couverte qu'un approfondissement des premiers modules.
S'il apporte de nouvelles notions, dont le travail autour du Â« non Â», je suis reparti avec un ancrage
plus fort. C'est rÃ©ellement le module oÃ¹ j'ai senti les fruits de ces formations, oÃ¹ j'ai pu observer
que j'avais engrammÃ© certaines attitudes. Je m'observe plus attentif lorsque j'Ã©coute quelqu'un tout
en Ã©tant attentif Ã  ce que son discours provoque chez moi : je suis ainsi pleinement Ã  la discussion
lorsque je suis disponible pour l'Ãªtre et je suis capable de remarquer lorsque je ne le suis pas,
proposant ainsi d'interrompre ou de reporter l'Ã©change.&lt;/p&gt;
&lt;p&gt;Ã€ l'issue de ce sixiÃ¨me jour, ma communication est encore loin d'Ãªtre parfaite : il reste du travail.
Certains sujets ou certaines faÃ§ons de parler peuvent encore me faire bondir, je peux me retrouver dans
une incapacitÃ© Ã  accueillir pleinement ce que dis l'autre en quelques phrases seulement. Je note
cependant les petits pas, les petites rÃ©ussites qui m'encouragent Ã  poursuivre et Ã  persÃ©vÃ©rer. Ce
troisiÃ¨me module aura Ã©tÃ©, pour moi, le module de la confirmation.&lt;/p&gt;
&lt;h2&gt;Et maintenant ?&lt;/h2&gt;
&lt;p&gt;L'attitude d'auto-empathie, outil de prise de recul sur soi, m'a permis d'identifier au dÃ©but du troisiÃ¨me
module que j'Ã©tais inquiet de voir ces trois modules se terminer, d'interrompre ces progrÃ¨s que je
me suis observÃ© faire et l'intensitÃ© des Ã©change qui ont eu lieu lors de ces six jours. J'ai ainsi
pu prendre conscience qu'il Ã©tait important pour moi d'ancrer mon intention, ma posture et mes acquis.
J'ai ainsi pu prendre la dÃ©cision de planifier dÃ¨s la fin du stage ce qui serait la suite, que ce soit
un &lt;a href="http://www.cnvformations.fr/index.php?m=5&amp;amp;ms=101&amp;amp;tyf=1"&gt;autre stage&lt;/a&gt; ou rejoindre un
&lt;a href="https://cnvfrance.fr/acÂ§tualites/groupes-de-pratique/un-groupe-de-pratique-en-communication-non-violente/"&gt;groupe de pratique&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Une fois cette dÃ©cision prise, je me suis dÃ©tendu et j'ai pu profiter pleinement des deux jours de
stage sans inquiÃ©tude ni pensÃ©e parasite vis-Ã -vis de la suite.&lt;/p&gt;
&lt;p&gt;Six jours de formation ne m'ont pas suffi Ã  devenir un expert de la Communication NonViolente. Pour
autant, la graine est semÃ©e et a commencÃ© Ã  germer. MÃªme si je n'y parviens pas toujours, je garde
l'intention de la CNV avec moi, le maintient de la relation sans objectif cachÃ©. Et lorsque je perds
ce cap, je me pose (parfois longtemps aprÃ¨s) la question que Marshall Rosenberg posait :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Â« Qu'est-ce qui est important pour toi : Ãªtre heureux ou avoir raison ? Â»&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;La CNV en entreprise&lt;/h2&gt;
&lt;p&gt;Pour boucler cet article, revenons sur la CNV en entreprise :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Peut-on l'utiliser dans ce contexte ?&lt;/li&gt;
&lt;li&gt;Est-ce pertinent de former ses salariÃ©s Ã  la Communication NonViolente ?&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Utiliser la CNV en entreprise&lt;/h3&gt;
&lt;p&gt;Ã€ plusieurs reprises, j'ai entendu dire que la CNV n'Ã©tait pas adaptÃ©e Ã  l'entreprise. Parmi les arguments
contre, j'en ai retenu deux : d'une part les Ã©motions n'auraient pas leur place au travail et d'autre part
l'expression en continu des besoins serait source d'agacement.&lt;/p&gt;
&lt;p&gt;Par taquinerie, je pourrais faire remarquer que ces deux points, lorsqu'ils sont formulÃ©s par la mÃªme
personne, se contredisent. Si les Ã©motions n'ont pas leur place au travail, pourquoi prendre en compte
l'agacement que provoque chez certains l'expression des besoins ? Et d'ailleurs, cette prise en compte
serait justement... la prise en compte de l'expression d'un besoin.&lt;/p&gt;
&lt;p&gt;Je souhaite repartir de l'intention de la CNV : maintenir la relation. Ce n'est pas exprimer ses Ã©motions,
ce n'est pas faire respecter ses besoins : c'est entretenir ce qui nous relie Ã  l'autre. Il s'agit vraiment
de l'essentiel de la Communication NonViolente. Si pour maintenir cette relation, j'utilise l'auto-empathie
(Â« processus Â» silencieux de CNV de moi Ã  moi-mÃªme pour identifier mon besoin et essayer d'y rÃ©pondre) au
travail, je ne rentre pas dans le cadre de ces critiques. Ainsi, la CNV me permet de travailler sur mon Ã©tat
intÃ©rieur, de le clarifier et de me rendre plus disponible et ouvert au dialogue avec mes collÃ¨gues.&lt;/p&gt;
&lt;p&gt;Par ailleurs, un praticien expÃ©rimentÃ© en CNV n'utilise pas le schÃ©ma d'expression avec ses gros sabots :
Â« Lorsque tu dis... je me sens... parce que j'ai besoin... donc pouvons-nous... ? Â». Une pratique de la CNV
maÃ®trisÃ©e peut passer inaperÃ§ue en utilisant des tournures de phrases plus naturelles, voire en Ã©ludant
l'expression de l'Ã©motion ou du besoin si celle-ci est trop Â« Ã©vidente Â». Tout est question d'expÃ©rience et
de pratique.&lt;/p&gt;
&lt;h3&gt;Former ses salariÃ©s Ã  la CNV&lt;/h3&gt;
&lt;p&gt;Quant Ã  la pertinence de former ses salariÃ©s Ã  la Communication NonViolente... Ã§a dÃ©pend. La CNV demande
un travail sur soi, elle demande d'avoir envie de changer, quitte Ã  aller creuser des choses qui ne sont
pas toujours confortables. En Ã§a, je pense qu'il n'est pas pertinent de former tout le monde. Sans
l'envie prÃ©alable, ce serait du temps perdu... voire contre-productif. Les mÃ©canismes de la CNV, lorsqu'ils
ne sont pas bien intÃ©grÃ©s, deviennent trÃ¨s vite de la Â« CNVV Â» (Communication NonViolente Violente).
L'exemple suivant semble mÃ©caniquement correct mais est pourtant violent Ã  l'Ã©gard du destinataire du message :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Â« La derniÃ¨re fois que je suis allÃ© en rÃ©union avec toi, j'en suis ressorti en pleurant. Je suis fatiguÃ©
de tes frasques et j'ai besoin d'Ãªtre Ã©coutÃ© pendant les rÃ©unions. Alors est-ce que tu peux arrÃªter
de te comporter comme tu le fais Ã  chaque fois ? Â»&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ÃŠtre volontaire pour travailler sur soi ne protÃ¨ge pas d'une telle formulation. J'ai d'ailleurs rencontrÃ©
en formation des gens qui pouvaient s'exprimer ainsi â€” et c'est normal, cela demande du temps de bien
intÃ©grer les choses. L'envie est une condition nÃ©cessaire mais pas une condition suffisante.&lt;/p&gt;
&lt;p&gt;Cependant, il suffit de quelques individus pour transformer tout un groupe. Lorsqu'une personne fait un pas
de cÃ´tÃ© et change son comportement, elle va induire un changement dans tout le groupe ; et ce changement du
groupe va induire un changement de chaque individu du groupe jusqu'Ã  une situation d'Ã©quilibre.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ’¡&lt;em&gt;Ce mÃ©canisme est illustrÃ© par l'&lt;a href="http://universite-du-nous.org/"&gt;UniversitÃ© du Nous&lt;/a&gt; dans la vidÃ©o&lt;/em&gt;
&lt;em&gt;&lt;a href="https://gcs-vimeo.akamaized.net/exp=1566844521~acl=%2A%2F732247074.mp4%2A~hmac=75f349a64084fff8310917c7eba5b48bc8f4410090c6d1a832189afdca5582d3/vimeo-prod-skyfire-std-us/01/2599/8/212996890/732247074.mp4"&gt;Sociocratie, Holacracy... ou pas de modeÌ€le&lt;/a&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img alt="Un changement personnel induit un changement du groupe, qui induit lui-mÃªme Ã  nouveau un changement personnel" class="center" src="/images/cnv/changement.png"&gt;&lt;/p&gt;
&lt;p&gt;Ainsi, former quelques volontaires motivÃ©s peut avoir un impact fort sur tout un groupe. En cela, je pense que
former les volontaires Ã  la CNV peut Ãªtre pertinent et bÃ©nÃ©fique pour une entreprise.&lt;/p&gt;
&lt;h2&gt;CÃ©lÃ©brer les petits pas&lt;/h2&gt;
&lt;p&gt;Vous Ãªtes arrivÃ©s au bout de cet article et je m'en rÃ©jouis ! Partager ce qui est important pour
moi me tient Ã  cÅ“ur : seriez-vous d'accord pour &lt;a href="https://www.dericbourg.net"&gt;jeter un Å“il Ã  mes autres articles&lt;/a&gt; ?&lt;/p&gt;</content><category term="communication"></category><category term="vivre ensemble"></category><category term="bien-Ãªtre"></category></entry><entry><title>Calcul d'itinÃ©raire Ã  partir des donnÃ©es RATP</title><link href="https://www.dericbourg.net/2015/12/10/calcul-ditineraire-a-partir-des-donnees-ratp/" rel="alternate"></link><published>2015-12-10T00:00:00+01:00</published><updated>2015-12-10T00:00:00+01:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2015-12-10:/2015/12/10/calcul-ditineraire-a-partir-des-donnees-ratp/</id><summary type="html">&lt;p&gt;La RATP progresse dans l'&lt;a href="http://data.ratp.fr"&gt;ouverture de ses donnÃ©es&lt;/a&gt; et mÃªme si elle ne propose pas encore un accÃ¨s Ã  son &lt;a href="https://fr.wikipedia.org/wiki/Syst%C3%A8me_d'information_en_ligne"&gt;systÃ¨me SIEL&lt;/a&gt;, elle propose nÃ©anmoins les donnÃ©es de son offre de transport au &lt;a href="https://developers.google.com/transit/gtfs/"&gt;format GTFS&lt;/a&gt;. Une bonne occasion de s'initier au calcul d'itinÃ©raire !&lt;/p&gt;
&lt;p&gt;L'histoire et le contexte des calculs â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;La RATP progresse dans l'&lt;a href="http://data.ratp.fr"&gt;ouverture de ses donnÃ©es&lt;/a&gt; et mÃªme si elle ne propose pas encore un accÃ¨s Ã  son &lt;a href="https://fr.wikipedia.org/wiki/Syst%C3%A8me_d'information_en_ligne"&gt;systÃ¨me SIEL&lt;/a&gt;, elle propose nÃ©anmoins les donnÃ©es de son offre de transport au &lt;a href="https://developers.google.com/transit/gtfs/"&gt;format GTFS&lt;/a&gt;. Une bonne occasion de s'initier au calcul d'itinÃ©raire !&lt;/p&gt;
&lt;p&gt;L'histoire et le contexte des calculs d'itinÃ©raires est trÃ¨s bien synthÃ©tisÃ© par &lt;a href="https://twitter.com/tristramg"&gt;Tristram GrÃ¤bener&lt;/a&gt; dans son &lt;a href="http://blog.tristramg.eu/petit-historique-du-calcul-ditineraire.html"&gt;Petit historique du calcul d'itinÃ©raire&lt;/a&gt;. Probablement plus hipster que je ne veux bien l'admettre, j'ai choisi d'utiliser le plus rÃ©cent : le &lt;em&gt;&lt;a href="http://i11www.iti.uni-karlsruhe.de/extra/publications/dpsw-isftr-13.pdf"&gt;Connection Scan Algorithm&lt;/a&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;h2&gt;Connection scan algorithm&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Cette explication est largement inspirÃ©e de l'explication de l'algorithme du &lt;a href="https://github.com/captaintrain/csa-challenge/blob/master/readme.md"&gt;csa-challenge de CaptainTrain&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Cet algorithme, tenant en quelques lignes, se Â« contente Â» de parcourir une table horaire prÃ©-calculÃ©e des connexions entre les stations et de retenir la solution optimale en temps de trajet. Une connexion reprÃ©sente une possibilitÃ© de trajet entre deux stations. On la modÃ©lise donc par un quadruplet contenant :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;la station de dÃ©part,&lt;/li&gt;
&lt;li&gt;la station d'arrivÃ©e,&lt;/li&gt;
&lt;li&gt;l'heure de dÃ©part,&lt;/li&gt;
&lt;li&gt;l'heure d'arrivÃ©e.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;La table horaire devient alors simplement une liste de ces connexions triÃ©es par heure de dÃ©part croissante.&lt;/p&gt;
&lt;p&gt;Pour chaque station &lt;em&gt;s&lt;/em&gt;, on considÃ¨re l'heure et la station d'arrivÃ©e. Si celles-ci sont optimales, on les conserve. Les stations Ã©tant identifiÃ©es par des entiers, on les conserve dans deux tableaux : &lt;code&gt;arrival_timestamp[s]&lt;/code&gt; et &lt;code&gt;in_connection[s]&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;L'objectif est de se rendre d'un point de dÃ©part &lt;em&gt;o&lt;/em&gt; Ã  un point d'arrivÃ©e &lt;em&gt;d&lt;/em&gt; en partant Ã  l'heure &lt;em&gt;t0&lt;/em&gt;.&lt;/p&gt;
&lt;h3&gt;Initialisation&lt;/h3&gt;
&lt;p&gt;On initialise l'algorithme en attribuant une durÃ©e infinie au trajet vers tout point d'arrÃªt Ã  l'exception de la gare de dÃ©part (on en part, on sait qu'on y est Ã  &lt;em&gt;t0&lt;/em&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;Pour&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;chaque&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;station&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;â†&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;infinite&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;in_connection&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;â†&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;invalid_value&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;o&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;â†&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;t0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Boucle de calcul&lt;/h3&gt;
&lt;p&gt;On parcourt l'ensemble des connexions contenues dans la table et on considÃ¨re l'amÃ©lioration qu'elle apporte sur le trajet. Ã€ la fin de la boucle, lorsque toutes les connexions on Ã©tÃ© parcourues, toutes les heures d'arrivÃ©e depuis &lt;em&gt;o&lt;/em&gt; vers une autre station ont Ã©tÃ© calculÃ©es.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;Pour&lt;/span&gt; &lt;span class="n"&gt;chaque&lt;/span&gt; &lt;span class="n"&gt;connexion&lt;/span&gt; &lt;span class="k"&gt;c&lt;/span&gt;
    &lt;span class="n"&gt;Si&lt;/span&gt; &lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departure_station&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="err"&gt;â‰¤&lt;/span&gt; &lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departure_timestamp&lt;/span&gt;
    &lt;span class="n"&gt;et&lt;/span&gt; &lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrival_station&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;
        &lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrival_station&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="err"&gt;â†&lt;/span&gt; &lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrival_timestamp&lt;/span&gt;
        &lt;span class="n"&gt;in_connection&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="k"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrival_station&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="err"&gt;â†&lt;/span&gt; &lt;span class="k"&gt;c&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;RÃ©sultat&lt;/h3&gt;
&lt;p&gt;Pour obtenir le rÃ©sultat, on parcourt le tableau des stations d'arrivÃ©e (&lt;code&gt;in_connections&lt;/code&gt;) en partant de la destination &lt;em&gt;d&lt;/em&gt; jusqu'Ã  retrouver le point de dÃ©part &lt;em&gt;o&lt;/em&gt;.&lt;/p&gt;
&lt;h3&gt;Exemple&lt;/h3&gt;
&lt;p&gt;Prenons un exemple sur une ligne fictive :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;         &lt;span class="c1"&gt;-----o C&lt;/span&gt;
       &lt;span class="o"&gt;/&lt;/span&gt;
&lt;span class="n"&gt;o&lt;/span&gt;&lt;span class="c1"&gt;-----o B&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;      &lt;span class="err"&gt;\&lt;/span&gt;
         &lt;span class="c1"&gt;-----o D&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On souhaite rejoindre &lt;code&gt;C&lt;/code&gt; depuis &lt;code&gt;A&lt;/code&gt; en partant Ã  l'heure 2 avec la table horaire suivante :&lt;/p&gt;
&lt;table class="table table-bordered table-condensed table-striped"&gt;
&lt;thead&gt;
  &lt;tr&gt;
    &lt;th&gt;Station de dÃ©part&lt;/th&gt;
    &lt;th&gt;Station d'arrivÃ©e&lt;/th&gt;
    &lt;th&gt;Heure de dÃ©part&lt;/th&gt;
    &lt;th&gt;Heure d'arrivÃ©e&lt;/th&gt;
&lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;&lt;td&gt;A&lt;/td&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;1&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;D&lt;/td&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;A&lt;/td&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;3&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;C&lt;/td&gt;&lt;td&gt;3&lt;/td&gt;&lt;td&gt;4&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;A&lt;/td&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;4&lt;/td&gt;&lt;td&gt;5&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;A&lt;/td&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;5&lt;/td&gt;&lt;td&gt;6&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;D&lt;/td&gt;&lt;td&gt;5&lt;/td&gt;&lt;td&gt;6&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;B&lt;/td&gt;&lt;td&gt;C&lt;/td&gt;&lt;td&gt;6&lt;/td&gt;&lt;td&gt;7&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Initialisons les donnÃ©es.&lt;/p&gt;
&lt;table class="table table-condensed"&gt;
&lt;thead&gt;
  &lt;tr&gt;&lt;th&gt;&lt;/th&gt; &lt;th&gt;A&lt;/th&gt;&lt;th&gt;B&lt;/th&gt;&lt;th&gt;C&lt;/th&gt;&lt;th&gt;D&lt;/th&gt;&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;&lt;th&gt;Heure&lt;/th&gt; &lt;td&gt;2&lt;/td&gt;&lt;td&gt;&amp;infin;&lt;/td&gt;&lt;td&gt;&amp;infin;&lt;/td&gt;&lt;td&gt;&amp;infin;&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;th&gt;Station&lt;/th&gt; &lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;N/A&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;On parcours ensuite la table horaire dans l'ordre. Les deux premiÃ¨res lignes sont ignorÃ©es, elles ne passent pas la condition horaire.&lt;/p&gt;
&lt;p&gt;On arrive Ã  (A, B, 2, 3) :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Heure(A) â‰¤ 2 (2 â‰¤ 2)&lt;/li&gt;
&lt;li&gt;Heure(B) &amp;gt; 3 (&amp;infin; &amp;gt; 3)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On met Ã  jour les tables intermÃ©diaires.&lt;/p&gt;
&lt;table class="table table-condensed"&gt;
&lt;thead&gt;
  &lt;tr&gt;&lt;th&gt;&lt;/th&gt; &lt;th&gt;A&lt;/th&gt;&lt;th&gt;B&lt;/th&gt;&lt;th&gt;C&lt;/th&gt;&lt;th&gt;D&lt;/th&gt;&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;&lt;th&gt;Heure&lt;/th&gt; &lt;td&gt;2&lt;/td&gt;&lt;td&gt;&lt;strong&gt;3&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&amp;infin;&lt;/td&gt;&lt;td&gt;&amp;infin;&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;th&gt;Station&lt;/th&gt; &lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;&lt;strong&gt;(A, B, 2, 3)&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;N/A&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;On continue avec avec (B, C, 3, 4) qui satisfait Ã©galement les conditions.&lt;/p&gt;
&lt;table class="table table-condensed"&gt;
&lt;thead&gt;
  &lt;tr&gt;&lt;th&gt;&lt;/th&gt; &lt;th&gt;A&lt;/th&gt;&lt;th&gt;B&lt;/th&gt;&lt;th&gt;C&lt;/th&gt;&lt;th&gt;D&lt;/th&gt;&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;&lt;th&gt;Heure&lt;/th&gt; &lt;td&gt;2&lt;/td&gt;&lt;td&gt;3&lt;/td&gt;&lt;td&gt;&lt;strong&gt;4&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&amp;infin;&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;th&gt;Station&lt;/th&gt; &lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;(A, B, 2, 3)&lt;/td&gt;&lt;td&gt;&lt;strong&gt;(B, C, 3, 4)&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;N/A&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Un Å“il averti aura remarquÃ© que le trajet est ici dÃ©terminÃ©. L'algorithme se poursuit nÃ©anmoins.&lt;/p&gt;
&lt;p&gt;On arrive sur (A, B, 4, 5). On n'a bien Heure(A) â‰¤ 3 mais en revanche on n'a pas Heure(B) &amp;gt; 4. On passe la connexion. De mÃªme pour (A, B, 5, 6).&lt;/p&gt;
&lt;p&gt;Vient (B, D, 5, 6) :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Heure(B) â‰¤ 5 (3 â‰¤ 5)&lt;/li&gt;
&lt;li&gt;Heure(D) &amp;gt; 6 (&amp;infin; &amp;gt; 6)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Les tableaux sont donc mis Ã  jour.&lt;/p&gt;
&lt;table class="table table-condensed"&gt;
&lt;thead&gt;
  &lt;tr&gt;&lt;th&gt;&lt;/th&gt; &lt;th&gt;A&lt;/th&gt;&lt;th&gt;B&lt;/th&gt;&lt;th&gt;C&lt;/th&gt;&lt;th&gt;D&lt;/th&gt;&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;&lt;th&gt;Heure&lt;/th&gt; &lt;td&gt;2&lt;/td&gt;&lt;td&gt;3&lt;/td&gt;&lt;td&gt;4&lt;/td&gt;&lt;td&gt;&lt;strong&gt;6&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;th&gt;Station&lt;/th&gt; &lt;td&gt;N/A&lt;/td&gt;&lt;td&gt;(A, B, 2, 3)&lt;/td&gt;&lt;td&gt;(B, C, 3, 4)&lt;/td&gt;&lt;td&gt;&lt;strong&gt;(B, D, 5, 6)&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Il reste enfin la connexion (B, C, 6, 7) qui ne remplit par la condition Heure(C) &amp;gt; 7. On ne fait donc rien de cette connexion et les tableaux sont calculÃ©s.&lt;/p&gt;
&lt;p&gt;Pour obtenir le trajet, on part de la destination, donc de l'entrÃ©e associÃ©e au point d'arrÃªt C dans le tableau des stations. On trouve (B, C, 3, 4). On va alors chercher l'entrÃ©e associÃ©e au dÃ©part de cette connexion, soit l'entrÃ©e associÃ©e Ã  B. On trouve (A, B, 2, 3). Le point de dÃ©part de cette connexion est notre point de dÃ©part : la recherche est terminÃ©e.&lt;/p&gt;
&lt;p&gt;En dÃ©pilant (&lt;em&gt;Last in, first out&lt;/em&gt;) ces connexions, on retrouve le trajet Ã  parcourir :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;(A, B, 2, 3)&lt;/li&gt;
&lt;li&gt;(B, C, 3, 4)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;L'algorithme nous a donc permis de dÃ©terminer le trajet pour aller de A Ã  C en partant Ã  l'heure 2 ainsi que l'heure d'arrivÃ©e.&lt;/p&gt;
&lt;h3&gt;Analyse&lt;/h3&gt;
&lt;p&gt;Cet algorithme prÃ©sente l'avantage de s'exÃ©cuter en un temps proportionnel au nombre de connexions en occupant un espace mÃ©moire lui aussi proportionnel au nombre de connexions. Dans le cas du mÃ©tro parisien, on peut Ã©valuer que le nombre de correspondances est du mÃªme ordre de grandeur que le nombre &lt;em&gt;N&lt;/em&gt; de stations. Cela revient Ã  avoir :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;environ &lt;em&gt;N&lt;/em&gt; connexions entre stations d'une mÃªme ligne (le chiffre est lÃ©gÃ¨rement faussÃ© par la prÃ©sence de lignes en Â« fourche Â») ;&lt;/li&gt;
&lt;li&gt;environ &lt;em&gt;2N&lt;/em&gt; connexions issues des correspondances (une connexion dans un sens, une connexion dans l'autre).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;L'algorithme a donc une complexitÃ© proportionnelle au nombre de stations.&lt;/p&gt;
&lt;h2&gt;Exploitation des donnÃ©es de la RATP&lt;/h2&gt;
&lt;h3&gt;Format GTFS&lt;/h3&gt;
&lt;p&gt;Le format GTFS est un standard et la RATP se conforme Ã  ce standard, simple et bien documentÃ©. Les donnÃ©es sont rÃ©parties sur plusieurs fichiers dont nous n'en retiendrons que certains dans cet article.&lt;/p&gt;
&lt;h4&gt;routes.txt&lt;/h4&gt;
&lt;p&gt;Le fichier dÃ©crit le nom et la direction des routes. Une route est assimilable Ã  un trajet (origine - destination).&lt;/p&gt;
&lt;p&gt;Prenons l'exemple de la ligne 13 du mÃ©tro parisien dont le plan simplifiÃ© est reprÃ©sentÃ© sur la figure ci-dessous. Cette ligne est parcourue par quatre routes :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ChÃ¢tillon - Montrouge en direction de Saint-Denis UniversitÃ© ;&lt;/li&gt;
&lt;li&gt;ChÃ¢tillon - Montrouge en direction de Gennevilliers Les Courtilles ;&lt;/li&gt;
&lt;li&gt;Saint-Denis UniversitÃ© en direction de ChÃ¢tillon - Montrouge ;&lt;/li&gt;
&lt;li&gt;Gennevilliers Les Courtilles en direction de ChÃ¢tillon - Montrouge.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="Plan simplifiÃ© de la ligne 13 du mÃ©tro parisien" class="center" src="/images/connection_scan_algorithm/ligne13.png"&gt;&lt;/p&gt;
&lt;p&gt;Le fichier &lt;code&gt;routes.txt&lt;/code&gt; contient pour cette ligne :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;route_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;agency_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_short_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_long_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_desc&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_type&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_color&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;route_text_color&lt;/span&gt;
&lt;span class="m"&gt;1197620&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;13&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;(CHATILLON - MONTROUGE &amp;lt;-&amp;gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Aller&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="n"&gt;FFFFFF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;000000&lt;/span&gt;
&lt;span class="m"&gt;1197621&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;13&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;(CHATILLON - MONTROUGE &amp;lt;-&amp;gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Aller&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="n"&gt;FFFFFF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;000000&lt;/span&gt;
&lt;span class="m"&gt;1197622&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;13&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;(CHATILLON - MONTROUGE &amp;lt;-&amp;gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Retour&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="n"&gt;FFFFFF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;000000&lt;/span&gt;
&lt;span class="m"&gt;1197623&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;13&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;(CHATILLON - MONTROUGE &amp;lt;-&amp;gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Retour&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="n"&gt;FFFFFF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="m"&gt;000000&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;stops.txt&lt;/h4&gt;
&lt;p&gt;Ce fichier liste les arrÃªts avec, Ã©ventuellement, quelques informations complÃ©mentaires. La RATP fournit l'adresse la plus proche de l'arrÃªt ainsi que les coordonnÃ©es GPS de son centre (dans le cas d'une station qui dispose de plusieurs sorties). Ã€ noter que ce fichier n'est pas ordonnÃ© selon le sens de parcours des courses sur la ligne.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Une &lt;strong&gt;mission&lt;/strong&gt; est un trajet parcouru par un ensemble de trains. Elle est dÃ©crite par :
&lt;ul&gt;
  &lt;li&gt; la gare de dÃ©part ;&lt;/li&gt;
  &lt;li&gt; la gare d'arrivÃ©e ;&lt;/li&gt;
  &lt;li&gt; les gares intermÃ©diaires desservies (certains trajets peuvent Â« sauter Â» des gares).&lt;/li&gt;
&lt;/ul&gt;
Lorsqu'un train suit une mission, il rÃ©alise une &lt;strong&gt;course&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Exemple des quatre premiÃ¨res stations de la ligne 13 :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;stop_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_code&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_desc&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_lat&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_lon&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;location_type&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;parent_station&lt;/span&gt;
&lt;span class="mi"&gt;2397&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Pernety&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Raymond Losserand (72 rue) - 75114&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;833933819810916&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;31790897216328&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="mi"&gt;1969&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;ChÃ¢tillon Montrouge&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;RÃ©publique (220 avenue de la) - 92020&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;810283363510756&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;3012888709759522&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="mi"&gt;2406&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Place de Clichy&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;Clichy (terre-plein face au 7 place de) - 75109&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;883203999876585&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;3272660246411383&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;trips.txt&lt;/h4&gt;
&lt;p&gt;Ce fichier liste les courses et les associe Ã  une route. Nous reviendrons sur son utilitÃ© en observant les horaires d'arrÃªt.&lt;/p&gt;
&lt;p&gt;Exemple sur la ligne 13 :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;route_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;service_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;trip_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;trip_headsign&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;trip_short_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;direction_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;shape_id&lt;/span&gt;
&lt;span class="mi"&gt;1197620&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1762288&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;10017622880912413&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;101&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;101&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="mi"&gt;1197620&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1762289&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;10017622890912413&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;101&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;101&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="mi"&gt;1197620&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1762292&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;10017622920912413&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;101&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;101&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;stops_times.txt&lt;/h4&gt;
&lt;p&gt;Ce fichier prÃ©sente les horaires des courses aux stations (points d'arrÃªt). Ce fichier est triÃ© par course et par heure d'arrÃªt en station.&lt;/p&gt;
&lt;p&gt;Un dÃ©tail est Ã  noter quant aux horaires : ceux-ci sont fournis pour la journÃ©e qui peut se terminer... le lendemain. Un mÃ©tro circulant le dimanche Ã  1h du matin sera en rÃ©alitÃ© rattachÃ© Ã  la journÃ©e du samedi. Ainsi, son horaire ne sera pas Â« Ã  1h le dimanche Â» mais Â« Ã  25h le samedi Â». Bien que cette astuce puisse sembler tordue, elle simplifie en pratique beaucoup de choses, notamment pour maintenir la continuitÃ© des courses : il serait absurde de scinder la course d'un train sous prÃ©texte qu'il roule Ã  cheval sur deux jours calendaires.&lt;/p&gt;
&lt;p&gt;Exemple pour la ligne 13 :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;trip_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;arrival_time&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;departure_time&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_sequence&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_headsign&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;shape_dist_traveled&lt;/span&gt;
&lt;span class="mi"&gt;10017622880912413&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;38&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;38&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1969&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;
&lt;span class="mi"&gt;10017622880912413&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;40&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;40&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1880&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;
&lt;span class="mi"&gt;10017622880912413&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1879&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,,&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Dans cet exemple, pour la course prÃ©sentÃ©e, le vÃ©hicule s'arrÃªte Ã  19:38:00 Ã  l'arrÃªt 1969 (ChÃ¢tillon - Montrouge) et en repart Ã  la mÃªme heure. On en dÃ©duira qu'on ne prend vraisemblabement pas en compte le temps d'arrÃªt en station. Il arrive ensuite Ã  la station 1880 (Malakoff - Rue Etienne Dolet) Ã  19:40:00, puis Ã  la station 1879 (Malakoff - Plateau de Vanves) Ã  19:41:00, etc.&lt;/p&gt;
&lt;h4&gt;transfers.txt&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;transfers.txt&lt;/code&gt; regroupe les correspondances entre plusieurs points d'arrÃªt.&lt;/p&gt;
&lt;p&gt;Ce fichier n'Ã©tant pas comprÃ©hensible par un humain, prenons un exemple et dÃ©roulons-le :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;from_stop_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;to_stop_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;transfer_type&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;min_transfer_time&lt;/span&gt;
&lt;span class="mi"&gt;4211780&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2270&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;212&lt;/span&gt;
&lt;span class="mi"&gt;4472773&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1724&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;228&lt;/span&gt;
&lt;span class="mi"&gt;3619167&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2276&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;252&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Sur la premiÃ¨re ligne, la correspondance se fait entre l'arrÃªt Â« 4211780 Â» et l'arrÃªt Â« 2270 Â». Un recherche dans le fichier &lt;code&gt;stops.txt&lt;/code&gt; permet de donner un nom humainement comprÃ©hensible Ã  ces identifiants : ils correspondent ici tous les deux au point d'arrÃªt Â« Mairie de Saint-Ouen Â».&lt;/p&gt;
&lt;p&gt;Ã€ partir du l'identifiant d'un point d'arrÃªt, on peut Ã©galement ressortir les identifiants de course (&lt;code&gt;trip_id&lt;/code&gt;). Prenons-en un au hasard :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ grep &lt;span class="m"&gt;2270&lt;/span&gt; stop_times.txt &lt;span class="p"&gt;|&lt;/span&gt; cut -d, -f1 &lt;span class="p"&gt;|&lt;/span&gt; head -n1
&lt;span class="m"&gt;10017622880912417&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ã€ partir de cet identifiant, on peut retrouver la route associÃ©e (&lt;code&gt;route_id&lt;/code&gt;) :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ grep &lt;span class="m"&gt;10017622880912417&lt;/span&gt; trips.txt &lt;span class="p"&gt;|&lt;/span&gt; cut -d, -f1
&lt;span class="m"&gt;1197623&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On trouve donc qu'il s'agissait de la ligne 13 dans le sens Â« retour Â» :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ grep ^1197623, routes.txt
&lt;span class="m"&gt;1197623&lt;/span&gt;,100,&lt;span class="s2"&gt;&amp;quot;13&amp;quot;&lt;/span&gt;,&lt;span class="s2"&gt;&amp;quot;(CHATILLON - MONTROUGE &amp;lt;-&amp;gt; ST-DENIS-UNIVERSITE/LES COURTILLES) - Retour&amp;quot;&lt;/span&gt;,,1,,FFFFFF,000000
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;VÃ©rifions par acquit de conscience l'autre identifiant de point d'arrÃªt :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ grep &lt;span class="m"&gt;4211780&lt;/span&gt; stop_times.txt &lt;span class="p"&gt;|&lt;/span&gt; cut -d, -f1 &lt;span class="p"&gt;|&lt;/span&gt; head -n1
&lt;span class="m"&gt;119841521246955&lt;/span&gt;
$ grep &lt;span class="m"&gt;119841521246955&lt;/span&gt; trips.txt
&lt;span class="m"&gt;1364288&lt;/span&gt;,1984152,119841521246955,,1,1,
$ grep &lt;span class="m"&gt;1364288&lt;/span&gt; routes.txt
&lt;span class="m"&gt;1364288&lt;/span&gt;,100,&lt;span class="s2"&gt;&amp;quot;N44&amp;quot;&lt;/span&gt;,&lt;span class="s2"&gt;&amp;quot;(GARGES-SARCELLES RER &amp;lt;-&amp;gt; GARE DE L&amp;#39;EST) - Retour&amp;quot;&lt;/span&gt;,,3,,FFFFFF,000000
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Il s'agit donc du &lt;a href="http://www.ratp.fr/informer/pdf/orienter/f_horaire.php?fm=gif&amp;amp;loc=noctilien&amp;amp;nompdf=n44"&gt;Noctilien N44&lt;/a&gt; qui passe effectivement par Â« Mairie de Saint-Ouen Â». La boucle est bouclÃ©e.&lt;/p&gt;
&lt;h3&gt;Parsing des fichiers GTFS&lt;/h3&gt;
&lt;p&gt;Les fichiers GTFS, bien que portant l'extension &lt;code&gt;.txt&lt;/code&gt; sont manipulables comme des fichiers CSV. Dans la suite, on utilisera des structures qui sont (presque) calquÃ©es sur le format de ces fichiers. Sur le principe, leur parsing est immÃ©diat. Prenons par exemple le cas des routes (on utilise ici &lt;a href="https://github.com/tototoshi/scala-csv"&gt;scala-csv&lt;/a&gt;) :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.github.tototoshi.csv._&lt;/span&gt;

&lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Route&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;routeId&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Long&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;routeShortName&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;routeLongName&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;routeDesc&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;String&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;object&lt;/span&gt; &lt;span class="nc"&gt;Route&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fields&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;String&lt;/span&gt;, &lt;span class="kt"&gt;String&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="nc"&gt;Route&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
      &lt;span class="n"&gt;fields&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;route_id&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="n"&gt;toLong&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;fields&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;route_short_name&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
      &lt;span class="n"&gt;fields&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;route_long_name&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
      &lt;span class="n"&gt;fields&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;route_desc&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="o"&gt;)&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;routes&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Route&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;CSVReader&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nc"&gt;File&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;routes.txt&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)).&lt;/span&gt;
  &lt;span class="n"&gt;allWithHeaders&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;
  &lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Route&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Dans la pratique, la volumÃ©trie des horaires des courses rend l'opÃ©ration plus complexe :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ wc -l *
        &lt;span class="m"&gt;2&lt;/span&gt; agency.txt
    &lt;span class="m"&gt;65937&lt;/span&gt; calendar_dates.txt
     &lt;span class="m"&gt;4578&lt;/span&gt; calendar.txt
     &lt;span class="m"&gt;1067&lt;/span&gt; routes.txt
    &lt;span class="m"&gt;26653&lt;/span&gt; stops.txt
 &lt;span class="m"&gt;10402381&lt;/span&gt; stop_times.txt
    &lt;span class="m"&gt;80338&lt;/span&gt; transfers.txt
   &lt;span class="m"&gt;417920&lt;/span&gt; trips.txt
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pour simplifier la suite de cet article, nous ne traiterons que les lignes ferrÃ©es (mÃ©tro et RER) exploitÃ©es par la RATP. On regroupera les donnÃ©es ligne par ligne (au sens RATP) dans la structure &lt;code&gt;GtfsData&lt;/code&gt; pour ensuite les fusionner :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;GtfsData&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
  &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;routes&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Route&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt;
  &lt;span class="n"&gt;trips&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Trip&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt;
  &lt;span class="n"&gt;stops&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Stop&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt;
  &lt;span class="n"&gt;stopTimes&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;StopTime&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt;
  &lt;span class="n"&gt;transfers&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Transfer&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;GtfsData&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;parseGtfsDataByLine&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;gtfsData&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;GtfsData&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
  &lt;span class="s"&gt;&amp;quot;RATP&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;_&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;routes&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
  &lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;_&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;trips&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
  &lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;_&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stops&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
  &lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;_&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stopTimes&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt;
  &lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;_&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;transfers&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Construction de la table horaire&lt;/h3&gt;
&lt;p&gt;La table horaire est, comme nous l'avons vu, une sÃ©quence de connexions modÃ©lisÃ©es par des quadruplets contenants chacun la station de dÃ©part, la station d'arrivÃ©e, l'heure de dÃ©part et l'heure d'arrivÃ©e.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Timetable&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connections&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;
&lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
  &lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;departureTimestamp&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;arrivalTimestamp&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;
&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Sa construction se fait en deux Ã©tapes :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;en ingÃ©rant les connexions issues des courses (successions de points d'arrÃªts sur une mÃªme ligne) ;&lt;/li&gt;
&lt;li&gt;en ingÃ©rant les connexions issues des correspondances (Â« ponts Â» entre les courses).&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;Connexions issues des courses&lt;/h4&gt;
&lt;p&gt;On ingÃ¨re les horaires des courses en les groupant par... course et en prenant soin de ne pas Â« mÃ©langer Â» les horaires de deux courses. Prenons l'exemple ci-dessous : les ceux courses frÃ©quentent la mÃªme ligne mais ne s'arrÃªtent pas aux mÃªmes arrÃªts. Il n'y a pas de correspondance entre les deux.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; &lt;span class="n"&gt;Course&lt;/span&gt; &lt;span class="n"&gt;I&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;--------------------&amp;gt; B (t3)&lt;/span&gt;
&lt;span class="n"&gt;Course&lt;/span&gt; &lt;span class="n"&gt;II&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;               &lt;span class="k"&gt;C&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;--------------------&amp;gt; D (t4)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Le fichier &lt;code&gt;stop_times.txt&lt;/code&gt; ressemblerait Ã  :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;trip_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;arrival_time&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;departure_time&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_sequence&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;stop_headsign&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;shape_dist_traveled&lt;/span&gt;
&lt;span class="n"&gt;I&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;II&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;I&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;II&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Une lecture indÃ©pendante de l'identifiant de course (&lt;code&gt;trip_id&lt;/code&gt;) amalgamerait donc ces deux courses et induirait de fausses correspondances.&lt;/p&gt;
&lt;p&gt;La crÃ©ation de la table horaire se fait en groupant deux Ã  deux les horaires d'arrÃªt au sein d'une mÃªme course. Pour chaque Ã©lÃ©ment Ã  l'indice &lt;code&gt;i&lt;/code&gt;, on crÃ©era une connexion partant de l'arrÃªt Ã  cet indice et arrivant Ã  l'arrÃªt de l'indice &lt;code&gt;i+1&lt;/code&gt;. On implÃ©mente cette construction avec une fonction rÃ©cursive qui dÃ©pile un Ã  un les horaires de course.&lt;/p&gt;
&lt;p&gt;On utilise ici une fonction &lt;em&gt;tail recursive&lt;/em&gt; (&lt;a href="https://fr.wikipedia.org/wiki/R%C3%A9cursion_terminale"&gt;rÃ©cursion terminale&lt;/a&gt; en franÃ§ais), annotÃ©e &lt;code&gt;@tailrec&lt;/code&gt;. Une telle fonction a la particularitÃ© de voir son appel rÃ©cursif comme la derniÃ¨re instruction Ã  Ãªtre Ã©valuÃ©e. Son avantage est de pouvoir Ãªtre Â« optimisÃ©e Â» par le compilateur en une itÃ©ration (Â« boucle &lt;code&gt;for&lt;/code&gt; Â»), nous libÃ©rant du risque de dÃ©passement de capacitÃ© de la pile inhÃ©rent aux rÃ©cursions.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connectionsFromStopTimes&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;stopTimesByTripId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTimesToConnections&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;stopTimesToConnections&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTimes&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;StopTime&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="nd"&gt;@tailrec&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTimes&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;StopTime&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;stopTimes&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="c1"&gt;// Aucun horaire (n&amp;#39;arrive que si la collection initiale est vide).&lt;/span&gt;
      &lt;span class="c1"&gt;// On n&amp;#39;a rien Ã  faire de plus, on retourne les connexions (vides).&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="nc"&gt;Nil&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt;
      &lt;span class="c1"&gt;// Dernier horaire : il est connectÃ© au prÃ©cÃ©dent et n&amp;#39;ira pas plus loin.&lt;/span&gt;
      &lt;span class="c1"&gt;// On en a terminÃ© et on retourne les connexions.&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="nc"&gt;Nil&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt;
      &lt;span class="c1"&gt;// Cas gÃ©nÃ©ral : il reste des stations aprÃ¨s la premiÃ¨re de la collection.&lt;/span&gt;
      &lt;span class="c1"&gt;// On crÃ©Ã© une connexion entre celle-ci et la premiÃ¨re des suivantes.&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;tail&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;departureStop&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stopId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toInt&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;arrivalStop&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tail&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stopId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toInt&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;durationToTimestamp&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departureTime&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;arrivalTime&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;durationToTimestamp&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tail&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departureTime&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStop&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;arrivalStop&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;arrivalTime&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="c1"&gt;// Ã‰tape suivante de la rÃ©cursion&lt;/span&gt;
        &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tail&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt; &lt;span class="o"&gt;:+&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="c1"&gt;// Initialisation de la rÃ©cursion&lt;/span&gt;
  &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTimes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toList&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nc"&gt;List&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Dans cet exemple de code, la fonction &lt;code&gt;durationToTimestamp&lt;/code&gt; retourne un timestamp correspondant Ã  l'heure effective pour la journÃ©e en cours Ã  partir de l'heure seule fournie dans les donnÃ©es. Par exemple, le 01/01/2016, la durÃ©e &lt;code&gt;19h32min27s&lt;/code&gt; permettra d'obtenir le timestamp Ã©quivalent Ã  &lt;code&gt;2016-01-01T19:32:27.0Z&lt;/code&gt;.&lt;/p&gt;
&lt;h4&gt;Connexions issues des correspondances&lt;/h4&gt;
&lt;p&gt;Le fichier &lt;code&gt;transfers.txt&lt;/code&gt; nous donne les correspondances disponibles sur une ligne. L'objectif de cette Ã©tape est :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;de ne conserver que les correspondances de notre rÃ©seau (dans cet exemple, nous ne travaillons pas sur les bus, nous les Ã©liminons donc) ;&lt;/li&gt;
&lt;li&gt;de crÃ©er toutes les entrÃ©es de la table horaire correspondant Ã  cette correspondance.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Le filtrage des correspondances est aisÃ© avec notre structure de donnÃ©es. Nous disposons dÃ©jÃ  de l'ensemble des stations du rÃ©seau. Il nous suffit de vÃ©rifier que ces correspondances ont lieu entre deux stations du rÃ©seau.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;GtfsData&lt;/span&gt;&lt;span class="o"&gt;(...)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="c1"&gt;// Indexation des stations du rÃ©seau&lt;/span&gt;
  &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;stopsByStopId&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Long&lt;/span&gt;, &lt;span class="kt"&gt;Stop&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;stops&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stopId&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="o"&gt;)(&lt;/span&gt;&lt;span class="n"&gt;collection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;breakOut&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;filteredTransfers&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Transfer&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;transfers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;transfer&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
  &lt;span class="c1"&gt;// Filtrage des correspondances avec des stations hors du rÃ©seau&lt;/span&gt;
  &lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stopsByStopId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;contains&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;transfer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fromStopId&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;
    &lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stopsByStopId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;contains&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;transfer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toStopId&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Cela Ã©tant fait, pour chacune de ces correspondances, on crÃ©Ã© dans la table horaire une connexion correspondant Ã  chaque horaire de passage Ã  cette station. On utilisera pour cela les donnÃ©es issues de &lt;code&gt;stop_times.txt&lt;/code&gt;. Cette fonction est trÃ¨s similaire dans son fonctionnement Ã  &lt;code&gt;stopTimesToConnections&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;transfersToConnections&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filteredTransfers&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Transfer&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="nd"&gt;@tailrec&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;transfers&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Transfer&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;transfers&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="c1"&gt;// Aucune correspondance Ã  traiter. On en a terminÃ© et on sort avec&lt;/span&gt;
      &lt;span class="c1"&gt;// la liste construite jusqu&amp;#39;ici.&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="nc"&gt;Nil&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt;
      &lt;span class="c1"&gt;// Il reste au moins une correspondance Ã  traiter (tail peut Ãªtre Nil).&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;tail&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;departureStop&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fromStopId&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;arrivalStop&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toStopId&lt;/span&gt;
        &lt;span class="c1"&gt;// Pour chaque horaire de train Ã  cette station, on crÃ©Ã©&lt;/span&gt;
        &lt;span class="c1"&gt;// une entrÃ©e dans la table horaire.&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;transferConnections&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;List&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
          &lt;span class="n"&gt;stopTimesByStopId&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStop&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;
          &lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTime&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connectionDepartureTime&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;durationToTimestamp&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTime&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalTime&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="nc"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
              &lt;span class="n"&gt;departureStop&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
              &lt;span class="n"&gt;arrivalStop&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
              &lt;span class="n"&gt;connectionDepartureTime&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
              &lt;span class="n"&gt;connectionDepartureTime&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;minTransferTime&lt;/span&gt;
            &lt;span class="o"&gt;)&lt;/span&gt;
          &lt;span class="o"&gt;})&lt;/span&gt;
        &lt;span class="c1"&gt;// Ã‰tape suivante de la rÃ©cursion.&lt;/span&gt;
        &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tail&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="n"&gt;transferConnections&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="c1"&gt;// Initialisation de la rÃ©cursion.&lt;/span&gt;
  &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filteredTransfers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toList&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nc"&gt;List&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;Fusion des deux tables horaires&lt;/h4&gt;
&lt;p&gt;On a construit jusqu'ici deux tables horaires :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;l'une issue des horaires des trains en station ;&lt;/li&gt;
&lt;li&gt;l'autre issue des correspondances entre les trains.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Reste maintenant Ã  fusionner les deux. N'oublions pas que cette table doit Ãªtre triÃ©e par heure de dÃ©part croissante. Ã€ ce dÃ©tail prÃ¨s, cette Ã©tape est immÃ©diate.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connectionsFromStopTimes&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;stopTimesByTripId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stopTimesToConnections&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connectionsFromTransfers&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;transfersToConnections&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gtfsData&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connectionsFromStopTimes&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="n"&gt;connectionsFromTransfers&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;
  &lt;span class="n"&gt;toList&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
  &lt;span class="n"&gt;sortBy&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;_&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departureTimestamp&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;ImplÃ©mentation de l'algorithme&lt;/h2&gt;
&lt;p&gt;Je propose ici une implÃ©mentation en Scala qui pourrait probablement Ãªtre (largement, rien que par sa mutabilitÃ©) amÃ©liorÃ©e. Partons toujours de lÃ .&lt;/p&gt;
&lt;h3&gt;API&lt;/h3&gt;
&lt;p&gt;Cette implÃ©mentation est paramÃ©trÃ©e par :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;la table horaire ;&lt;/li&gt;
&lt;li&gt;un dictionnaire des arrÃªts indexÃ©s par leur identifiant.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Le calcul d'itinÃ©raire (mÃ©thode &lt;code&gt;compute&lt;/code&gt;) prend en entrÃ©e :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;un arrÃªt de dÃ©part ;&lt;/li&gt;
&lt;li&gt;un arrÃªt d'arrivÃ©e ;&lt;/li&gt;
&lt;li&gt;une heure de dÃ©part.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Il retourne la liste des connexions optimales pour effectuer ce trajet.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;CSA&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;timetable&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Timetable&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;stopsByStopId&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;, &lt;span class="kt"&gt;Stop&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;compute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;???&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Initialisation&lt;/h3&gt;
&lt;p&gt;On initialise les tableaux avec une valeur Â« virtuellement infinie Â» (valeur maximale qu'un entier peut reprÃ©senter) Ã  l'exception de l'heure d'arrivÃ©e optimale Ã  la station de dÃ©part... puisque cette valeur est connue.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;inConnection&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;Array&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fill&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;](&lt;/span&gt;&lt;span class="nc"&gt;CSA&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxStations&lt;/span&gt;&lt;span class="o"&gt;)(&lt;/span&gt;&lt;span class="nc"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxValue&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;earliestArrival&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;Array&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fill&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;](&lt;/span&gt;&lt;span class="nc"&gt;CSA&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxStations&lt;/span&gt;&lt;span class="o"&gt;)(&lt;/span&gt;&lt;span class="nc"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxValue&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;compute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;earliestArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt;
  &lt;span class="c1"&gt;// [...]&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Calcul du trajet&lt;/h3&gt;
&lt;h4&gt;Vue macroscopique&lt;/h4&gt;
&lt;p&gt;On retrouve les deux Ã©tapes du calcul dans la mÃ©thode &lt;code&gt;compute&lt;/code&gt; :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;la premiÃ¨re qui parcourt les connexions et dÃ©termine l'heure d'arrivÃ©e optimale pour chaque station (&lt;code&gt;scanTimetable&lt;/code&gt;) ;&lt;/li&gt;
&lt;li&gt;la seconde qui, Ã  partir de cette table des connexions optimales, reconstruit le trajet (&lt;code&gt;computeRoute&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;compute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;earliestArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;departureTime&lt;/span&gt;

  &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;=&lt;/span&gt; &lt;span class="nc"&gt;CSA&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxStations&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;arrivalStation&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;=&lt;/span&gt; &lt;span class="nc"&gt;CSA&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxStations&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;scanTimetable&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="n"&gt;computeRoute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;Parcours de la table horaire&lt;/h4&gt;
&lt;p&gt;On utilise une fois de plus une rÃ©cursion terminale.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;private&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;scanTimetable&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Unit&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="nd"&gt;@tailrec&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;conns&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;, &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)],&lt;/span&gt; &lt;span class="n"&gt;earliest&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Unit&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;newEarliest&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;earliest&lt;/span&gt;
    &lt;span class="n"&gt;conns&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="nc"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class="c1"&gt;// Aucune connexion dans la table horaire.&lt;/span&gt;
        &lt;span class="c1"&gt;// Ce n&amp;#39;est pas le cas le plus intÃ©ressant mais il n&amp;#39;y a rien Ã  faire.&lt;/span&gt;
        &lt;span class="o"&gt;()&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+:&lt;/span&gt; &lt;span class="k"&gt;_&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalTimestamp&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;earliest&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class="c1"&gt;// L&amp;#39;heure d&amp;#39;arrivÃ©e de la connexion dÃ©passe l&amp;#39;heure d&amp;#39;arrivÃ©e Â« optimale Â» actuelle.&lt;/span&gt;
        &lt;span class="c1"&gt;// On ne fait rien.&lt;/span&gt;
        &lt;span class="o"&gt;()&lt;/span&gt;
      &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+:&lt;/span&gt; &lt;span class="n"&gt;tail&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class="c1"&gt;// La connexion optimise les horaires dÃ©jÃ  calculÃ©s. On met Ã  jour les horaires.&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;leavesAfterArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;optimizesArrivalTime&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
          &lt;span class="n"&gt;earliestArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalTimestamp&lt;/span&gt;
          &lt;span class="n"&gt;inConnection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;
          &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;newEarliest&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;Math&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;min&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;earliest&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalTimestamp&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
          &lt;span class="o"&gt;}&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;
        &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tail&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;newEarliest&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;timetable&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zipWithIndex&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nc"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxValue&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;private&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;leavesAfterArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Boolean&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departureTimestamp&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;earliestArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;private&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;optimizesArrivalTime&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Boolean&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalTimestamp&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;earliestArrival&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;Construction de l'itinÃ©raire Ã  partir de la table horaire&lt;/h4&gt;
&lt;p&gt;Une fois la table horaire &lt;code&gt;inConnection&lt;/code&gt; calculÃ©e, on reconstitue l'itinÃ©raire inversÃ© en partant de la station d'arrivÃ©e et en remontant jusqu'Ã  la station de dÃ©part.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;private&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="n"&gt;computeRoute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;inConnection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="nc"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxValue&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt;
      &lt;span class="nc"&gt;Seq&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;// Pas de solution&lt;/span&gt;
    &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="k"&gt;_&lt;/span&gt; &lt;span class="k"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="nc"&gt;Array&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Connection&lt;/span&gt;&lt;span class="o"&gt;]()&lt;/span&gt;
      &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;lastConnectionIndex&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;inConnection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arrivalStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
      &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lastConnectionIndex&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="nc"&gt;Int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;MaxValue&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="k"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;Connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;timetable&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connections&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lastConnectionIndex&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;route&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt; &lt;span class="o"&gt;:+&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;
        &lt;span class="n"&gt;lastConnectionIndex&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="n"&gt;inConnection&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;departureStation&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
      &lt;span class="o"&gt;}&lt;/span&gt;
      &lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reverse&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ce cas est volontairement Ã©crit en Â« Java++ Â» plutÃ´t qu'en Â« bon Scala Â» par simplicitÃ© de lecture. Saurez-vous Ã©crire le cas gÃ©nÃ©ral en une ligne (ou deux) ?&lt;/p&gt;
&lt;h3&gt;Exemple&lt;/h3&gt;
&lt;p&gt;Partons d'un trajet entre Maubert-MutualitÃ© et Voltaire en partant Ã  18h.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;maubert&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2350&lt;/span&gt;
&lt;span class="k"&gt;val&lt;/span&gt; &lt;span class="n"&gt;voltaireLeonBlum&lt;/span&gt; &lt;span class="k"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1633&lt;/span&gt;

&lt;span class="n"&gt;csa&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compute&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
  &lt;span class="n"&gt;maubert&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;voltaireLeonBlum&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;durationToTimestamp&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Duration&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ofHours&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;18&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On obtient le trajet (notez la prÃ©sence des connexions de correspondance Ã  OdÃ©on et Strasbourg-Saint-Denis) :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;Solution&lt;/span&gt; &lt;span class="k"&gt;found&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="mi"&gt;15&lt;/span&gt; &lt;span class="n"&gt;connections&lt;/span&gt;
  &lt;span class="n"&gt;Maubert&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;MutualitÃ©&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Cluny&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;La&lt;/span&gt; &lt;span class="n"&gt;Sorbonne&lt;/span&gt;
  &lt;span class="n"&gt;Cluny&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;La&lt;/span&gt; &lt;span class="n"&gt;Sorbonne&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;OdÃ©on&lt;/span&gt;
  &lt;span class="n"&gt;OdÃ©on&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;OdÃ©on&lt;/span&gt;
  &lt;span class="n"&gt;OdÃ©on&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Michel&lt;/span&gt;
  &lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Michel&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;CitÃ©&lt;/span&gt;
  &lt;span class="n"&gt;CitÃ©&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;ChÃ¢telet&lt;/span&gt;
  &lt;span class="n"&gt;ChÃ¢telet&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Les&lt;/span&gt; &lt;span class="n"&gt;Halles&lt;/span&gt;
  &lt;span class="n"&gt;Les&lt;/span&gt; &lt;span class="n"&gt;Halles&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Etienne&lt;/span&gt; &lt;span class="n"&gt;Marcel&lt;/span&gt;
  &lt;span class="n"&gt;Etienne&lt;/span&gt; &lt;span class="n"&gt;Marcel&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;RÃ©aumur&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;SÃ©bastopol&lt;/span&gt;
  &lt;span class="n"&gt;RÃ©aumur&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;SÃ©bastopol&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Strasbourg&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Denis&lt;/span&gt;
  &lt;span class="n"&gt;Strasbourg&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Denis&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Strasbourg&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Denis&lt;/span&gt;
  &lt;span class="n"&gt;Strasbourg&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Denis&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;RÃ©publique&lt;/span&gt;
  &lt;span class="n"&gt;RÃ©publique&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Oberkampf&lt;/span&gt;
  &lt;span class="n"&gt;Oberkampf&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Ambroise&lt;/span&gt;
  &lt;span class="n"&gt;Saint&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Ambroise&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Voltaire&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LÃ©on&lt;/span&gt; &lt;span class="n"&gt;Blum&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Total&lt;/span&gt; &lt;span class="n"&gt;transit&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;21&lt;/span&gt; &lt;span class="n"&gt;minutes&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;En comparaison, l'&lt;a href="https://fr.wikipedia.org/wiki/Algorithme_de_Dijkstra"&gt;algorithme de plus court chemin de Dijkstra&lt;/a&gt; prÃ©sente une complexitÃ© proportionnelle Ã  &lt;em&gt;C.log(N)&lt;/em&gt; oÃ¹ &lt;em&gt;N&lt;/em&gt; est le nombre de stations et &lt;em&gt;C&lt;/em&gt; le nombre de correspondances entre deux stations, soit environ &lt;em&gt;N.log(N)&lt;/em&gt; dans notre Ã©valuation, tout en occupant un espace mÃ©moire de taille proportionnelle Ã  &lt;em&gt;N&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Le mÃ©tro parisien est constituÃ© de 303 stations (&lt;em&gt;N = 303&lt;/em&gt; et &lt;em&gt;N.log(N) = 752&lt;/em&gt;) : on reste donc dans le mÃªme ordre de magnitude sur ces deux algorithmes au moment du calcul d'itinÃ©raire. En revanche, le &lt;em&gt;Connexion scan algorithm&lt;/em&gt; demande de prÃ©-calculer la table horaire : il induit donc un coÃ»t prÃ©alable. Cette table prÃ©-calculÃ©e le rend Ã©galement moins souple : elle rend plus difficile le paramÃ©trage de l'algorithme en fonction des prÃ©fÃ©rences du voyageur. La facilitÃ© de marche du voyageur peut par exemple Ãªtre utilisÃ©e pour pondÃ©rer la durÃ©e d'une correspondance :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;avec le CSA, il est nÃ©cessaire de calculer une table prenant en compte ce paramÃ¨tre (une correspondance Ã©tant une connexion comme une autre) ;&lt;/li&gt;
&lt;li&gt;avec l'algorithme de Dijkstra, il Â« suffit Â» d'associer un poids plus fort aux arÃªtes reprÃ©sentant une correspondance lorsque le voyageur a des difficultÃ©s Ã  se dÃ©placer.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Si le CSA est plus simple Ã  implÃ©menter, il l'est au dÃ©triment de la souplesse en premiÃ¨re approche. Il est cependant possible de typer les connexions de correspondance pour leur attribuer diffÃ©rentes heures d'arrivÃ©e en fonction de la vÃ©locitÃ© pÃ©destre du voyageur.&lt;/p&gt;
&lt;p&gt;Enfin, si cet exemple a Ã©tÃ© menÃ© sur le rÃ©seau ferrÃ© RATP d'Ãle de France, son extension au rÃ©seau de bus (347 lignes) n'est pas viable : la table horaire devient trop volumineuse pour tenir en mÃ©moire et les performances s'en ressentent. Mon intuition est que cet algorithme est trÃ¨s pertinent sur de Â« petites Â» tables horaires (jusqu'Ã  quelques centaines de stations). DÃ¨s que le rÃ©seau grossit, en revanche, il est prÃ©fÃ©rable de chercher un autre algorithme moins gourmand en mÃ©moire et en prÃ©-calcul.&lt;/p&gt;</content><category term="opendata"></category><category term="ratp"></category><category term="gtfs"></category><category term="scala"></category></entry><entry><title>Gestion des accÃ¨s concurrents sur un cache de DAO</title><link href="https://www.dericbourg.net/2015/11/07/gestion-des-acces-concurrents-sur-un-cache-de-dao/" rel="alternate"></link><published>2015-11-07T00:00:00+01:00</published><updated>2015-11-07T00:00:00+01:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2015-11-07:/2015/11/07/gestion-des-acces-concurrents-sur-un-cache-de-dao/</id><summary type="html">&lt;p&gt;L'ajout d'un cache sur un DAO est une opÃ©ration courante et la bibliothÃ¨que Guava, trÃ¨s rÃ©pandue, a par ailleurs Ã©normÃ©ment simplifiÃ© sa mise en Å“uvre. NÃ©anmoins, il reste encore extrÃªmement facile de se tromper avec cette bibliothÃ¨que et... de rÃ©aliser un cache qui ne fonctionne pas.&lt;/p&gt;
&lt;h2&gt;Contexte&lt;/h2&gt;
&lt;p&gt;Partons d'une interface â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;L'ajout d'un cache sur un DAO est une opÃ©ration courante et la bibliothÃ¨que Guava, trÃ¨s rÃ©pandue, a par ailleurs Ã©normÃ©ment simplifiÃ© sa mise en Å“uvre. NÃ©anmoins, il reste encore extrÃªmement facile de se tromper avec cette bibliothÃ¨que et... de rÃ©aliser un cache qui ne fonctionne pas.&lt;/p&gt;
&lt;h2&gt;Contexte&lt;/h2&gt;
&lt;p&gt;Partons d'une interface de DAO Â« classique Â» permettant de rÃ©aliser les opÃ©rations &lt;em&gt;CRUD&lt;/em&gt;. On y ajoute une mÃ©thode &lt;code&gt;getAll&lt;/code&gt; qui retourne l'intÃ©gralitÃ© des objets (vous allez voir, c'est pour votre bien).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;interface&lt;/span&gt; &lt;span class="nc"&gt;Dao&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getAll&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
  &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;delete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Sans accorder d'importance Ã  l'implÃ©mentation du DAO accÃ©dant effectivement aux donnÃ©es persistÃ©es, contentons-nous de supposer que ses performances ne sont pas suffisantes pour rÃ©pondre aux sollicitations auxquelles est soumise notre application.&lt;/p&gt;
&lt;h2&gt;Cache des donnÃ©es&lt;/h2&gt;
&lt;p&gt;On se propose d'utiliser &lt;a href="https://github.com/google/guava"&gt;Guava&lt;/a&gt; pour implÃ©menter ce cache. On utilise dans cet exemple un &lt;a href="https://github.com/google/guava/wiki/CachesExplained"&gt;&lt;code&gt;LoadingCache&lt;/code&gt;&lt;/a&gt; qui ira chercher en base la donnÃ©e s'il n'a pas dÃ©jÃ  Ã©tÃ© sollicitÃ© pour celle-ci : on charge les valeurs une Ã  une Ã  la demande. Il permet Ã©galement de rafraÃ®chir les donnÃ©es automatiquement Ã  intervalle rÃ©gulier.&lt;/p&gt;
&lt;p&gt;L'encapsulation des donnÃ©es de cache dans des &lt;code&gt;Optional&lt;/code&gt; est un parti pris. Deux choix Ã©taient possibles :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;on peut choisir d'ignorer les valeurs inexistantes, auquel cas, si celles-ci sont demandÃ©es plusieurs fois, ce sont autant d'appels Ã  la base qui seront faits ;&lt;/li&gt;
&lt;li&gt;on peut Ã©galement choisir de placer une sentinelle dans le cache (en l'occurrence, l'instance Â« absente Â» d'&lt;code&gt;Optional&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Les deux approches ont leur avantages et leurs inconvÃ©nients et leur utilisation dÃ©pend de votre application et de vos besoins.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;LoadingCache&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;CacheBuilder&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;newBuilder&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;build&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;CacheLoader&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="nd"&gt;@Override&lt;/span&gt;
      &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;load&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
      &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;ImplÃ©mentation naÃ¯ve (et fausse)&lt;/h2&gt;
&lt;p&gt;En premiÃ¨re approche, on peut supposer qu'il Â« suffit Â» de mettre Ã  jour le cache pour chaque opÃ©ration d'Ã©criture sur la base de donnÃ©es. Une implÃ©mentation dans cette optique ressemblerait Ã  ceci.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;CachedDao&lt;/span&gt; &lt;span class="kd"&gt;implements&lt;/span&gt; &lt;span class="n"&gt;Dao&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

  &lt;span class="c1"&gt;// DAO accÃ©dant aux donnÃ©es persistÃ©es.&lt;/span&gt;
  &lt;span class="c1"&gt;// Dans la vraie vie, vous l&amp;#39;auriez injectÃ©, hein ?&lt;/span&gt;
  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;DbDao&lt;/span&gt; &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;LoadingCache&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;createCache&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="nf"&gt;CachedDao&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;dbDao&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DbDao&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="c1"&gt;// Initialisation du cache : nÃ©cessaire pour utiliser le cache sur getAll.&lt;/span&gt;
    &lt;span class="n"&gt;initCache&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getAll&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;asMap&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
                &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;values&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
                &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
                &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;filter&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;isPresent&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
                &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
                &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;collect&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Collectors&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toList&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;delete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;delete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Vidage intÃ©gral du cache puis rechargement.&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;invalidateAll&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="n"&gt;initCache&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;initCache&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getAll&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;of&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pourquoi cette implÃ©mentation ne fonctionne pas ?&lt;/p&gt;
&lt;p&gt;Dans le cas de multiples appels concurrents, des interruptions peuvent avoir lieu Ã  tout moment. L'appel Ã  &lt;code&gt;delete&lt;/code&gt; peut Ãªtre interrompu entre la mise Ã  jour de la base (&lt;code&gt;dbDao.delete(id)&lt;/code&gt;) et le rafraÃ®chissement du cache (&lt;code&gt;cache.refresh(id)&lt;/code&gt;). Si cette interruption se fait Ã  la faveur d'une lecture (&lt;code&gt;get&lt;/code&gt;), cette derniÃ¨re se fera sur un cache qui n'est pas encore mise Ã  jour et donc renverra une donnÃ©e Â« pÃ©rimÃ©e Â». Rien ne dit qu'il est impÃ©ratif de rÃ©cupÃ©rer la derniÃ¨re version de la donnÃ©e : suivant votre application, cela peut Ãªtre acceptable.&lt;/p&gt;
&lt;p&gt;Mais alors, pire : supposons qu'un appel Ã  &lt;code&gt;getAll&lt;/code&gt; provoque une interruption pendant un rafraÃ®chissement du cache, au milieu de la boucle de rechargement de la mÃ©thode &lt;code&gt;initCache&lt;/code&gt;. On retourne alors une version incohÃ©rente (partielle) des donnÃ©es. Cette situation n'est, elle, pas acceptable.&lt;/p&gt;
&lt;h2&gt;Le problÃ¨me des lecteurs et des rÃ©dacteurs&lt;/h2&gt;
&lt;p&gt;Le cas de figure dans lequel nous nous trouvons correspond Ã  un problÃ¨me bien connu formulÃ© par Edsger Dijkstra pour modÃ©liser... les accÃ¨s aux bases de donnÃ©es. Ceux-ci sont soumis Ã  deux contraintes :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;plusieurs lecteurs doivent pouvoir lire dans la base simultanÃ©ment ;&lt;/li&gt;
&lt;li&gt;si un rÃ©dacteur est en train de modifier la base de donnÃ©es, aucun autre utilisateur (qu'il soit lecteur ou rÃ©dacteur) ne doit pouvoir y accÃ©der.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Une solution simple revient Ã  attendre, lorsqu'un rÃ©dacteur se prÃ©sente, d'attendre que tous les lecteurs soient partis et de bloquer l'entrÃ©e Ã  tout nouvel utilisateur. En utilisant un sÃ©maphore (&lt;code&gt;db&lt;/code&gt;) et un compteur (&lt;code&gt;rc&lt;/code&gt;), cela reviendrait Ã  :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Le premier lecteur Ã  entrer acquiert le sÃ©maphore &lt;code&gt;db&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Tous les lecteurs entrant incrÃ©mentent le compteur &lt;code&gt;rc&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;En sortant, ils dÃ©crÃ©mentent ce compteur.&lt;/li&gt;
&lt;li&gt;Le dernier lecteur Ã  sortir dÃ©bloque le sÃ©maphore &lt;code&gt;db&lt;/code&gt; et autorise alors un rÃ©dacteur en attente, s'il y en a un, Ã  entrer.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Sur notre exemple de DAO, la modification se ferait de la sorte (ce qui n'est pas explicitement redÃ©fini n'a pas changÃ©) :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;CachedDao&lt;/span&gt; &lt;span class="kd"&gt;implements&lt;/span&gt; &lt;span class="n"&gt;Dao&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;Semaphore&lt;/span&gt; &lt;span class="n"&gt;lock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Semaphore&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;AtomicLong&lt;/span&gt; &lt;span class="n"&gt;concurrentAccess&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;AtomicLong&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;concurrentAccess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;incrementAndGet&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="c1"&gt;// Premier lecteur Ã  entrer&lt;/span&gt;
      &lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;acquire&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;returnValue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;ofNullable&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getIfPresent&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;concurrentAccess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;decrementAndGet&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="c1"&gt;// Dernier lecteur Ã  sortir&lt;/span&gt;
      &lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;release&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;returnValue&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Attente que le dernier utilisateur sorte&lt;/span&gt;
    &lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;acquire&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

    &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;

    &lt;span class="c1"&gt;// LibÃ©ration pour qu&amp;#39;un utilisateur puisse revenir&lt;/span&gt;
    &lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;release&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;delete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Idem.&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Mais s'il rentre un lecteur toutes les deux millisecondes et qu'il faut cinq millisecondes Ã  chaque lecteur pour terminer sa consultation, il y aura toujours des lecteurs prÃ©sents et le rÃ©dacteur ne pourra jamais entrer.&lt;/p&gt;
&lt;p&gt;Pour Ã©viter cela, il faut que lorsqu'un rÃ©dacteur est en attente, tout lecteur qui se prÃ©sente reste Â« derriÃ¨re Â» le rÃ©dacteur et attende qu'il ait terminÃ©.&lt;/p&gt;
&lt;p&gt;En Java, &lt;a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html"&gt;la classe &lt;code&gt;ReentrantReadWriteLock&lt;/code&gt;&lt;/a&gt; permet de rÃ©pondre Ã  cette condition. Il encapsule deux types de verrous :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;un verrou en lecture que tous les lecteurs peuvent Â« passer Â» tant qu'aucun verrou en Ã©criture n'a Ã©tÃ© posÃ© ;&lt;/li&gt;
&lt;li&gt;un verrou en Ã©criture que tous les rÃ©dacteurs peuvent Â« passer Â» tant qu'aucun verrou en lecture ou en Ã©criture n'a Ã©tÃ© posÃ©.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Exemple en lecture :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;ReadWriteLock&lt;/span&gt; &lt;span class="n"&gt;readWriteLock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ReentrantReadWriteLock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

&lt;span class="n"&gt;readWriteLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

  &lt;span class="c1"&gt;// Cette section est accessible par plusieurs lecteurs simultanÃ©ment&lt;/span&gt;
  &lt;span class="c1"&gt;// si aucun verrou en Ã©criture n&amp;#39;a Ã©tÃ© acquis.&lt;/span&gt;

&lt;span class="n"&gt;readWriteLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Exemple en Ã©criture :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;ReadWriteLock&lt;/span&gt; &lt;span class="n"&gt;readWriteLock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ReentrantReadWriteLock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

&lt;span class="n"&gt;readWriteLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

  &lt;span class="c1"&gt;// Cette section est accessible par un seul rÃ©dacteur Ã  la fois&lt;/span&gt;
  &lt;span class="c1"&gt;// si aucun verrou n&amp;#39;est acquis (en lecture ou en Ã©criture).&lt;/span&gt;

&lt;span class="n"&gt;readWriteLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;ImplÃ©mentation Â« sÃ»re Â»&lt;/h2&gt;
&lt;p&gt;Nous pouvons rÃ©utiliser notre implÃ©mentation naÃ¯ve : si elle n'Ã©tait pas sÃ»re, son intention restait valable. Pour l'adapter, on ajoute :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;des verrous en lecture sur les mÃ©thodes de lecture ;&lt;/li&gt;
&lt;li&gt;des verrous en Ã©criture sur les mÃ©thodes d'Ã©criture ;&lt;/li&gt;
&lt;li&gt;et... c'est tout.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Il est en revanche nÃ©cessaire de Â« protÃ©ger Â» la libÃ©ration des verrous. Si un traitement se passe mal â€” si par exemple si une exception est lancÃ©e â€” le verrou doit malgrÃ© tout Ãªtre libÃ©rÃ©. On encapsulera donc tout le code des sections critiques dans un bloc &lt;code&gt;try&lt;/code&gt; / &lt;code&gt;finally&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Le code n'ayant pas changÃ© par rapport Ã  la premiÃ¨re version n'est pas reprÃ©sentÃ©.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.locks.ReadWriteLock&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.locks.ReentrantReadWriteLock&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;CachedDao&lt;/span&gt; &lt;span class="kd"&gt;implements&lt;/span&gt; &lt;span class="n"&gt;Dao&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;ReadWriteLock&lt;/span&gt; &lt;span class="n"&gt;rwLock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ReentrantReadWriteLock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;unsafeGet&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;finally&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getAll&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;asMap&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
                  &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;values&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
                  &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
                  &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;filter&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;isPresent&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
                  &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
                  &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;collect&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Collectors&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toList&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;finally&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;unsafeSave&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;finally&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;delete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;unsafeDelete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;finally&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;unsafeRefresh&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;finally&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;rwLock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeLock&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;unlock&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;unsafeGet&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;ofNullable&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getIfPresent&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;unsafeSave&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;unsafeDelete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;delete&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;refresh&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;unsafeRefresh&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Vidage intÃ©gral du cache puis rechargement.&lt;/span&gt;
    &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;invalidateAll&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="n"&gt;initCache&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;

  &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;initCache&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MyObject&lt;/span&gt; &lt;span class="n"&gt;myObject&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;dbDao&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getAll&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;of&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myObject&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
  &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Pour aller plus loin&lt;/h2&gt;
&lt;p&gt;Le DAO prÃ©sentÃ© ici est Â« sÃ»r Â» dans la mesure oÃ¹ il garantit la cohÃ©rence avec la base des donnÃ©es retournÃ©es. En revanche, pour cela, un compromis sur les performances a du Ãªtre fait. En effet, cette implÃ©mentation ne permet pas d'Ã©critures simultanÃ©es : la modification de deux objets distincts n'est pas possible.&lt;/p&gt;
&lt;p&gt;Peut-on faire mieux ? Si vous pensez que oui, quelle serait votre approche ?&lt;/p&gt;</content><category term="java"></category><category term="guava"></category><category term="cache"></category><category term="dao"></category><category term="verrou"></category><category term="concurrence"></category></entry><entry><title>ProblÃ¨me des huit reines</title><link href="https://www.dericbourg.net/2015/08/11/probleme-des-huit-reines/" rel="alternate"></link><published>2015-08-11T00:00:00+02:00</published><updated>2015-08-11T00:00:00+02:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2015-08-11:/2015/08/11/probleme-des-huit-reines/</id><summary type="html">&lt;p&gt;J'ai rencontrÃ© le &lt;a href="https://fr.wikipedia.org/wiki/Probl%C3%A8me_des_huit_dames"&gt;problÃ¨me des huits reines&lt;/a&gt; lors d'un entretien d'embauche. Sans juger de la pertinence de cet exercice dans ce cadre (indÃ©pendamment du fait que j'aie lamentablement et honteusement Ã©chouÃ©), la pÃ©riode estivale, propice Ã  la dÃ©tente, m'a incitÃ© Ã  pousser le jeu plus en avant (mon orgueil a â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;J'ai rencontrÃ© le &lt;a href="https://fr.wikipedia.org/wiki/Probl%C3%A8me_des_huit_dames"&gt;problÃ¨me des huits reines&lt;/a&gt; lors d'un entretien d'embauche. Sans juger de la pertinence de cet exercice dans ce cadre (indÃ©pendamment du fait que j'aie lamentablement et honteusement Ã©chouÃ©), la pÃ©riode estivale, propice Ã  la dÃ©tente, m'a incitÃ© Ã  pousser le jeu plus en avant (mon orgueil a probablement contribuÃ© lui aussi).
Le problÃ¨me consiste Ã  compter et identifier les diffÃ©rentes faÃ§ons de placer sur un Ã©chiquier de 64 cases 8 reines de faÃ§on Ã  ce que, relativement aux rÃ¨gles des Ã©checs, elles ne se menacent pas mutuellement. Une reine peut se dÃ©placer de faÃ§on rectiligne d'un nombre de cases arbitraire dans toutes les directions ; lorsqu'une reine est placÃ©e, la ligne, la colonne et les diagonales sur lesquelles elle se situe sont donc Â« condamnÃ©es Â».&lt;/p&gt;
&lt;h2&gt;ModÃ©lisation&lt;/h2&gt;
&lt;p&gt;On ne peut pas placer plusieurs reines sur une mÃªme ligne. On peut donc simplifier la modÃ©lisation en ne travaillant que sur les colonnes. Ainsi, on cherchera Ã  ne retourner qu'un tableau d'index de colonne, chacun de ces index correspondant Ã  la ligne de son propre index dans le tableau. Pour illustrer, on produira en retour un tableau de la forme &lt;code&gt;[x, y, z]&lt;/code&gt; qui correspond en pratique aux coordonnÃ©es &lt;code&gt;(0, x)&lt;/code&gt;, &lt;code&gt;(1, y)&lt;/code&gt; et &lt;code&gt;(2, z)&lt;/code&gt; sur l'Ã©chiquier.&lt;/p&gt;
&lt;p&gt;ReprÃ©sentons cette modÃ©lisation dans le cas de la rÃ©solution du problÃ¨me avec huit reines.&lt;/p&gt;
&lt;p&gt;&lt;img alt="ReprÃ©sentation de la modÃ©lisation" class="center" src="/images/eight_queens/modelisation.png"&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note :&lt;/strong&gt; en Python, la fonction &lt;a href="https://docs.python.org/2/library/functions.html#enumerate"&gt;&lt;code&gt;enumerate&lt;/code&gt;&lt;/a&gt; permet d'obtenir de faÃ§on immÃ©diate ce rÃ©sultat.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;enumerate&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt;
&lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/blockquote&gt;
&lt;p&gt;Il est alors Â« facile Â» de dÃ©terminer si une reine est en sÃ©curitÃ© connaissant la position des autres :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Par construction, aucune reine ne peut Ãªtre sur la mÃªme ligne.&lt;/li&gt;
&lt;li&gt;Deux reines sont sur la mÃªme colonne lorsque leur index de colonne est la mÃªme (&lt;code&gt;c[i] == c[j]&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Deux reines sont sur la mÃªme diagonale lorsque leur diffÃ©rence d'index dans le tableau (donc leur diffÃ©rence d'index de ligne) est Ã©gal Ã  leur diffÃ©rence d'index de colonne (&lt;code&gt;abs(c[i] - c[j]) == abs(i - j)&lt;/code&gt;). La valeur absolue permet de traiter indiffÃ©remment les diagonales Â« montantes Â» et les diagonales Â« descendantes Â».&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Ainsi, les solutions, lorsqu'elles existent, forment un sous-ensemble des permutations de {1 ; 2 ; ... ; &lt;em&gt;n&lt;/em&gt; - 1} (oÃ¹ &lt;em&gt;n&lt;/em&gt; est le nombre de reines et la dimension de l'Ã©chiquier).&lt;/p&gt;
&lt;p&gt;&lt;img alt="ReprÃ©sentation de la modÃ©lisation" class="center" src="/images/eight_queens/diagonale.png"&gt;&lt;/p&gt;
&lt;h2&gt;Approche naÃ¯ve : examen de l'intÃ©gralitÃ© des permutations&lt;/h2&gt;
&lt;p&gt;Cette approche revient Ã  essayer toutes les combinaisons de placement des reines et de retenir celles pour lesquelles toutes les reines sont en sÃ©curitÃ©. Compte tenu du fait que deux reines ne peuvent Ãªtre sur la mÃªme colonne, la solution est une permutation de la suite d'entiers de 0 Ã  &lt;em&gt;n&lt;/em&gt; - 1.&lt;/p&gt;
&lt;h3&gt;GÃ©nÃ©ration des permutations&lt;/h3&gt;
&lt;p&gt;Il est possible de dÃ©terminer toutes les permutations possibles d'un tableau en utilisant â€” par exemple â€” l'&lt;a href="https://en.wikipedia.org/wiki/Heap%27s_algorithm"&gt;algorithme de Heap&lt;/a&gt; qui minimise le nombre de mouvements nÃ©cessaires Ã  l'obtention de l'intÃ©gralitÃ© des permutations. Une permutation est obtenue de la prÃ©cÃ©dente en interchangeant la position de deux Ã©lÃ©ments (et seulement deux).&lt;/p&gt;
&lt;p&gt;J'en propose une implÃ©mentation rÃ©cursive : compte tenu des dimensions des tableaux de notre problÃ¨me, cela reste raisonnable ; on ne risque pas le dÃ©passement de la capacitÃ© de la pile d'exÃ©cution.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;permutations&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__permutations&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt;  &lt;span class="n"&gt;__permutations&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                    &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
                &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;__permutations&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pour donner un exemple :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;perm&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;permutations&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]):&lt;/span&gt; &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;perm&lt;/span&gt;
&lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;En pratique, la bibliothÃ¨que standard Python propose dans le module &lt;a href="https://docs.python.org/3/library/itertools.html"&gt;&lt;code&gt;itertools&lt;/code&gt;&lt;/a&gt; une fonction gÃ©nÃ©rant ces permutations. Mesurons grossiÃ¨rement le temps d'exÃ©cution de ce code avec les deux implÃ©mentations :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10000&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;perm&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;permutations&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;perm&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt; &lt;span class="n"&gt;Heap&lt;/span&gt;
&lt;span class="err"&gt;$&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="n"&gt;python&lt;/span&gt; &lt;span class="n"&gt;heaps&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;
&lt;span class="nb"&gt;real&lt;/span&gt;    &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="n"&gt;m42&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;860&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="k"&gt;user&lt;/span&gt;    &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="n"&gt;m42&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;832&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;     &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="n"&gt;m0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;008&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;

&lt;span class="o"&gt;#&lt;/span&gt; &lt;span class="n"&gt;itertools&lt;/span&gt;
&lt;span class="err"&gt;$&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="n"&gt;python&lt;/span&gt; &lt;span class="n"&gt;itertools&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;
&lt;span class="nb"&gt;real&lt;/span&gt;    &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="n"&gt;m3&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;433&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="k"&gt;user&lt;/span&gt;    &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="n"&gt;m3&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;428&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;     &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="n"&gt;m0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;La fonction de la blbliothÃ¨que standard est bien plus performante que l'implÃ©mentation proposÃ©e ci-dessus (et heureusement). On utilisera donc celle-ci pour la rÃ©solution du problÃ¨me : autant ne pas tendre le bÃ¢ton pour se faire battre.&lt;/p&gt;
&lt;h3&gt;RÃ©solution&lt;/h3&gt;
&lt;p&gt;On a vu que l'ensemble des solutions Ã©tait contenu dans l'ensemble des permutations de {1 ; 2 ; ... ; &lt;em&gt;n&lt;/em&gt; - 1}, soit l'ensemble des permutations de &lt;em&gt;n&lt;/em&gt; entiers distincts. De par cette modÃ©lisation :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;puisqu'on ne peut pas mettre deux valeurs au mÃªme index d'un tableau, les reines ne peuvent pas Ãªtre sur la mÃªme ligne ;&lt;/li&gt;
&lt;li&gt;par construction de l'ensemble sur lequel on initialise les permutations, aucune reine ne peut Ãªtre sur la mÃªme colonne qu'un autre.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Il reste alors Ã  appliquer directement la formule de vÃ©rification des diagonales proposÃ©e dans le paragraphe &lt;em&gt;ModÃ©lisation&lt;/em&gt;. Le code qui suit n'est volontairement pas l'Ã©criture Â« idÃ©ale Â» en Python par souci de lisibilitÃ© pour ceux qui n'y sont pas familiers.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;is_safe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="nb"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On initialise la premiÃ¨re permutation Ã  &lt;code&gt;[0, 1, 2, ..., n - 1]&lt;/code&gt; avec &lt;code&gt;range(n)&lt;/code&gt;. Une fois les permutations calculÃ©es, le cÃ¢blage de l'ensemble est immÃ©diat.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;solve&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;board_size&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;itertools&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;permutations&lt;/span&gt;
    &lt;span class="n"&gt;solutions&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;permutation&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;permutations&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;board_size&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;is_safe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;solutions&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;solutions&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;ReprÃ©sentation des solutions&lt;/h3&gt;
&lt;p&gt;Il est toujours plus simple de vÃ©rifier les solutions en les visualisant. &lt;a href="https://en.wikipedia.org/wiki/Eight_queens_puzzle#Counting_solutions"&gt;Le nombre de solutions en fonction du nombre de reines Ã©tant connu&lt;/a&gt;, on ajoute le nombre de solutions trouvÃ©es pour faciliter la validation de l'algorithme.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;print_solutions&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;solutions&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;board_size&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;separator&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;+---&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;board_size&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;+&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;solution&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;solutions&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;column&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;solution&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;separator&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;|   &amp;#39;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;column&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;| Q |&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;   |&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;board_size&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;column&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;separator&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Found&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;solutions&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;solutions&amp;quot;&lt;/span&gt;


&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;
&lt;span class="n"&gt;solutions&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;solve&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;print_solutions&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;solutions&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# 91 autres solutions
# [...]

+---+---+---+---+---+---+---+---+
|   |   |   |   |   |   |   | Q |
+---+---+---+---+---+---+---+---+
|   |   |   | Q |   |   |   |   |
+---+---+---+---+---+---+---+---+
| Q |   |   |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
|   |   | Q |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
|   |   |   |   |   | Q |   |   |
+---+---+---+---+---+---+---+---+
|   | Q |   |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
|   |   |   |   |   |   | Q |   |
+---+---+---+---+---+---+---+---+
|   |   |   |   | Q |   |   |   |
+---+---+---+---+---+---+---+---+

Found 92 solutions
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Il faut environ 60 ms pour obtenir l'intÃ©gralitÃ© des solutions et les reprÃ©senter.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ &lt;span class="nb"&gt;time&lt;/span&gt; python brute-force.py
python brute-force.py  &lt;span class="m"&gt;0&lt;/span&gt;,06s user &lt;span class="m"&gt;0&lt;/span&gt;,00s system &lt;span class="m"&gt;91&lt;/span&gt;% cpu &lt;span class="m"&gt;0&lt;/span&gt;,061 total
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pour cette dimension, c'est tout Ã  fait acceptable et on pourrait s'en contenter. On pourrait... mais Ã§a ne serait pas satisfaisant pour la curiositÃ© !&lt;/p&gt;
&lt;h2&gt;Seconde approche : algorithme de retour sur trace (&lt;em&gt;backtracking&lt;/em&gt;)&lt;/h2&gt;
&lt;p&gt;Cette classe d'algorithmes parcourt toutes les possibilitÃ©s en Ã©liminant d'emblÃ©e toute solution partielle qui ne convient pas. Il permet donc d'Ã©viter de n'avoir ne serait-ce qu'Ã  considÃ©rer de nombreuses combinaisons : il est en ce sens plus Ã©conome que l'algorithme de force brute. La rÃ©solution du problÃ¨me revient alors Ã  un parcours de graphe.&lt;/p&gt;
&lt;h3&gt;Exemple&lt;/h3&gt;
&lt;p&gt;Pour y voir plus clair, commenÃ§ons par un exemple simple. On souhaite obtenir les combinaisons de nÅ“uds permettant de former le mot Â« BLOG Â» en parcourant l'arbre. On continue de descendre dans l'arbre tant que la combinaison permet d'obtenir une solution (nÅ“uds bleus). DÃ¨s que celle-ci ne le permet plus (nÅ“ud rouge), on ignore les branches suivantes (nÅ“ud gris).&lt;/p&gt;
&lt;p&gt;Dans cet exemple, on n'obtient qu'une solution mais rien n'empÃªche d'en avoir plusieurs.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Exemple de backtracking" class="center" src="/images/eight_queens/backtracking.png"&gt;&lt;/p&gt;
&lt;h3&gt;RÃ©solution&lt;/h3&gt;
&lt;p&gt;On conserve la mÃªme modÃ©lisation : les &lt;em&gt;n&lt;/em&gt; reines sont rÃ©parties sur les &lt;em&gt;n&lt;/em&gt; lignes Ã  raison d'une par ligne. On place les reines une par une tant que cela est possible. Si le placement d'une reine Ã©choue â€” donc qu'il n'existe pas de position telle que la reine puisse Ãªtre en sÃ©curitÃ©, on remet en question les choix prÃ©cÃ©dents afin de sortir du blocage. On revient alors Ã  un point oÃ¹ des alternatives Ã©taient possibles et on essaie la possibilitÃ© suivante.&lt;/p&gt;
&lt;p&gt;L'arbre qui sera parcouru contient toutes les positions des reines, valides ou non. On a donc un arbre de la forme de la figure ci-dessous (tronquÃ©, dans l'exemple de 4 reines et d'un Ã©chiquier de 16 cases).&lt;/p&gt;
&lt;p&gt;&lt;img alt="Application du backtracking au problÃ¨me" class="center" src="/images/eight_queens/backtracking_queens.png"&gt;&lt;/p&gt;
&lt;p&gt;CommenÃ§ons par nous pencher sur la fonction indiquant si une reine est en sÃ©curitÃ©. Nous ne fonctionnons plus avec des permutations contenant toutes les positions des reines mais sur des positions partielles â€” avec un nombre de reines infÃ©rieur au nombre de reines total attendu â€” valides par rapport auxquelles on vÃ©rifie si l'on peut ajouter une reine Ã  une position donnÃ©e. PlutÃ´t que de vÃ©rifier systÃ©matiquement la validitÃ© de l'intÃ©gralitÃ© de la solution, on vÃ©rifie que l'ajout d'une reine Ã  la solution partielle prÃ©cÃ©dente donnÃ©e produit une solution valide.&lt;/p&gt;
&lt;p&gt;On teste donc :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;que la colonne que laquelle la reine a Ã©tÃ© placÃ©e n'est pas dÃ©jÃ  attribuÃ©e Ã  une autre reine en vÃ©rifiant que le tableau de solutions ne contient pas la colonne que l'on cherche Ã  attribuer (&lt;code&gt;not col in queens&lt;/code&gt;);&lt;/li&gt;
&lt;li&gt;qu'aucune reine ne se trouve sur les mÃªmes diagonales que la nouvelle.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;is_safe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;col&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;col&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;queens&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt;
            &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="nb"&gt;any&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;col&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;enumerate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Passons Ã  la rÃ©solution en elle-mÃªme. Pour chaque nouvelle ligne, nous allons tester l'intÃ©gralitÃ© des colonnes au regard des solutions obtenues jusqu'Ã  la ligne prÃ©cÃ©dente. Cela donne :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;solve&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c1"&gt;# Initialisation des solutions pour une taille 0 (tableau contenant un tableau vide)&lt;/span&gt;
    &lt;span class="n"&gt;solutions&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;row&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;solutions&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;solution&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;solution&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;solutions&lt;/span&gt;
                                    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                                    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;is_safe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;solution&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;solutions&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pour mieux comprendre cet algorithme, il en existe une &lt;a href="https://www.cs.usfca.edu/~galles/visualization/RecQueens.html"&gt;version animÃ©e dÃ©taillant les Ã©tapes de la rÃ©solution&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;TroisiÃ¨me approche : programmation par contraintes&lt;/h2&gt;
&lt;h3&gt;Principe&lt;/h3&gt;
&lt;p&gt;Un problÃ¨me de satisfaction de contraintes (ou CSP pour &lt;em&gt;Constraint Satisfaction Problem&lt;/em&gt;) dÃ©signe l'ensemble des problÃ¨mes dÃ©finis par... des contraintes. La rÃ©solution consiste Ã  chercher &lt;em&gt;une&lt;/em&gt; solution les respectant. Pour cela, on dÃ©crit un modÃ¨le dÃ©finit par :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;un ensemble de variables ;&lt;/li&gt;
&lt;li&gt;un ensemble de contraintes rÃ©gissant ces variables.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Ã€ partir de ce modÃ¨le, le systÃ¨me cherchera une solution et la proposera si elle existe. En revanche, il ne proposera qu'une seule solution : la rÃ©solution d'un problÃ¨me par contraintes n'a pas vocation Ã  chercher l'ensemble exhaustif des solutions.&lt;/p&gt;
&lt;h3&gt;ImplÃ©mentation&lt;/h3&gt;
&lt;p&gt;En Python, la bibliothÃ¨que &lt;a href="http://numberjack.ucc.ie"&gt;Numberjack&lt;/a&gt; facilite la programmation par contraintes. Les auteurs fournissent d'ailleurs Ã  titre d'exemple une &lt;a href="http://numberjack.ucc.ie/examples/nqueens"&gt;solution pour le problÃ¨me des &lt;em&gt;n&lt;/em&gt; reines&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Dans le cas gÃ©nÃ©rique des &lt;em&gt;n&lt;/em&gt; reines, on dÃ©finit dans notre ensemble de variables les reines. Chacun d'elles est de type &lt;code&gt;Variable(n)&lt;/code&gt;, soit une variable dans un domaine compris entre 0 et &lt;em&gt;n&lt;/em&gt;. La contrainte &lt;code&gt;AllDiff&lt;/code&gt; impose Ã  toutes les expressions qui lui sont passÃ©es d'Ãªtres diffÃ©rentes. On impose donc :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;que toutes les reines soient dans des colonnes diffÃ©rentes (&lt;code&gt;AllDiff( queens )&lt;/code&gt;) ;&lt;/li&gt;
&lt;li&gt;que toutes les reines soient sur des diagonales diffÃ©rentes (combinaison de &lt;code&gt;AllDiff( [queens[i] + i for i in range(n)] )&lt;/code&gt; et &lt;code&gt;AllDiff( [queens[i] - i for i in range(n)] )&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On suppose donc ici aussi que chaque reine est sur une ligne distincte : la reine 0 sera sur la ligne 0, la reine 1 sur la ligne 1, etc.&lt;/p&gt;
&lt;p&gt;La description du modÃ¨le devient :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;Numberjack&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;model_queens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;queens&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Variable&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
    &lt;span class="n"&gt;model&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;AllDiff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;queens&lt;/span&gt; &lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="n"&gt;AllDiff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="n"&gt;AllDiff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;La rÃ©solution du problÃ¨me est alors immÃ©diate :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;solve_queens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;n&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;model_queens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;solver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;param&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;solver&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="n"&gt;solver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;solve&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;print_chessboard&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Nodes:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;solver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getNodes&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39; Time:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;solver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getTime&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;print_chessboard&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;separator&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;+---&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;+&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;queen&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;separator&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;|   &amp;#39;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;queen&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_value&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;| Q |&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;   |&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;queen&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_value&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;separator&lt;/span&gt;

&lt;span class="n"&gt;solve_queens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;solver&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Mistral&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;n&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt; &lt;span class="p"&gt;}))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;La proposition d'une solution est Ã©galement trÃ¨s rapide :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="c1"&gt;---+---+---+---+---+---+---+---+&lt;/span&gt;
&lt;span class="n"&gt;Nodes&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;24&lt;/span&gt;  &lt;span class="n"&gt;Time&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Une mesure plus fine du temps d'exÃ©cution indique qu'il a fallu environ 20 millisecondes pour proposer cette solution (qui inclut le temps d'exÃ©cution total du programme Python).&lt;/p&gt;
&lt;h2&gt;Comparaison des approches&lt;/h2&gt;
&lt;p&gt;On a vu trois mÃ©thodes diffÃ©rentes de rÃ©solution du problÃ¨me. Parmi elles, seules deux fournissent l'intÃ©gralitÃ© des solutions et donc rÃ©pondent rÃ©ellement au problÃ¨me. La rÃ©solution par force brute est probablement la plus lisible mais Ã©galment la moins efficace. La solution par retour arriÃ¨re est lÃ©gÃ¨rement plus complexe mais sa durÃ©e de rÃ©solution, bien plus faible, la rend nettement plus avantageuse pour un Â« grand Â» Ã©chiquier.&lt;/p&gt;
&lt;table class="table"&gt;
  &lt;caption&gt;Comparaison des algorithmes pour une rÃ©solution avec 8 reines sur un Ã©chiquier de 64 cases&lt;/caption&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Algorithme&lt;/th&gt;
      &lt;th&gt;DurÃ©e d'exÃ©cution&lt;/th&gt;
      &lt;th&gt;Nombre de solutions&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Force brute&lt;/td&gt;
      &lt;td&gt;83 ms&lt;/td&gt;
      &lt;td&gt;92&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Retour sur trace&lt;/td&gt;
      &lt;td&gt;55 ms&lt;/td&gt;
      &lt;td&gt;92&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Programmation par contraintes&lt;/td&gt;
      &lt;td&gt;18 ms&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Comme le montre le tableau ci-dessus, le choix de la mÃ©thode de rÃ©solution dÃ©pendra surtout du besoin : faut-il &lt;em&gt;une&lt;/em&gt; solution ou &lt;em&gt;toutes&lt;/em&gt; les solutions ? Lorsqu'il les faut toutes, les quelques dizaines de millisecondes d'Ã©cart entre les deux algorithmes ne font pas la diffÃ©rence pour huit reines. En revanche, l'augmentation de la taille de l'Ã©chiquier induit une augmentation exponentielle du temps de rÃ©solution. Le graphique ci-dessous montre la flagrance de diffÃ©rence de temps d'exÃ©cution entre les deux algorithmes lorsque le nombre de permutations augmente.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Comparaison des durÃ©es d'obtention de toutes les solutions en fonction de l'algorithme" class="center" src="/images/eight_queens/comparaison.png"&gt;&lt;/p&gt;
&lt;p&gt;DÃ¨s 10 reines et un Ã©chiquier de 100 cases, l'algorithme de force brute n'est plus utilisable : il lui faut plusieurs dizaines de minutes pour fournir les solutions. La solution implÃ©mentant l'algorithme de &lt;em&gt;backtracking&lt;/em&gt;, elle, retourne les 14&amp;nbsp;200 solutions en moins de 10 secondes.&lt;/p&gt;
&lt;p&gt;La rÃ©solution par contraintes, reste trÃ¨s performante lorsque le problÃ¨me de complexifie : elle permet d'obtenir une solution en moins de 150&amp;nbsp;ms pour 200 reines et un Ã©chiquier de 40&amp;nbsp;000 cases. Bien qu'elle ne propose qu'une et une seule solution, elle peut s'avÃ©rer pertinente lorsqu'on ne cherche pas un rÃ©sultat particulier. L'implÃ©mentation prÃ©sentÃ©e ici monte ses limites en dÃ©passant les 500 reines et les 250 000 cases.&lt;/p&gt;</content><category term="algorithmique"></category><category term="python"></category><category term="jeu"></category></entry><entry><title>Utiliser un Raspberry Pi comme point d'accÃ¨s Wifi</title><link href="https://www.dericbourg.net/2015/07/04/utiliser-un-raspberry-pi-comme-point-dacces-wifi/" rel="alternate"></link><published>2015-07-04T00:00:00+02:00</published><updated>2015-07-04T00:00:00+02:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2015-07-04:/2015/07/04/utiliser-un-raspberry-pi-comme-point-dacces-wifi/</id><summary type="html">&lt;p&gt;Dans cet article, nous verrons comment configurer un Raspberry Pi en tant que
point d'accÃ¨s Wifi.&lt;/p&gt;
&lt;h2&gt;PrÃ©-requis&lt;/h2&gt;
&lt;p&gt;Je supposerai que vous avez Ã  disposition :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/"&gt;Un Raspberry Pi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;La distribution &lt;a href="https://www.raspbian.org/"&gt;Raspbian&lt;/a&gt; ou toute autre
  distribution Linux&lt;/li&gt;
&lt;li&gt;Un &lt;em&gt;dongle&lt;/em&gt; Wifi (dÃ©jÃ  installÃ© et dÃ©tectÃ©)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Dans la suite, on considÃ¨rera que l'interface sans â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;Dans cet article, nous verrons comment configurer un Raspberry Pi en tant que
point d'accÃ¨s Wifi.&lt;/p&gt;
&lt;h2&gt;PrÃ©-requis&lt;/h2&gt;
&lt;p&gt;Je supposerai que vous avez Ã  disposition :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/"&gt;Un Raspberry Pi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;La distribution &lt;a href="https://www.raspbian.org/"&gt;Raspbian&lt;/a&gt; ou toute autre
  distribution Linux&lt;/li&gt;
&lt;li&gt;Un &lt;em&gt;dongle&lt;/em&gt; Wifi (dÃ©jÃ  installÃ© et dÃ©tectÃ©)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Dans la suite, on considÃ¨rera que l'interface sans fil est nommÃ©e &lt;code&gt;wlan0&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;DÃ©finition d'une adresse IP statique&lt;/h2&gt;
&lt;p&gt;Dans le fichier &lt;code&gt;/etc/network/interfaces&lt;/code&gt;, supprimer les lignes suivantes :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;iface&lt;/span&gt; &lt;span class="n"&gt;wlan0&lt;/span&gt; &lt;span class="n"&gt;inet&lt;/span&gt; &lt;span class="n"&gt;manual&lt;/span&gt;
&lt;span class="n"&gt;wpa&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;roam&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;wpa_supplicant&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;wpa_supplicant&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Les remplacer par :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;allow&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;hotplug&lt;/span&gt; &lt;span class="n"&gt;wlan0&lt;/span&gt;
&lt;span class="n"&gt;iface&lt;/span&gt; &lt;span class="n"&gt;wlan0&lt;/span&gt; &lt;span class="n"&gt;inet&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt;
&lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;168&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="n"&gt;netmask&lt;/span&gt; &lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;RedÃ©marrez le rÃ©seau :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt; &lt;span class="n"&gt;networking&lt;/span&gt; &lt;span class="k"&gt;restart&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Installation d'un serveur DHCP&lt;/h2&gt;
&lt;p&gt;Le serveur DHCP permet d'attribuer automatiquement une adresse IP aux machines
qui se connecteront Ã  votre rÃ©seau Wifi.&lt;/p&gt;
&lt;p&gt;Installez le paquet &lt;em&gt;&lt;a href="https://packages.debian.org/isc-dhcp-server"&gt;isc-dhcp-server&lt;/a&gt;&lt;/em&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;apt&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;get&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="n"&gt;isc&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;dhcp&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ã€ ce stade, le service ne devrait pas dÃ©marrer correctement :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;Generating&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="nv"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="nv"&gt;default&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="nv"&gt;isc&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nv"&gt;dhcp&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nv"&gt;server&lt;/span&gt;...
[&lt;span class="nv"&gt;FAIL&lt;/span&gt;] &lt;span class="nv"&gt;Starting&lt;/span&gt; &lt;span class="nv"&gt;ISC&lt;/span&gt; &lt;span class="nv"&gt;DHCP&lt;/span&gt; &lt;span class="nv"&gt;server&lt;/span&gt;: &lt;span class="nv"&gt;dhcpd&lt;/span&gt;[....] &lt;span class="nv"&gt;check&lt;/span&gt; &lt;span class="nv"&gt;syslog&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nv"&gt;diagnostics&lt;/span&gt;. ... &lt;span class="nv"&gt;failed&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;
 &lt;span class="nv"&gt;failed&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;
&lt;span class="nv"&gt;invoke&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nv"&gt;rc&lt;/span&gt;.&lt;span class="nv"&gt;d&lt;/span&gt;: &lt;span class="nv"&gt;initscript&lt;/span&gt; &lt;span class="nv"&gt;isc&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nv"&gt;dhcp&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nv"&gt;server&lt;/span&gt;, &lt;span class="nv"&gt;action&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;start&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;failed&lt;/span&gt;.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Vous pouvez ignorer ces erreurs pour le moment.&lt;/p&gt;
&lt;p&gt;Ã‰ditez le fichier de configuration du serveur : &lt;code&gt;/etc/dhcp/dhcpd.conf&lt;/code&gt; et
commentez les options &lt;em&gt;domain-name&lt;/em&gt; et &lt;em&gt;domain-name-servers&lt;/em&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="k"&gt;option&lt;/span&gt; &lt;span class="k"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="ss"&gt;&amp;quot;example.org&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="k"&gt;option&lt;/span&gt; &lt;span class="k"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;servers&lt;/span&gt; &lt;span class="n"&gt;ns1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;org&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ns2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;org&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;DÃ©commentez la ligne &lt;em&gt;authoritative&lt;/em&gt;. Cela permet d'indiquer Ã  votre serveur
DHCP qu'il est le seul Ã  fournir des adresses IP sur ce rÃ©seau et donc possÃ¨de
la pleine connaissance des
&lt;a href="http://www.linux-france.org/prj/edu/archinet/systeme/ch27s03.html"&gt;baux accordÃ©s&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# &lt;span class="k"&gt;If&lt;/span&gt; &lt;span class="nv"&gt;this&lt;/span&gt; &lt;span class="nv"&gt;DHCP&lt;/span&gt; &lt;span class="nv"&gt;server&lt;/span&gt; &lt;span class="nv"&gt;is&lt;/span&gt; &lt;span class="nv"&gt;the&lt;/span&gt; &lt;span class="nv"&gt;official&lt;/span&gt; &lt;span class="nv"&gt;DHCP&lt;/span&gt; &lt;span class="nv"&gt;server&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nv"&gt;the&lt;/span&gt; &lt;span class="nv"&gt;local&lt;/span&gt;
# &lt;span class="nv"&gt;network&lt;/span&gt;, &lt;span class="nv"&gt;the&lt;/span&gt; &lt;span class="nv"&gt;authoritative&lt;/span&gt; &lt;span class="nv"&gt;directive&lt;/span&gt; &lt;span class="nv"&gt;should&lt;/span&gt; &lt;span class="nv"&gt;be&lt;/span&gt; &lt;span class="nv"&gt;uncommented&lt;/span&gt;.
&lt;span class="nv"&gt;authoritative&lt;/span&gt;&lt;span class="c1"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Enfin, configurez le comportement du serveur DHCP :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;subnet&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;168&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;netmask&lt;/span&gt; &lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="err"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;range&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;168&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;168&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;option&lt;/span&gt; &lt;span class="n"&gt;broadcast&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;168&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;option&lt;/span&gt; &lt;span class="n"&gt;routers&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;168&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;default&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;lease&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="mi"&gt;600&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;max&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;lease&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="mi"&gt;7200&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;option&lt;/span&gt; &lt;span class="k"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="ss"&gt;&amp;quot;local&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;option&lt;/span&gt; &lt;span class="k"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;servers&lt;/span&gt; &lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;67&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;169&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="err"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Le paramÃ¨tre &lt;em&gt;range&lt;/em&gt; limite la place d'adresses IP qui seront alouÃ©es. On en
permet ici 51 : c'est probablement beaucoup (trop) s'il s'agit de votre rÃ©seau
personnel.&lt;/p&gt;
&lt;p&gt;L'option &lt;em&gt;broadcast-address&lt;/em&gt; spÃ©cifie l'adresse IP telle que les paquets qui
seront envoyÃ©s sur cette adresse seront interceptÃ©s par toutes les machines
prÃ©sentes sur ce rÃ©seau (ayant donc une IP entre 192.166.100.1 et
192.168.100.254 car le masque de sous rÃ©seau est 255.255.255.0).&lt;/p&gt;
&lt;p&gt;Quant Ã  elle, l'option &lt;em&gt;routers&lt;/em&gt; indique l'adresse de la passerelle, c'est Ã 
dire la machine par laquelle passent tous les paquets sortants du rÃ©seau (en
direction ou en provenance d'Internet par exemple).&lt;/p&gt;
&lt;p&gt;On attribue ici un bail pour une durÃ©e de 600 secondes avec le paramÃ¨tre
&lt;em&gt;default-lease-time&lt;/em&gt;. C'est cette durÃ©e qui sera utilisÃ©e si le client ne
prÃ©cise rien. S'il demande un bail en prÃ©cisant une durÃ©e, celle-ci lui sera
accordÃ©e si elle ne dÃ©passe pas 7200 secondes, comme dÃ©fini avec le paramÃ¨tre
&lt;em&gt;max-lease-time&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Cet exemple utilise le DNS de &lt;a href="https://www.fdn.fr"&gt;FDN&lt;/a&gt; (ligne &lt;em&gt;domain-name-servers&lt;/em&gt;).
Vous pouvez bien Ã©videmment en utiliser d'autres (certains prÃ©fÃ¨rent
&lt;a href="https://developers.google.com/speed/public-dns/"&gt;ceux de Google&lt;/a&gt;...).&lt;/p&gt;
&lt;p&gt;DÃ©clarez enfin l'interface sans fil comme l'interface par dÃ©faut pour rÃ©pondre
aux requÃªtes DHCP dans le fichier &lt;code&gt;/etc/default/isc-dhcp-server&lt;/code&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt; &lt;span class="k"&gt;On&lt;/span&gt; &lt;span class="n"&gt;what&lt;/span&gt; &lt;span class="n"&gt;interfaces&lt;/span&gt; &lt;span class="n"&gt;should&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;DHCP&lt;/span&gt; &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dhcpd&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;serve&lt;/span&gt; &lt;span class="n"&gt;DHCP&lt;/span&gt; &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;
&lt;span class="o"&gt;#&lt;/span&gt;       &lt;span class="n"&gt;Separate&lt;/span&gt; &lt;span class="n"&gt;multiple&lt;/span&gt; &lt;span class="n"&gt;interfaces&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;spaces&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="k"&gt;g&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="ss"&gt;&amp;quot;eth0 eth1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;INTERFACES&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;INTERFACES&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;wlan0&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Installation de &lt;em&gt;hostapd&lt;/em&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://w1.fi/hostapd/"&gt;Hostapd&lt;/a&gt; est un dÃ©mon permettant de crÃ©er un point
d'accÃ¨s sans fil. Pour l'installer :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;apt&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;get&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="n"&gt;hostapd&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;CrÃ©ez son fichier de configuration, &lt;code&gt;/etc/hostapd/hostapd.conf&lt;/code&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;interface&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;wlan0&lt;/span&gt;
&lt;span class="n"&gt;driver&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;nl80211&lt;/span&gt;
&lt;span class="n"&gt;ssid&lt;/span&gt;&lt;span class="o"&gt;=&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;YOUR&lt;/span&gt; &lt;span class="n"&gt;SSID&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;hw_mode&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;g&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;
&lt;span class="n"&gt;macaddr_acl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;auth_algs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="n"&gt;ignore_broadcast_ssid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;wpa&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="n"&gt;wpa_passphrase&lt;/span&gt;&lt;span class="o"&gt;=&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;YOUR&lt;/span&gt; &lt;span class="n"&gt;PASSPHRASE&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;wpa_key_mgmt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;WPA&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;PSK&lt;/span&gt;
&lt;span class="n"&gt;wpa_pairwise&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;TKIP&lt;/span&gt;
&lt;span class="n"&gt;rsn_pairwise&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;CCMP&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remplacez dans cet exemple :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;YOUR SSID&amp;gt;&lt;/code&gt; par le nom que vous souhaitez donner Ã  votre rÃ©seau ;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;YOUR PASSPHRASE&amp;gt;&lt;/code&gt; par le mot de passer permettant l'accÃ¨s au rÃ©seau.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;DÃ©clarez enfin ce fichier afin qu'il soit utilisÃ© par hostapd dans
&lt;code&gt;/etc/default/hostapd&lt;/code&gt; en ajoutant la ligne :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;DAEMON_CONF&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="ss"&gt;&amp;quot;/etc/hostapd/hostapd.conf&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Configuration du routage entre l'interface sans fil et l'interface filaire&lt;/h2&gt;
&lt;p&gt;Activer le routage IP dans le fichier &lt;code&gt;/etc/sysctl.conf&lt;/code&gt; en dÃ©commentant la
ligne suivante :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;net&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ipv4&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ip_forward&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pour activer ce routage immÃ©diatement (sans avoir besoin de redÃ©marrer), lancez
la commande :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;sh&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;c&lt;/span&gt; &lt;span class="ss"&gt;&amp;quot;echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Vous pouvez enfin configurer le routage en utilisant
&lt;em&gt;&lt;a href="http://ipset.netfilter.org/iptables.man.html"&gt;iptables&lt;/a&gt;&lt;/em&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;iptables&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="n"&gt;nat&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="n"&gt;POSTROUTING&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;o&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="n"&gt;MASQUERADE&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;iptables&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="k"&gt;FORWARD&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;o&lt;/span&gt; &lt;span class="n"&gt;wlan0&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="k"&gt;state&lt;/span&gt; &lt;span class="c1"&gt;--state RELATED,ESTABLISHED -j ACCEPT&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;iptables&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="k"&gt;FORWARD&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="n"&gt;wlan0&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;o&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="n"&gt;ACCEPT&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Persistence des rÃ¨gles &lt;em&gt;iptables&lt;/em&gt;&lt;/h2&gt;
&lt;p&gt;Les rÃ¨gles &lt;em&gt;iptables&lt;/em&gt; dÃ©finies prÃ©cÃ©demment sont perdues au au redÃ©marrage. Pour
les recharger Ã  chaque lancement de la machine, vous pouvez utiliser le paquet
&lt;em&gt;&lt;a href="https://packages.debian.org/iptables-persistent"&gt;iptables-persistent&lt;/a&gt;&lt;/em&gt;. Pour
l'installer :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="n"&gt;apt&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;get&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="n"&gt;iptables&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;persistent&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Par dÃ©faut, il demandera si vous souhaitez enregistrer les rÃ¨gles actuellement
dÃ©finies. Choisissez Â« oui Â». Si vous souhaitez les redÃ©finir ultÃ©rieurement,
vous pourrez les enregistrer en invoquant la cible &lt;em&gt;save&lt;/em&gt; et les recharger avec
&lt;em&gt;reload&lt;/em&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;iptables&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;persistent&lt;/span&gt; &lt;span class="n"&gt;save&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;iptables&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;persistent&lt;/span&gt; &lt;span class="n"&gt;reload&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;La voie est libre&lt;/h2&gt;
&lt;p&gt;Ã€ ce stade, vous deviez Ãªtre en mesure de vous connecter au point d'accÃ¨s de
faÃ§on transparente. Ã‰tant donnÃ©e la richesse des matÃ©riels et leurs
spÃ©cificitÃ©s, je ne garantis pas que ce Â« mode d'emploi Â» soit universel.
J'espÃ¨re nÃ©anmoins qu'il vous aura aidÃ© en premiÃ¨re approche Ã  monter votre
propre point d'accÃ¨s Wifi.&lt;/p&gt;</content><category term="wifi"></category><category term="raspberrypi"></category><category term="linux"></category><category term="iptables"></category></entry><entry><title>Utiliser un certificat signÃ© par une autoritÃ© inconnue en Java</title><link href="https://www.dericbourg.net/2015/06/22/utiliser-un-certificat-signe-par-une-autorite-inconnue-en-java/" rel="alternate"></link><published>2015-06-22T00:00:00+02:00</published><updated>2015-06-22T00:00:00+02:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2015-06-22:/2015/06/22/utiliser-un-certificat-signe-par-une-autorite-inconnue-en-java/</id><summary type="html">&lt;p&gt;Lorsque vous vous connectez Ã  un serveur en utilisant un certificat TLS (le grand frÃ¨re de SSL depuis une quinzaine d'annÃ©es), votre client en vÃ©rifie la signature. Celle-ci permet de vÃ©rifier que :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;celui-ci provient bien d'un Ã©metteur connu ;&lt;/li&gt;
&lt;li&gt;qu'il n'a pas Ã©tÃ© modifiÃ© depuis son Ã©mission.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Le doute&lt;/h2&gt;
&lt;p&gt;Il arrive â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;Lorsque vous vous connectez Ã  un serveur en utilisant un certificat TLS (le grand frÃ¨re de SSL depuis une quinzaine d'annÃ©es), votre client en vÃ©rifie la signature. Celle-ci permet de vÃ©rifier que :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;celui-ci provient bien d'un Ã©metteur connu ;&lt;/li&gt;
&lt;li&gt;qu'il n'a pas Ã©tÃ© modifiÃ© depuis son Ã©mission.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Le doute&lt;/h2&gt;
&lt;p&gt;Il arrive que le certificat soit signÃ© en utilisant un certificat qui est lui-mÃªme signÃ© par un autre certificat, lui-mÃªme encore signÃ© par... bref : la signature peut remonter sur plusieurs niveaux hiÃ©rarchiques. Dans les faits, cela ne change pas grand chose : la vÃ©rification sera tout simplement rÃ©cursive. Le tout est de rencontrer dans la chaÃ®ne, gÃ©nÃ©ralement Â« tout en haut Â» la signature issue d'un certificat faisant autoritÃ©. Ces autoritÃ©s sont connues Ã  l'avance et vous pouvez les vÃ©rifier dans les paramÃ¨tres de votre navigateur ou, par exemple, dans le rÃ©pertoire &lt;code&gt;/etc/ssl/certs&lt;/code&gt; si vous Ãªtes sous Linux.&lt;/p&gt;
&lt;p&gt;Il s'agit donc d'une liste fermÃ©e qui vous a Ã©tÃ© fournie par un biais ou un autre mais surtout par en biais en lequel vous avez confiance (ou en lequel on vous a obligÃ© Ã  avoir confiance). Mais rien n'oblige qui que ce soit Ã  utiliser l'une de ces autoritÃ©s racines : on peut Ã©galement utiliser un certificat auto-signÃ©. Dans ce cas, rien ne permet de garantir avec certitude l'Ã©metteur : au mÃªme titre que vous ferez confiance en l'identitÃ© de quelqu'un s'il vous prÃ©sente sa carte d'identitÃ© Ã©ditÃ©e par l'Ã‰tat, vous aurez probablement des doutes si l'on ne vous prÃ©sente qu'un papier signÃ© par la-dite personne affirmant sa bonne foi.&lt;/p&gt;
&lt;p&gt;Dans la Â« vraie vie Â», ce n'est pas parce qu'un individu n'est pas en mesure de vous prÃ©senter un document officiel d'identitÃ© qu'il est malhonnÃªte. S'il vous prÃ©sente son badge d'accÃ¨s Ã  l'entreprise dans laquelle vous travaillez, vous lui ferez confiance et saurez que c'est l'un de vos collÃ¨gues. Dans ce cas, c'est votre entreprise qui fait autoritÃ© et vous faites confiance Ã  son processus d'attribution des badges. De la mÃªme faÃ§on, un serveur qui utilise un certificat qui n'est pas signÃ© par une autoritÃ© reconnue peut tout Ã  fait venir en paix avec de bonnes intentions.&lt;/p&gt;
&lt;p&gt;Un certificat acceptÃ© et reconnu dans un environnement restreint est donc prÃ©fÃ©rable Ã  pas de certificat du tout.&lt;/p&gt;
&lt;h2&gt;L'arrivÃ©e des problÃ¨mes&lt;/h2&gt;
&lt;p&gt;Mais, gÃ©nÃ©ralement, lorsque votre client ne connaÃ®t pas l'autoritÃ© de certification racine, il refuse par dÃ©faut la connexion :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ curl -v https://www.exemple.com
* Rebuilt URL to: https://www.example.com/
* Hostname was NOT found in DNS cache
*   Trying &lt;span class="m"&gt;1&lt;/span&gt;.2.3.4...
* Connected to www.example.com &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.2.3.4&lt;span class="o"&gt;)&lt;/span&gt; port &lt;span class="m"&gt;443&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="c1"&gt;#0)&lt;/span&gt;
* successfully &lt;span class="nb"&gt;set&lt;/span&gt; certificate verify locations:
*   CAfile: none
    CApath: /etc/ssl/certs
* SSLv3, TLS handshake, Client hello &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;:
* SSLv3, TLS handshake, Server hello &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;:
* SSLv3, TLS handshake, CERT &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;11&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;:
* SSLv3, TLS alert, Server hello &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;:
* SSL certificate problem: unable to get &lt;span class="nb"&gt;local&lt;/span&gt; issuer certificate
* Closing connection &lt;span class="m"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Comment se connecter, alors ?&lt;/h2&gt;
&lt;p&gt;Face Ã  cela (ignorons la &lt;a href="https://fr.wikipedia.org/wiki/POODLE"&gt;rÃ©fÃ©rence Ã  SSLv3&lt;/a&gt; pour l'instant), deux options sont possibles (la troisiÃ¨me, refiler le bÃ©bÃ© Ã  votre collÃ¨gue, n'Ã©tant pas traitÃ©e ici) :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ignorer les doutes quant au certificat et risquer de communiquer des informations sensibles Ã  un tiers
  (c'est la porte ouverte Ã  une
  &lt;a href="https://fr.wikipedia.org/wiki/Attaque_de_l%27homme_du_milieu"&gt;attaque de l'homme du milieu&lt;/a&gt;
  puisque vous ne vÃ©rifiez plus du tout avec qui vous Ã©changez des donnÃ©es) ;&lt;/li&gt;
&lt;li&gt;indiquer que l'on connaÃ®t l'autoritÃ© racine ou l'une des autoritÃ©s intermÃ©diaires.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Je ne peux que vous dÃ©conseiller avec toute la vigueur qui m'est donnÃ©e la premiÃ¨re solution et vous apporter tout mon soutien pour la seconde.&lt;/p&gt;
&lt;p&gt;Pour reprendre l'exemple ci-dessus, l'appel avec &lt;code&gt;curl&lt;/code&gt; est simplement complÃ©tÃ© avec l'option &lt;code&gt;--cacert&lt;/code&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;curl -v https://www.example.com --cacert cert.pem
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Depuis une application Java&lt;/h2&gt;
&lt;p&gt;Le mÃªme mÃ©canisme s'applique lorsque vous vous connectez Ã  un service en utilisant une application Java. Si le certificat n'est pas sÃ»r, vous vous verrez refuser la connexion :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;sun&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="k"&gt;security&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;provider&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;certpath&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SunCertPathBuilderException&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;unable&lt;/span&gt; &lt;span class="k"&gt;to&lt;/span&gt; &lt;span class="n"&gt;find&lt;/span&gt; &lt;span class="k"&gt;valid&lt;/span&gt; &lt;span class="n"&gt;certification&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="k"&gt;to&lt;/span&gt; &lt;span class="n"&gt;requested&lt;/span&gt; &lt;span class="n"&gt;target&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Tout comme avec &lt;code&gt;curl&lt;/code&gt;, il existe une option pour spÃ©cifier un certificat faisant autoritÃ©. Il faut avant tout le stocker dans un conteneur spÃ©cifique Ã  la JVM puis de prÃ©ciser son emplacement dans la propriÃ©tÃ© systÃ¨me &lt;code&gt;javax.net.ssl.trustStore&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Pour crÃ©er ce conteneur, on utilise l'outil &lt;code&gt;keytool&lt;/code&gt; fourni avec le JDK.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ keytool -importcert -file cert.cer -keystore keystore.jks
Entrez le mot de passe du fichier de clÃ©s :
Ressaisissez le nouveau mot de passe :
&lt;span class="c1"&gt;# Ici s&amp;#39;affichent les dÃ©tails du certificat que vous importez&lt;/span&gt;
Faire confiance Ã  ce certificat ? &lt;span class="o"&gt;[&lt;/span&gt;non&lt;span class="o"&gt;]&lt;/span&gt; :  oui
Certificat ajoutÃ© au fichier de clÃ©s
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Reste Ã  le dÃ©clarer dans votre application :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;setProperty&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;javax.net.ssl.trustStore&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;/path/to/keystore.jks&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;setProperty&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;javax.net.ssl.trustStorePassword&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;******);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;La propriÃ©tÃ© &lt;code&gt;javax.net.ssl.trustStorePassword&lt;/code&gt; correspond au mot de passe que vous avez saisi Ã  l'import du certificat en utilisant &lt;code&gt;keytool&lt;/code&gt;. DÃ¨s lors, vous pouvez vous connecter aux services sÃ©curisÃ©s utilisant un certificat propre Ã  votre entreprise.&lt;/p&gt;
&lt;h2&gt;Solution globale&lt;/h2&gt;
&lt;p&gt;Il peut Ãªtre pÃ©nible d'utiliser ce morceau de code dans chacune de vos applications, ou tout au moins fastidieux. Heureusement, il est Ã©galement possible d'enregistrer un certificat au niveau de la JVM. On le dÃ©clare alors une bonne fois pour toutes.&lt;/p&gt;
&lt;p&gt;Si vous avez parcouru le rÃ©pertoire &lt;code&gt;/etc/ssl/certs&lt;/code&gt; Ã©voquÃ© au dÃ©but de cet article, vous y aurez peut-Ãªtre remarquÃ© un rÃ©pertoire &lt;code&gt;java&lt;/code&gt;. Il s'agit du portefeuille de certificats dÃ©diÃ© Ã  la JVM.&lt;/p&gt;
&lt;p&gt;Pour y ajouter un certificat, lancez en tant qu'utilisateur privilÃ©giÃ© (&lt;em&gt;root&lt;/em&gt;) :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;keytool -import -alias CertificatDeMonEntreprise &lt;span class="se"&gt;\&lt;/span&gt;
  -keypass changeit &lt;span class="se"&gt;\&lt;/span&gt;
  -keystore &lt;span class="nv"&gt;$JAVA_HOME&lt;/span&gt;/jre/lib/security/cacerts &lt;span class="se"&gt;\&lt;/span&gt;
  -file cert.pem
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Notez le mot de passe par dÃ©faut du &lt;em&gt;keystore&lt;/em&gt;: Â« changeit Â». Il s'agit du mot de passe par dÃ©faut et je vous encourage, si ce n'est dÃ©jÃ  fait, Ã  le changer.&lt;/p&gt;
&lt;p&gt;Cette opÃ©ration est Ã  rÃ©aliser sur votre machine de dÃ©veloppement mais Ã©galement sur l'intÃ©gralitÃ© des serveurs susceptibles d'exÃ©cuter vos applications. C'est lÃ  qu'une solution de dÃ©ploiement automatique devient pertinente.&lt;/p&gt;
&lt;p&gt;Vous Ãªtes maintenant capable de vous connecter depuis une application Java Ã  l'ensemble des services exposÃ©s avec le certificat TLS de votre entreprise et ce sans nÃ©cessiter d'adaptation du code.&lt;/p&gt;
&lt;h2&gt;Depuis une application Java (bis)&lt;/h2&gt;
&lt;p&gt;Si, par malheur, vous ne pouvez pas dÃ©poser de fichier sur la machine exÃ©cutant votre application (c'est le cas sur certains hÃ©bergement Â« cloud Â» que je n'aime pas utiliser), vous pouvez toujours Â« stocker Â» votre &lt;em&gt;keystore&lt;/em&gt; dans votre livrable (jar, war...). Mais... vous ne pourrez pas l'utiliser directement : la propriÃ©tÃ© &lt;code&gt;javax.net.ssl.trustStore&lt;/code&gt; ne permet pas de dÃ©clarer de rÃ©fÃ©rence Ã  un fichier dans le &lt;em&gt;package&lt;/em&gt;. On peut en revanche l'Ã©crire Â« Ã  la main Â» sur le disque. L'exemple qui suit utilise &lt;a href="https://github.com/google/guava"&gt;Guava&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="n"&gt;tempDir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Files&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;createTempDir&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="n"&gt;myStore&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;File&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tempDir&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;keystore.jks&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;InputStream&lt;/span&gt; &lt;span class="n"&gt;storeStream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MyExample&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getClassLoader&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;getResourceAsStream&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;keystore.jks&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
     &lt;span class="n"&gt;FileOutputStream&lt;/span&gt; &lt;span class="n"&gt;outputStream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;FileOutputStream&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myStore&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;ByteStreams&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;copy&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;storeStream&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;outputStream&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;setProperty&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;javax.net.ssl.trustStore&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;myStore&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getAbsolutePath&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
        &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;setProperty&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;javax.net.ssl.trustStorePassword&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*******);&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IOException&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;error&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Cannot set trust store&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;VoilÃ  qui devrait vous permettre de communiquer avec le reste du monde.&lt;/p&gt;</content><category term="ssl"></category><category term="tls"></category><category term="java"></category><category term="certificat"></category><category term="signature"></category><category term="sÃ©curitÃ©"></category></entry><entry><title>Qu'est-ce qui me motive en tant que dÃ©veloppeur ?</title><link href="https://www.dericbourg.net/2015/02/16/quest-ce-qui-me-motive-en-tant-que-developpeur/" rel="alternate"></link><published>2015-02-16T00:00:00+01:00</published><updated>2015-02-16T00:00:00+01:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2015-02-16:/2015/02/16/quest-ce-qui-me-motive-en-tant-que-developpeur/</id><summary type="html">&lt;p&gt;Je suis dÃ©veloppeur. Je travaille pour l'ESN MaBoite et suis en mission depuis plusieurs mois chez MonClient. Il est 9h40, j'arrive chez MonClient en retard, dÃ©jÃ  fatiguÃ©. Sans avoir fait la fÃªte la veille, j'ai pourtant eu du mal Ã  me lever ce matin, je n'avais pas envie.&lt;/p&gt;
&lt;p&gt;GÃ©rard passe â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;Je suis dÃ©veloppeur. Je travaille pour l'ESN MaBoite et suis en mission depuis plusieurs mois chez MonClient. Il est 9h40, j'arrive chez MonClient en retard, dÃ©jÃ  fatiguÃ©. Sans avoir fait la fÃªte la veille, j'ai pourtant eu du mal Ã  me lever ce matin, je n'avais pas envie.&lt;/p&gt;
&lt;p&gt;GÃ©rard passe Ã  cÃ´tÃ© de moi sans mÃªme me regarder. JÃ©rÃ´me vient me demander d'implÃ©menter une fonctionnalitÃ© en urgence. Je ne comprends pas l'objectif de sa demande et lui demande des prÃ©cisions : Â« Ce n'est pas important, me rÃ©pond-il, c'est pour les gogols du pÃ´le mÃ©tier qui ne comprennent rien Ã  ce qu'ils font, comme d'habitude Â». Lorsque j'envisage de leur demander directement les dÃ©tails nÃ©cessaires, il me coupe : la fonctionnalitÃ© ne servira jamais, autant la rÃ©aliser comme ils l'imaginent, cela nous fera gagner du temps. S'il est sÃ»r de lui, allons-y.&lt;/p&gt;
&lt;p&gt;Avant de m'y mettre, je constate que les tests unitaires du module que j'ai rÃ©alisÃ© la semaine derniÃ¨re ne passent plus. GÃ©rard Ã©tant Ã  l'origine de la modification, je vais le voir. Â« Oui, j'ai repris des trucs, Ã§a ne me plaisait pas et je voulais que Ã§a marche Â», m'explique-t-il. Je repars avec l'injonction de remettre les tests d'aplomb en fonction de ce qu'il a Ã©crit.&lt;/p&gt;
&lt;p&gt;La journÃ©e passe, il est 18h. Au cours de la journÃ©e, je n'ai Ã©crit que quelques lignes de code dont je ne suis pas satisfait. Je vois bien qu'il y a des choses Ã  reprendre, que Ã§a pourrait Ãªtre plus Â« propre Â» mais j'ai du mal Ã  identifier comment mieux faire. Je n'ai de toute faÃ§on pas l'Ã©nergie de m'y pencher. Qu'est-ce qui rend le travail si laborieux ? Pourquoi ma motivation est-elle si basse ?&lt;/p&gt;
&lt;h2&gt;Besoin de sens&lt;/h2&gt;
&lt;p&gt;Le sens est un composant indispensable de la motivation. Pour quoi (en deux mots) suis-je ici ? Quel est mon objectif ? Quel est l'objectif de ma mission ? Le sens peut Ãªtre vu suivant trois dimensions :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;le sens-sensation, qui nous ancre dans le rÃ©el ;&lt;/li&gt;
&lt;li&gt;le sens-direction, le cap Ã  suivre ;&lt;/li&gt;
&lt;li&gt;le sens-signification qui, sans direction, devient une idÃ©ologie â€“ pensez Ã  des choses qui vous ont Ã©tÃ© imposÃ©es mais (du moins au premier contact) jamais justifiÃ©es : les tests unitaires, l'injection de dÃ©pendancesâ€¦ autant de choses, qui, prÃ©sentÃ©es de faÃ§on dogmatique, resteront perÃ§ues comme des obligations empiriques.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On peut lui poser comme conditions deux prÃ©-requis (Jacques Lecomte) : le lien et la loi. L'Ã©quilibre des deux va engendrer de la cohÃ©rence et donner du sens.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Triangle de la rÃ©silience" class="center" src="/images/2015-02-18-Quest_ce_qui_me_motive_en_tant_que_developpeur/triangle_resilience.png"&gt;&lt;/p&gt;
&lt;p&gt;Le lien est en partie de ma responsabilitÃ© : un lien de qualitÃ© dÃ©pend directement de mon savoir-Ãªtre. Dans un cadre professionnel, on peut dÃ©crire (de faÃ§on non exhaustive) mon savoir-Ãªtre par :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ma connaissance de mes besoins ;&lt;/li&gt;
&lt;li&gt;ma capacitÃ© Ã  les communiquer sereinement ;&lt;/li&gt;
&lt;li&gt;ma capacitÃ© Ã  entendre et Ã  me remettre en question (honnÃªtetÃ© intellectuelle) ;&lt;/li&gt;
&lt;li&gt;ma capacitÃ© Ã  reconnaÃ®tre humblement mes erreurs ;&lt;/li&gt;
&lt;li&gt;ma capacitÃ© Ã  accepter de ne pas Ãªtre parfait et que l'autre n'est pas non plus parfait ;&lt;/li&gt;
&lt;li&gt;ma conscience du fait que je ne suis pas ce que je fais et que l'autre n'est pas ce qu'il fait.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Le lien de qualitÃ©, lui, se reconnaÃ®t Ã  :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;la convivialitÃ© des Ã©changes ;&lt;/li&gt;
&lt;li&gt;mon sentiment d'appartenance au groupe (Ã  l'Ã©quipe, Ã  l'entrepriseâ€¦) ;&lt;/li&gt;
&lt;li&gt;la reconnaissance de mes pairs ;&lt;/li&gt;
&lt;li&gt;mon sentiment d'Ãªtre lÃ©gitime, respectÃ© et Ã  ma place.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Une fois crÃ©Ã©, ce lien m'assure un sentiment de sÃ©curitÃ© parce que je suis en confiance. Un tel sentiment encourage l'initiative et va m'aider Ã  crÃ©er d'autres liens. En proposant du lien Ã  l'autre, je lui permets de se sentir accueilli et pris en compte (cela participe Ã  crÃ©er un cercle vertueux).&lt;/p&gt;
&lt;p&gt;Revenons Ã  mon exemple. J'ai fait de mon mieux pour crÃ©er du lien avec GÃ©rard â€“ qui est mon interlocuteur privilÃ©giÃ© chez MonClient â€“ et pour lui montrer que je le respecte : je l'inclus dans les dÃ©parts Ã  la machine Ã  cafÃ©, je lui pose des questions ouvertes pour le faire parler de lui, je lui demande son avis au moment de choix techniques importants. Pourtant, GÃ©rard ne dit toujours pas bonjour le matin, ne me regarde pas et Ã©lude ou chasse mes questions liÃ©es au projet.&lt;/p&gt;
&lt;p&gt;MÃªme avec toute la bonne volontÃ© du monde, il m'est parfois difficile de crÃ©er ou de maintenir ce lien : je ne suis jamais Ã  l'abri d'une remarque blessante (mÃªme involontaire) ou de tomber sur un interlocuteur rÃ©ticent. En cas de difficultÃ©, je sais pourtant  qu'il ne sert Ã  rien de Â« bouder Â» en Ã©vitant du jour au lendemain le rituel du cafÃ© matinal par exemple. C'est nÃ©anmoins un instinct de survie naturel mÃªme si, au fond de moi, ce n'est pas ce que je dÃ©sire.&lt;/p&gt;
&lt;p&gt;Dans ce contexte, qui remarquera que j'arrive une demi-heure plus tard le matin ? Pourquoi m'ennuyer Ã  me lever tÃ´t et Ã  me dÃ©pÃªcher, moi qui ne suis pas du matin, qui plus est pour travailler sur un projet dont je ne comprends pas l'objectif ? Si GÃ©rard n'est pas disposÃ© Ã  Ã©tablir un lien ni avec moi ni avec les autres, je ne peux rien faire. Je vais, finalement, me dÃ©sinvestir progressivement de la vie d'Ã©quipe jusqu'au jour oÃ¹ j'arriverai Ã  midi et oÃ¹ personne ne me demandera oÃ¹ j'Ã©tais.&lt;/p&gt;
&lt;p&gt;Ma responsabilitÃ© lÃ -dedans ? Admettre mes difficultÃ©s et demander de l'aide.&lt;/p&gt;
&lt;p&gt;Le sens va aussi Ãªtre soutenu par la loi (ici synonyme de jalons ou de cadre) : la poursuite d'un objectif mÃ¨ne Ã  se donner des rÃ¨gles de conduite mais surtout Ã  adhÃ©rer Ã  un cadre (au sein d'une entreprise, d'une Ã©quipe, d'un projet), de s'en sentir acteur et de ne pas le subir. Il est nÃ©cessaire de comprendre le cadre pour se l'approprier : comment se prennent les dÃ©cisions ? Comment suis-je consultÃ© ou informÃ© lors de la reconduction ou non de ma mission ? C'est aussi de cette faÃ§on que la confiance et le sentiment de sÃ©curitÃ© se construisent.&lt;/p&gt;
&lt;p&gt;Quand la loi devient obsolÃ¨te ou qu'un dÃ©saccord s'installe, quand il faut remettre la loi en question, le lien de qualitÃ© permet une plus grande libertÃ© dans l'Ã©change. Quand je suis en rÃ©union avec GÃ©rard, je suis trÃ¨s mal Ã  l'aise pour le contredire ou pour remettre en question les idÃ©es que je n'approuve pas.&lt;/p&gt;
&lt;p&gt;Si la loi est cohÃ©rente, si le lien est de qualitÃ©, l'environnement est serein et constructif.&lt;/p&gt;
&lt;h2&gt;Besoin de paix&lt;/h2&gt;
&lt;p&gt;MaBoite est Ã  l'origine de la paix durable que je vis au quotidien chez MonClient ainsi que son garde fou : c'est elle qui cadre mon travail par l'intermÃ©diaire du contrat Ã©tabli avec MonClient ; c'est ce que je me dois de respecter, mais c'est aussi ce qui me protÃ¨ge.&lt;/p&gt;
&lt;p&gt;Le chercheur Markus Weingardt a Ã©tudiÃ© les conditions nÃ©cessaires Ã  l'instauration de la paix durable. Le Â« vivre ensemble Â» tel qu'il le dÃ©crit dÃ©finit trois composantes qui permettent d'atteindre cette paix durable :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;la transparence (qui permet la confiance) ;&lt;/li&gt;
&lt;li&gt;la compÃ©tence ;&lt;/li&gt;
&lt;li&gt;la proximitÃ© (le lien).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="Triangle de la paix durable" class="center" src="/images/2015-02-18-Quest_ce_qui_me_motive_en_tant_que_developpeur/triangle_paix_durable.png"&gt;&lt;/p&gt;
&lt;p&gt;Tout comme avec mes collÃ¨gues du quotidien chez MonClient, un lien de qualitÃ© avec MaBoite (son image, ses salariÃ©s, sa direction) est Ã©galement nÃ©cessaire Ã  l'Ã©quilibre. Une ESN Â« classique Â» n'est pas un environnement propice Ã  la proximitÃ© : les consultants sont Â« Ã©clatÃ©s Â» chacun chez un client diffÃ©rent ou sur des missions diffÃ©rentes, ce qui peut entraÃ®ner un manque de lien. NÃ©anmoins, cet Ã©loignement peut Ãªtre compensÃ© : coding dojos, soirÃ©es d'Ã©quipeâ€¦&lt;/p&gt;
&lt;p&gt;Une vigilance toute particuliÃ¨re est Ã  apporter aux outils de communication numÃ©rique (e-mail, messagerie instantanÃ©e, rÃ©seau social d'entrepriseâ€¦). Ceux-ci ne permettent d'Ã©changer que des mots : on Â« perd Â» tout le pan non-verbal de la communication (gestuelle, attitude, mimiquesâ€¦) mais aussi le ton de la voix. Ceux-ci reprÃ©sentant la plupart du temps la proportion la plus importante de la communication, leur absence crÃ©e un grand risque de quiproquos ou d'incomprÃ©hensions qui peuvent se rÃ©vÃ©ler dÃ©vastateurs.&lt;/p&gt;
&lt;p&gt;La transparence apporte honnÃªtetÃ© et clartÃ© dans les Ã©changes : Â« Plus j'en sais, mÃªme quand Ã§a va mal, plus je fais confiance Ã  l'autre Â». LÃ  aussi il s'agit du sentiment de sÃ©curitÃ© : si on ne me cache rien, c'est que je suis digne de confiance, que je suis considÃ©rÃ© comme un collaborateur et pas seulement comme un produit.
Ã€ l'inverse, le manque de transparence Ã©mousse la confiance. Comment sont attribuÃ©es les primes ou les augmentations ? Pourquoi la direction n'apporte-t-elle pas de rÃ©ponse Ã  certaines questions ? Comment avoir confiance en une direction qui semble nous cacher des choses ?
La rÃ©ciproque est Ã©galement applicable : je suis moi-mÃªme transparent pour gagner la confiance de ma direction et de mes collÃ¨gues. Pourquoi Â« cacher Â» mon code et attendre une semaine avant de le partager ? Aurais-je du mal Ã  assumer que je ne suis pas parfait ?&lt;/p&gt;
&lt;p&gt;En tant que prestataire, ce sont avant tout mes compÃ©tences que mes clients recherchent. Si le client a recours Ã  un consultant, c'est que ce dernier a une compÃ©tence que le client n'a pas. Pourtant, GÃ©rard lance Ã  la machine Ã  cafÃ© : Â« Tous les prestas qu'on prend sont mauvais mais comme on n'a pas les moyens de payer plus cher pour en avoir des bons, on n'a pas le choix, on prend les mauvais Â». Une telle remarque traduit un manque de confiance de sa part envers les prestataires â€“ dont moi â€“ et entame ma propre confiance en moi.&lt;/p&gt;
&lt;p&gt;De faÃ§on gÃ©nÃ©rale, nos compÃ©tences sont interdÃ©pendantes :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;elles entretiennent le sentiment d'appartenance entre les dÃ©veloppeurs â€“ je serais plus fier de travailler avec des gens dont je reconnais les compÃ©tences ;&lt;/li&gt;
&lt;li&gt;les commerciaux compÃ©tents trouvent des clients et des missions intÃ©ressantes ;&lt;/li&gt;
&lt;li&gt;la compÃ©tence des dÃ©veloppeurs aide les commerciaux Ã  dÃ©marcher les clients ;&lt;/li&gt;
&lt;li&gt;un service RH compÃ©tent aide Ã  entretenir la motivation des salariÃ©s ;&lt;/li&gt;
&lt;li&gt;des salariÃ©s motivÃ©s et avec un fort sentiment d'appartenance aident au recrutement en diffusant une bonne image ;&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Mais encore faut-il qu'elles soient reconnues Ã  leur juste place.&lt;/p&gt;
&lt;h2&gt;Besoin d'autonomie et de reconnaissance&lt;/h2&gt;
&lt;p&gt;Pour que ses salariÃ©s se sentent reconnus, l'employeur a notamment la responsabilitÃ© de leur permettre d'Ãªtre autonomes. On est autonome lorsque l'on est en mesure de se dÃ©brouiller seul sans craindre de perdre son identitÃ© lorsque l'on demande de l'aide.&lt;/p&gt;
&lt;p&gt;Vincent Lenhardt structure l'autonomie autour de quatre niveaux dÃ©crits par le schÃ©ma qui suit.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Structure de l'autonomie en quatre niveaux selon Vincent Lenhardt" class="center" src="/images/2015-02-18-Quest_ce_qui_me_motive_en_tant_que_developpeur/autonomie.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;En situation de dÃ©pendance, on dit Â« oui Â» Ã  tout. On est incapable de prendre une dÃ©cision et on s'identifie Ã  la relation avec l'autre (un collÃ¨gue ou MaBoÃ®te).&lt;/li&gt;
&lt;li&gt;Progressivement, on se rebelle, on apprend Ã  dire Â« non Â» Ã  l'autre, on l'accuse : on est alors en situation de contre-dÃ©pendance.&lt;/li&gt;
&lt;li&gt;Ã€ l'Ã©tape suivante, on ne demande plus rien Ã  l'autre, on se centre sur soi-mÃªme et on n'accepte plus qu'une seule contrainte : celle de MonClient.&lt;/li&gt;
&lt;li&gt;Enfin, on peut atteindre une situation d'Ã©quilibre dans laquelle on sait se dÃ©brouiller seul ou en groupe. On ne s'identifie pas Ã  la relation : il y a Â« soi Â», Â« l'autre Â» et Â« la relation entre l'autre et soi Â». On est alors en mesure d'accepter la contrainte et de prendre en charge une autre personne.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;L'autonomie permet d'accÃ©der au sens de son travail.&lt;/p&gt;
&lt;h2&gt;Comme un humain&lt;/h2&gt;
&lt;p&gt;Si les composantes de la paix durable sont solides et Ã©quilibrÃ©es, le cadre est suffisamment sÃ©curisant pour que, associÃ© aux liens que je trouve en mission chez MonClient aussi bien que dans MaBoite, j'y trouve du sens.&lt;/p&gt;
&lt;p&gt;Si mon employeur prend ses responsabilitÃ©s pour crÃ©er un cadre sÃ©curisant en tant que garant de la loi (cf. triangle de la rÃ©silience), associÃ© au lien de qualitÃ©, je trouve le sens qui me donne envie de me lever le matin.&lt;/p&gt;
&lt;p&gt;Â« Ce dont l'humain a besoin, ce n'est pas de vivre sans tension mais bien de tendre vers un but valable, de rÃ©aliser une mission librement choisie. Il a besoin non de se libÃ©rer de sa tension, mais plutÃ´t de se sentir appelÃ© Ã  accomplir quelque chose Â» (Viktor E. Frankl, DÃ©couvrir un sens Ã  sa vie avec la logothÃ©rapie, 1959, Ã©dition J'ai lu, p. 129).&lt;/p&gt;
&lt;p&gt;Finalement, j'ai besoin de la mÃªme chose que tout Ãªtre humain, ce n'est pas spÃ©cifique au mÃ©tier de dÃ©veloppeur : ce qui me motive en tant que dÃ©veloppeur, c'est ce qui me motive tout court.&lt;/p&gt;</content><category term="quotidien"></category><category term="vivre ensemble"></category><category term="motivation"></category><category term="bien-Ãªtre"></category></entry><entry><title>Shell shock : un obus dans les dents de bash</title><link href="https://www.dericbourg.net/2014/09/26/shell-shock-un-obus-dans-les-dents-de-bash/" rel="alternate"></link><published>2014-09-26T00:00:00+02:00</published><updated>2014-09-26T00:00:00+02:00</updated><author><name>Alban Dericbourg</name></author><id>tag:www.dericbourg.net,2014-09-26:/2014/09/26/shell-shock-un-obus-dans-les-dents-de-bash/</id><summary type="html">&lt;p&gt;Vous avez probablement entendu parler de Shell shock qui, outre l'association de troubles psychiques et physiques observÃ©s chez &lt;a href="http://fr.wikipedia.org/wiki/Obusite"&gt;certains soldats de la PremiÃ¨re Guerre Mondiale&lt;/a&gt;, dÃ©signe Ã©galement la vulnÃ©rabilitÃ© &lt;a href="http://www.cert.ssi.gouv.fr/site/CERTFR-2014-ALE-006/index.html"&gt;CVE-2014-6271&lt;/a&gt; touchant GNU bash. Elle permet Ã  un attaquant de provoquer une exÃ©cution de code arbitraire Ã  distance.&lt;/p&gt;
&lt;h2&gt;Mon dieu, mais â€¦&lt;/h2&gt;</summary><content type="html">&lt;p&gt;Vous avez probablement entendu parler de Shell shock qui, outre l'association de troubles psychiques et physiques observÃ©s chez &lt;a href="http://fr.wikipedia.org/wiki/Obusite"&gt;certains soldats de la PremiÃ¨re Guerre Mondiale&lt;/a&gt;, dÃ©signe Ã©galement la vulnÃ©rabilitÃ© &lt;a href="http://www.cert.ssi.gouv.fr/site/CERTFR-2014-ALE-006/index.html"&gt;CVE-2014-6271&lt;/a&gt; touchant GNU bash. Elle permet Ã  un attaquant de provoquer une exÃ©cution de code arbitraire Ã  distance.&lt;/p&gt;
&lt;h2&gt;Mon dieu, mais c'est horrible !&lt;/h2&gt;
&lt;p&gt;Il faut avouer que Ã§a ne prÃ©sage pas d'une franche partie de rigolade.&lt;/p&gt;
&lt;p&gt;Tout d'abord, de nombreux programmes interagissent avec le shell. Nous savons que ce n'est gÃ©nÃ©ralement pas une bonne idÃ©e mais cela nous simplifie parfois grandement la tÃ¢che (on dit souvent qu'un bon dÃ©veloppeur est un dÃ©veloppeur fainÃ©ant). La surface d'attaque est donc trÃ¨s Ã©tendue.&lt;/p&gt;
&lt;p&gt;Par ailleurs, si les systÃ¨mes Â« Ã©vidents Â» seront patchÃ©s (un serveur web par exemple), certaines machines plus obscures ne le seront pas : pensez par exemple Ã  des pÃ©riphÃ©riques tels que les camÃ©ras connectÃ©es (ou plus largement tout ce que vous pouvez trouver sur l'Internet des objets). Rien n'exclut qu'elles exposent des services basÃ©s sur des scripts shell et si ce shell est bash, le pÃ©riphÃ©rique devient vulnÃ©rable. Comme il y a fort Ã  parier qu'aucune procÃ©dure de mise Ã  jour de ces pÃ©riphÃ©riques n'ait Ã©tÃ© dÃ©finie, ces pÃ©riphÃ©rques resteront vulnÃ©rables ad vitam aeternam.&lt;/p&gt;
&lt;h2&gt;J'exige des explications&lt;/h2&gt;
&lt;p&gt;Bash permet d'exporter des variables mais aussi des fonctions Ã  destination d'autres instances de bash. L'export de fonction utilise une variable d'environnement portant le nom de la-dite fonction dont la valeur commence par &lt;code&gt;() {&lt;/code&gt; :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;foo&lt;/span&gt;&lt;span class="o"&gt;=()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    du code
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ã€ l'import, il se contente aveuglÃ©ment d'interprÃ©ter cela en remplaÃ§ant le signe Â« = Â» par une espace. C'est ainsi que bash ne se limite pas Ã  interprÃ©ter le corps de la fonction mais qu'il poursuit le parsing et exÃ©cute les commandes qui suivent la dÃ©finition de la fonction. Par exemple, dÃ©finir une variable d'environnement de cette sorte :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;FOO&lt;/span&gt;&lt;span class="o"&gt;=()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; ignored&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; /bin/yolo
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;exÃ©cutera &lt;code&gt;/bin/yolo&lt;/code&gt; quand l'environnement sera importÃ© par bash.&lt;/p&gt;
&lt;p&gt;Ainsi, tout systÃ¨me utilisant bash est vulnÃ©rable, mais il est particuliÃ¨rement vulnÃ©rable :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;s'il expose un service sur le rÃ©seau (a fortiori sur Internet) ;&lt;/li&gt;
&lt;li&gt;que ce service exploite des paramÃ¨tres passÃ©s par le client et qu'il les stocke dans une variable d'environnement ;&lt;/li&gt;
&lt;li&gt;et que ce service lance bash pour un traitement quelconque.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Pour savoir si votre machine est vulnÃ©rable, vous pouvez lancer :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;env &lt;span class="nv"&gt;VAR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;() { 0; }; echo danger&amp;#39;&lt;/span&gt; bash -c &lt;span class="s2"&gt;&amp;quot;echo bonjour&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Si tout va bien, vous devriez observer ceci :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ env &lt;span class="nv"&gt;VAR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;() { 0; }; echo danger&amp;#39;&lt;/span&gt; bash -c &lt;span class="s2"&gt;&amp;quot;echo bonjour&amp;quot;&lt;/span&gt;
bash: warning: VAR: ignoring &lt;span class="k"&gt;function&lt;/span&gt; definition attempt
bash: error importing &lt;span class="k"&gt;function&lt;/span&gt; definition &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="sb"&gt;`&lt;/span&gt;VAR&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;
bonjour
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Si tout ne va pas bien, vous observerez :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ env &lt;span class="nv"&gt;VAR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;() { 0; }; echo danger&amp;#39;&lt;/span&gt; bash -c &lt;span class="s2"&gt;&amp;quot;echo bonjour&amp;quot;&lt;/span&gt;
danger
bonjour
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ã€ noter que Linux n'est pas le seul systÃ¨me touchÃ©. Tous les systÃ¨mes Unix (ce qui inclut Mac OS) sont concernÃ©s.&lt;/p&gt;
&lt;h2&gt;M'enfin, qui serait assez bÃªte pour exposer un machin bash sur Internet ?&lt;/h2&gt;
&lt;p&gt;Moi â€“ et probablement vous aussi â€“ mais je ne pense pas que ce soit de la bÃªtise.&lt;/p&gt;
&lt;p&gt;Pour l'instant, le vecteur de propagation semble Ãªtre la requÃªte HTTP Ã  destination d'un script CGI. Le serveur web &lt;em&gt;Apache httpd&lt;/em&gt; utilise par exemple des scripts (donc potentiellement bash) pour certaines fonctions C, Python ou PHP (si ce dernier est lancÃ© en mode CGI). C'est ainsi que quelques robots parcourent en ce moment mÃªme le web en positionnant leur en-tÃªte &lt;em&gt;User-Agent&lt;/em&gt; comme suit afin de dresser leur annuaire des machines vulnÃ©rables : &lt;code&gt;User-Agent: () { :; } /bin/ping -c x.y.z.q&lt;/code&gt;. Si vous souhaitez vÃ©rifier vos logs HTTP, vous pouvez lancer &lt;code&gt;egrep '\(\ *\)\ *\{' /var/log/nginx/*&lt;/code&gt; par exemple.&lt;/p&gt;
&lt;p&gt;Ce n'est donc pas si rare et c'est sans compter les applications largement dÃ©ployÃ©es qui utilisent CGI (cPanel par exemple).&lt;/p&gt;
&lt;p&gt;Enfin â€“ et plus localement, certains clients DHCP utilisent Ã©galement des scripts pour configurer le systÃ¨me. Si le serveur est corrompu (ou mal intentionnÃ©), cela permet d'exÃ©cuter des commandes â€“ vraisemblablement en &lt;em&gt;root&lt;/em&gt; â€“ sur la machine cliente.
Il ne peut plus rien nous arriver d'affreux maintenant&lt;/p&gt;
&lt;p&gt;Une fois le patch passÃ©, vous devriez dÃ©jÃ  Ãªtre plus sereins. NÃ©anmoins, &lt;a href="https://securityblog.redhat.com/2014/09/24/bash-specially-crafted-environment-variables-code-injection-attack/"&gt;comme l'indique RedHat&lt;/a&gt;, le patch fourni laisse quelques trous dans la raquette. Il est notamment possible, sous certaines conditions, d'exÃ©cuter du code contenu dans des variables d'environnement (CVE-2014-7169). Reste Ã  attendre le patch du patch.&lt;/p&gt;
&lt;p&gt;Pour tester votre vulnÃ©rabilitÃ© Ã  &lt;a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7169"&gt;CVE-2014-7169&lt;/a&gt;, vous pouvez lancer :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;env &lt;span class="nv"&gt;X&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;() { (a)=&amp;gt;\&amp;#39;&lt;/span&gt; sh -c &lt;span class="s2"&gt;&amp;quot;echo date&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; cat &lt;span class="nb"&gt;echo&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Si vous obtenez la date, votre systÃ¨me est vulnÃ©rable.&lt;/p&gt;
&lt;p&gt;Ã€ suivre, donc.&lt;/p&gt;</content><category term="bash"></category><category term="sÃ©curitÃ©"></category><category term="cve"></category></entry></feed>